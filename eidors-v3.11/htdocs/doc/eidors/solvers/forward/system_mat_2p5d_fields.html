<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of system_mat_2p5d_fields</title>
  <meta name="keywords" content="system_mat_2p5d_fields">
  <meta name="description" content="SYSTEM_MAT_2P5D_FIELDS: fields (elem to nodes) fraction of system mat">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="../index.html">solvers</a> &gt; <a href="index.html">forward</a> &gt; system_mat_2p5d_fields.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/solvers/forward&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>system_mat_2p5d_fields
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SYSTEM_MAT_2P5D_FIELDS: fields (elem to nodes) fraction of system mat</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function FT= system_mat_2p5d_fields( fwd_model ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SYSTEM_MAT_2P5D_FIELDS: fields (elem to nodes) fraction of system mat
 FC= system_mat_fields( fwd_model )
 input: 
   fwd_model = forward model
 output:
   FT:        s_mat = C' * T * conduct * C = FT' * conduct * FT;
   where FC'*S*FC + k^2*FT'*S*FT, with k=real#, forms part of the Fourier integral</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/mk_geophysics_model.html" class="code" title="function imdl = mk_geophysics_model(str, ne, opt);">mk_geophysics_model</a>	imdl = mk_geophysics_model(str, ne, [option])</li><li><a href="../../../eidors/models/private/spdiag.html" class="code" title="function S = spdiag(V,K)">spdiag</a>	SPDIAG Sparse diagonal matrices and diagonals of a matrix.</li><li><a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../../eidors/overloads/spdiag.html" class="code" title="function S = spdiag(V,K)">spdiag</a>	SPDIAG Sparse diagonal matrices and diagonals of a matrix.</li><li><a href="fwd_model_parameters.html" class="code" title="function param = fwd_model_parameters( fwd_model, opt )">fwd_model_parameters</a>	FWD_MODEL_PARAMETERS: data= fwd_solve_1st_order( fwd_model, image)</li><li><a href="system_mat_2p5d_fields.html" class="code" title="function FT= system_mat_2p5d_fields( fwd_model )">system_mat_2p5d_fields</a>	SYSTEM_MAT_2P5D_FIELDS: fields (elem to nodes) fraction of system mat</li><li><a href="system_mat_fields.html" class="code" title="function FC= system_mat_fields( fwd_model )">system_mat_fields</a>	SYSTEM_MAT_FIELDS: fields (elem to nodes) fraction of system mat</li><li><a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="jacobian_adjoint_2p5d_1st_order.html" class="code" title="function J= jacobian_adjoint_2p5d_1st_order( fwd_model, img)">jacobian_adjoint_2p5d_1st_order</a>	JACOBIAN_ADJOINT_2P5D: J= jacobian_adjoint_2p5d_1st_order( img )</li><li><a href="system_mat_2p5d_1st_order.html" class="code" title="function s_mat= system_mat_2p5d_1st_order( fwd_model, img)">system_mat_2p5d_1st_order</a>	SYSTEM_MAT_2P5D_1ST_ORDER: 2.5D system matrix</li><li><a href="system_mat_2p5d_fields.html" class="code" title="function FT= system_mat_2p5d_fields( fwd_model )">system_mat_2p5d_fields</a>	SYSTEM_MAT_2P5D_FIELDS: fields (elem to nodes) fraction of system mat</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function cache_obj = mk_cache_obj(fwd_model)</a></li><li><a href="#_sub2" class="code">function FT = calc_system_mat_2p5d_fields( fwd_model )</a></li><li><a href="#_sub3" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function FT= system_mat_2p5d_fields( fwd_model )</a>
0002 <span class="comment">% SYSTEM_MAT_2P5D_FIELDS: fields (elem to nodes) fraction of system mat</span>
0003 <span class="comment">% FC= system_mat_fields( fwd_model )</span>
0004 <span class="comment">% input:</span>
0005 <span class="comment">%   fwd_model = forward model</span>
0006 <span class="comment">% output:</span>
0007 <span class="comment">%   FT:        s_mat = C' * T * conduct * C = FT' * conduct * FT;</span>
0008 <span class="comment">%   where FC'*S*FC + k^2*FT'*S*FT, with k=real#, forms part of the Fourier integral</span>
0009 
0010 <span class="comment">% (C) 2008, 2015, 2016 Andy Adler, Alistair Boyle. License: GPL version 2 or version 3</span>
0011 <span class="comment">% $Id: system_mat_2p5d_fields.m 5424 2017-04-25 17:45:19Z aadler $</span>
0012 
0013 <span class="keyword">if</span> ischar(fwd_model) &amp;&amp; strcmp(fwd_model,<span class="string">'UNIT_TEST'</span>); <a href="#_sub3" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0014 
0015 copt.cache_obj = <a href="#_sub1" class="code" title="subfunction cache_obj = mk_cache_obj(fwd_model)">mk_cache_obj</a>(fwd_model);
0016 copt.fstr = <span class="string">'system_mat_2p5d_fields'</span>;
0017 copt.log_level = 4;
0018 FT = <a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub2" class="code" title="subfunction FT = calc_system_mat_2p5d_fields( fwd_model )">calc_system_mat_2p5d_fields</a>,{fwd_model},copt );
0019 
0020 <span class="comment">% only cache stuff which is really relevant here</span>
0021 <a name="_sub1" href="#_subfunctions" class="code">function cache_obj = mk_cache_obj(fwd_model)</a>
0022    cache_obj.elems       = fwd_model.elems;
0023    cache_obj.nodes       = fwd_model.nodes;
0024    <span class="keyword">try</span>
0025    cache_obj.electrode   = fwd_model.electrode; <span class="comment">% if we have it</span>
0026    <span class="keyword">end</span>
0027    cache_obj.type        = <span class="string">'fwd_model'</span>;
0028    cache_obj.name        = <span class="string">''</span>; <span class="comment">% it has to have one</span>
0029 
0030 <a name="_sub2" href="#_subfunctions" class="code">function FT = calc_system_mat_2p5d_fields( fwd_model )</a>
0031    p= <a href="fwd_model_parameters.html" class="code" title="function param = fwd_model_parameters( fwd_model, opt )">fwd_model_parameters</a>( fwd_model, <span class="string">'skip_VOLUME'</span> );
0032    d0= p.n_dims+0;
0033    d1= p.n_dims+1;
0034    e= p.n_elem;
0035    n= p.n_node;
0036    assert(d0 == 2, <span class="string">'only supports 2D meshes for 2.5D system matrices'</span>);
0037 
0038    dfact = (d0-1)*d0;
0039    SSe2 = sqrtm((ones(3) + eye(3)) / 12);
0040    area=zeros(e,1);
0041    <span class="keyword">for</span> j=1:e
0042       a = inv([ ones(d1,1), p.NODE( :, p.ELEM(:,j) )' ]);
0043       area(j) = 1 / sqrt(dfact*abs(det(a)));
0044    <span class="keyword">end</span> <span class="comment">%for j=1:ELEMs</span>
0045 
0046    <span class="comment">% NOTE: CEM electrodes are taken care of by the system_mat_fields produced</span>
0047    <span class="comment">% FC matrix where we sum FC'*S*FC + k^2*FT'*S*FT for 2.5D solutions, so we</span>
0048    <span class="comment">% just need to have the correctly sized FT matrix, so that the FC and FT</span>
0049    <span class="comment">% products may be added directly</span>
0050    n_cem = 0; <span class="comment">% count CEM electrodes, add 1 column &amp; row per CEM (all zeros)</span>
0051    <span class="keyword">for</span> i=1:length(fwd_model.electrode)
0052       n_cem = n_cem + (length(fwd_model.electrode(i).nodes) &gt; 1);
0053    <span class="keyword">end</span>
0054    [FFiidx,FFjidx,FFdata] = find(kron(<a href="../../../eidors/models/private/spdiag.html" class="code" title="function S = spdiag(V,K)">spdiag</a>(area),SSe2));
0055    FF= <a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(FFiidx(:), FFjidx(:), FFdata(:));
0056    CC= <a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>((1:d1*e)', p.ELEM(:), ones(d1*e,1), d1*e, n+n_cem);
0057 
0058    FT= FF*CC;
0059 
0060 <a name="_sub3" href="#_subfunctions" class="code">function do_unit_test</a>
0061    imdl=  <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c2'</span>,16);
0062    FT = <a href="system_mat_2p5d_fields.html" class="code" title="function FT= system_mat_2p5d_fields( fwd_model )">system_mat_2p5d_fields</a>( imdl.fwd_model);
0063    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'sys_mat1 pem'</span>, size(FT), [192,41]);
0064    ss = 58.787753826797278;
0065    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'sys_mat2 pem'</span>, FT(1:2,:), [[4,1,1,0;1,4,1,0], zeros(2,37)]/ss, 1e-14);
0066 
0067    imdl=  <a href="../../../eidors/models/mk_geophysics_model.html" class="code" title="function imdl = mk_geophysics_model(str, ne, opt);">mk_geophysics_model</a>(<span class="string">'h2a'</span>, 16);
0068    FC = <a href="system_mat_fields.html" class="code" title="function FC= system_mat_fields( fwd_model )">system_mat_fields</a>( imdl.fwd_model);
0069    FT = <a href="system_mat_2p5d_fields.html" class="code" title="function FT= system_mat_2p5d_fields( fwd_model )">system_mat_2p5d_fields</a>( imdl.fwd_model);
0070    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'sys_mat1 cem'</span>, size(FT, 2), size(FC, 2));
0071    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'sys_mat2 cem'</span>, FT(:, end-15:end), FT(:, end-15:end)*0);</pre></div>
<hr><address>Generated on Fri 30-Dec-2022 20:46:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>