<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of show_fem_enhanced</title>
  <meta name="keywords" content="show_fem_enhanced">
  <meta name="description" content="SHOW_FEM_ENHANCED: show the EIDORS3D finite element model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="#">graphics</a> &gt; <a href="index.html">matlab</a> &gt; show_fem_enhanced.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/graphics/matlab&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>show_fem_enhanced
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function hh = show_fem_enhanced(mdl, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SHOW_FEM_ENHANCED: show the EIDORS3D finite element model
 hh = show_fem(mdl, options)
 mdl is an EIDORS3D 'model' or 'image' structure
 hh = handle to the plotted model

 SHOW_FEM_ENHANCED('refresh') repaints the figure in current axis orientation 
   (only works if options.edge.significant.viewpoint_dependent.callback 
   is true)

 options may be specified by a list (for compatibility purposes)

 options specifies a set of options
   options(1) =&gt; show colourbar
   options(2) =&gt; show numbering on electrodes
   options(3) =&gt; number elements (==1) or nodes (==2);

 for detailed control of colours, use the following fields (default values
 are indicated in parenthesis)

     options.viewpoint.az (-37.5)
     options.viewpoint.el (30.0)
 
     options.edge.color ([0 0 0])
     options.edge.width (0.5)
     options.edge.significant.show (true)
     options.edge.significant.color ([0 0 0])
     options.edge.significant.width (2)
     options.edge.significant.angle (45)
     options.edge.significant.viewpoint_dependent.show (true)
     options.edge.significant.viewpoint_dependent.color ([0 0 0])
     options.edge.significant.viewpoint_dependent.width (2)
     options.edge.significant.viewpoint_dependent.callback (true)
  
     options.colorbar.show (false)
 
     options.electrode.number.show (false)
     options.electrode.number.font_size (10)
     options.electrode.number.font_weight ('bold')
     options.electrode.number.color ([.6 0 0])
     options.electrode.number.background_color ('none')
     options.electrode.number.scale_position (1.15)
 
     options.element.number.show (false)
     options.element.number.font_size (7)
     options.element.number.font_weight ('normal')
     options.element.number.color ([0 0 0])
     options.element.number.background_color ('none')

     options.node.number.show (false)
     options.node.number.font_size (7)
     options.node.number.font_weight ('normal')
     options.node.number.color ([0 0 0.5])
     options.node.number.background_color ([1 1 1])

 EXAMPLES
   mdl = mk_common_model('c2C2',8);
   img = mk_image(mdl, linspace(-3,3,num_elems(mdl)));
   
 SET PARAMETERS
   img.show_fem.electrode.number.scale_position= 1.01;
   img.show_fem.electrode.number.show =1;
   show_fem(img)

 SET OPTIONS
   opts.colorbar.show = 1;
   show_fem(img.opts)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>	EIDORS_COLOURBAR - create an eidors colourbar with scaling to image</li><li><a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>	SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</li><li><a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>	NUM_NODES: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>	SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</li><li><a href="../../../eidors/meshing/netgen/ng_mk_geometric_models.html" class="code" title="function [fmdl, mat_idx] = ng_mk_geometric_models(body_geometry, electrode_geometry)">ng_mk_geometric_models</a>	NG_MK_GEOMETRIC_MODELS: create geometric mesh models using Netgen. Body</li><li><a href="../../../eidors/models/elec_rearrange.html" class="code" title="function [elec_idx, new_fmdl] = elec_rearrange( pattern, newarrange, fwd_model )">elec_rearrange</a>	ELEC_REARRANGE: rearrange electrodes for given pattern</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [img, mdl, opts] = proc_params(mdl, src_opts)</a></li><li><a href="#_sub2" class="code">function refresh_current_axis(obj, evd)</a></li><li><a href="#_sub3" class="code">function hh = draw_all(img, mdl, opts)</a></li><li><a href="#_sub4" class="code">function hh = draw_fem(img, mdl, opts)</a></li><li><a href="#_sub5" class="code">function hh = draw_numbers(positions, opts)</a></li><li><a href="#_sub6" class="code">function hh = draw_markers(points, colour, marker_size)</a></li><li><a href="#_sub7" class="code">function hh = draw_edges(edges, vertices, width_data, color_data)</a></li><li><a href="#_sub8" class="code">function hh = draw_triangles(faces, vertices, color_data, alpha_data,</a></li><li><a href="#_sub9" class="code">function colour = electr_colour(elec, e, colormap_width)</a></li><li><a href="#_sub10" class="code">function mdl = find_sub_elements(mdl)</a></li><li><a href="#_sub11" class="code">function dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)</a></li><li><a href="#_sub12" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function hh = show_fem_enhanced(mdl, options)</a>
0002 <span class="comment">% SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</span>
0003 <span class="comment">% hh = show_fem(mdl, options)</span>
0004 <span class="comment">% mdl is an EIDORS3D 'model' or 'image' structure</span>
0005 <span class="comment">% hh = handle to the plotted model</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% SHOW_FEM_ENHANCED('refresh') repaints the figure in current axis orientation</span>
0008 <span class="comment">%   (only works if options.edge.significant.viewpoint_dependent.callback</span>
0009 <span class="comment">%   is true)</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% options may be specified by a list (for compatibility purposes)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% options specifies a set of options</span>
0014 <span class="comment">%   options(1) =&gt; show colourbar</span>
0015 <span class="comment">%   options(2) =&gt; show numbering on electrodes</span>
0016 <span class="comment">%   options(3) =&gt; number elements (==1) or nodes (==2);</span>
0017 <span class="comment">%</span>
0018 <span class="comment">% for detailed control of colours, use the following fields (default values</span>
0019 <span class="comment">% are indicated in parenthesis)</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%     options.viewpoint.az (-37.5)</span>
0022 <span class="comment">%     options.viewpoint.el (30.0)</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%     options.edge.color ([0 0 0])</span>
0025 <span class="comment">%     options.edge.width (0.5)</span>
0026 <span class="comment">%     options.edge.significant.show (true)</span>
0027 <span class="comment">%     options.edge.significant.color ([0 0 0])</span>
0028 <span class="comment">%     options.edge.significant.width (2)</span>
0029 <span class="comment">%     options.edge.significant.angle (45)</span>
0030 <span class="comment">%     options.edge.significant.viewpoint_dependent.show (true)</span>
0031 <span class="comment">%     options.edge.significant.viewpoint_dependent.color ([0 0 0])</span>
0032 <span class="comment">%     options.edge.significant.viewpoint_dependent.width (2)</span>
0033 <span class="comment">%     options.edge.significant.viewpoint_dependent.callback (true)</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%     options.colorbar.show (false)</span>
0036 <span class="comment">%</span>
0037 <span class="comment">%     options.electrode.number.show (false)</span>
0038 <span class="comment">%     options.electrode.number.font_size (10)</span>
0039 <span class="comment">%     options.electrode.number.font_weight ('bold')</span>
0040 <span class="comment">%     options.electrode.number.color ([.6 0 0])</span>
0041 <span class="comment">%     options.electrode.number.background_color ('none')</span>
0042 <span class="comment">%     options.electrode.number.scale_position (1.15)</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%     options.element.number.show (false)</span>
0045 <span class="comment">%     options.element.number.font_size (7)</span>
0046 <span class="comment">%     options.element.number.font_weight ('normal')</span>
0047 <span class="comment">%     options.element.number.color ([0 0 0])</span>
0048 <span class="comment">%     options.element.number.background_color ('none')</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%     options.node.number.show (false)</span>
0051 <span class="comment">%     options.node.number.font_size (7)</span>
0052 <span class="comment">%     options.node.number.font_weight ('normal')</span>
0053 <span class="comment">%     options.node.number.color ([0 0 0.5])</span>
0054 <span class="comment">%     options.node.number.background_color ([1 1 1])</span>
0055 <span class="comment">%</span>
0056 <span class="comment">% EXAMPLES</span>
0057 <span class="comment">%   mdl = mk_common_model('c2C2',8);</span>
0058 <span class="comment">%   img = mk_image(mdl, linspace(-3,3,num_elems(mdl)));</span>
0059 <span class="comment">%</span>
0060 <span class="comment">% SET PARAMETERS</span>
0061 <span class="comment">%   img.show_fem.electrode.number.scale_position= 1.01;</span>
0062 <span class="comment">%   img.show_fem.electrode.number.show =1;</span>
0063 <span class="comment">%   show_fem(img)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% SET OPTIONS</span>
0066 <span class="comment">%   opts.colorbar.show = 1;</span>
0067 <span class="comment">%   show_fem(img.opts)</span>
0068 
0069 <span class="comment">% (C) 2015 Herve Gagnon. License: GPL version 2 or version 3</span>
0070 <span class="comment">% $Id: show_fem_enhanced.m 6342 2022-04-22 11:22:16Z bgrychtol $</span>
0071 
0072 <span class="comment">% TESTS</span>
0073 <span class="keyword">switch</span> nargin
0074     <span class="keyword">case</span> 0
0075         error(<span class="string">'Insufficient parameters for show_fem'</span>);
0076     <span class="keyword">case</span> 1
0077         <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'UNIT_TEST'</span>)
0078             <a href="#_sub12" class="code" title="subfunction do_unit_test">do_unit_test</a>; 
0079             <span class="keyword">return</span>; 
0080         <span class="keyword">end</span>
0081         <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'refresh'</span>)
0082             <a href="#_sub2" class="code" title="subfunction refresh_current_axis(obj, evd)">refresh_current_axis</a>; 
0083             <span class="keyword">return</span>; 
0084         <span class="keyword">end</span>
0085         <span class="keyword">if</span> (isstruct(mdl) &amp;&amp; isfield(mdl, <span class="string">'show_fem'</span>))
0086             options = mdl.show_fem;
0087         <span class="keyword">else</span>
0088             options = [];
0089         <span class="keyword">end</span>
0090     <span class="keyword">case</span> 2
0091         <span class="comment">% No special processing</span>
0092     <span class="keyword">otherwise</span>
0093         error(<span class="string">'Too many parameters for show_fem'</span>);
0094 <span class="keyword">end</span>
0095 
0096 [img, mdl, opts] = <a href="#_sub1" class="code" title="subfunction [img, mdl, opts] = proc_params(mdl, src_opts)">proc_params</a>(mdl, options);
0097 
0098 <span class="keyword">if</span> ~ishold
0099     cla;
0100 <span class="keyword">end</span>
0101 
0102 mdl = <a href="#_sub10" class="code" title="subfunction mdl = find_sub_elements(mdl)">find_sub_elements</a>(mdl);
0103 
0104 <span class="comment">% Convert nodes to 3D if necessary.</span>
0105 mdl.nodes = mdl.nodes*eye(size(mdl.nodes, 2), 3);
0106 
0107 hh = <a href="#_sub3" class="code" title="subfunction hh = draw_all(img, mdl, opts)">draw_all</a>(img, mdl, opts);
0108 
0109 <span class="comment">% Setup callback function.</span>
0110 <span class="keyword">if</span> (opts.edge.significant.viewpoint_dependent.callback)
0111     <span class="keyword">if</span> ~exist(<span class="string">'OCTAVE_VERSION'</span>); <span class="comment">%octave's not compativble (4.4.1)</span>
0112     h3d = rotate3d;
0113     set(gca, <span class="string">'UserData'</span>, struct(<span class="string">'name'</span>, <span class="string">'show_fem_data'</span>, <span class="string">'img'</span>, img, <span class="string">'mdl'</span>, mdl, <span class="string">'opts'</span>, opts, <span class="string">'handles'</span>, hh));
0114     set(h3d, <span class="string">'ActionPostCallback'</span> , @<a href="#_sub2" class="code" title="subfunction refresh_current_axis(obj, evd)">refresh_current_axis</a>)
0115     <span class="keyword">end</span>
0116 <span class="keyword">end</span>
0117 
0118 <span class="keyword">if</span> (nargout == 0)
0119     clear hh; 
0120 <span class="keyword">end</span>
0121 
0122 <a name="_sub1" href="#_subfunctions" class="code">function [img, mdl, opts] = proc_params(mdl, src_opts)</a>
0123 
0124     <span class="comment">% Assign default viewpoint option values.</span>
0125     opts.viewpoint.az = -37.5;
0126     opts.viewpoint.el =  30.0;
0127 
0128     <span class="comment">% Assign default edge option values.</span>
0129     opts.edge.color   = [0 0 0];
0130     opts.edge.width   = 0.5;
0131     opts.edge.significant.show  = true;
0132     opts.edge.significant.color = [0 0 0];
0133     opts.edge.significant.width = 2;
0134     opts.edge.significant.angle = 45;
0135     opts.edge.significant.viewpoint_dependent.show     = true;
0136     opts.edge.significant.viewpoint_dependent.color    = [0 0 0];
0137     opts.edge.significant.viewpoint_dependent.width    = 2;
0138     opts.edge.significant.viewpoint_dependent.callback = true;
0139  
0140     <span class="comment">% Assign default colorbar option values.</span>
0141     opts.colorbar.show = false;
0142 
0143     <span class="comment">% Assign default electrode option values.</span>
0144     opts.electrode.number.show             = false;
0145     opts.electrode.number.font_size        = 10;
0146     opts.electrode.number.font_weight      = <span class="string">'bold'</span>;
0147     opts.electrode.number.color            = [.6 0 0];
0148     opts.electrode.number.background_color = <span class="string">'none'</span>;
0149     opts.electrode.number.scale_position   = 1.15;
0150 
0151     <span class="comment">% Assign default element option values.</span>
0152     opts.element.number.show             = false;
0153     opts.element.number.font_size        = 7;
0154     opts.element.number.font_weight      = <span class="string">'normal'</span>;
0155     opts.element.number.color            = [0 0 0];
0156     opts.element.number.background_color = <span class="string">'none'</span>;
0157 
0158     <span class="comment">% Assign default node option values.</span>
0159     opts.node.number.show             = false;
0160     opts.node.number.font_size        = 7;
0161     opts.node.number.font_weight      = <span class="string">'normal'</span>;
0162     opts.node.number.color            = [0 0 0.5];
0163     opts.node.number.background_color = [1 1 1];
0164 
0165     <span class="comment">% Override some defaults in 2D</span>
0166     <span class="keyword">if</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>( mdl ) == 2
0167        opts.viewpoint.az = 0;
0168        opts.viewpoint.el = 90;
0169        opts.electrode.number.scale_position= 1.05;
0170     <span class="keyword">end</span>
0171     
0172     <span class="keyword">if</span> (nargin == 2)
0173         <span class="keyword">if</span> (isstruct(src_opts))
0174             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'viewpoint'</span>, <span class="string">'az'</span>);
0175             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'viewpoint'</span>, <span class="string">'el'</span>);
0176             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'edge'</span>, <span class="string">'color'</span>);
0177             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'edge'</span>, <span class="string">'width'</span>);
0178             
0179             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'edge'</span>))
0180                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'show'</span>);
0181                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'color'</span>);
0182                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'width'</span>);
0183                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'angle'</span>);
0184                 <span class="keyword">if</span> (isfield(src_opts.edge, <span class="string">'significant'</span>))
0185                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'show'</span>);
0186                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'color'</span>);
0187                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'width'</span>);
0188                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'callback'</span>);
0189                 <span class="keyword">end</span>
0190             <span class="keyword">end</span>
0191 
0192             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'colorbar'</span>, <span class="string">'show'</span>);
0193 
0194             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'electrode'</span>))
0195                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'show'</span>);
0196                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0197                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0198                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'color'</span>);
0199                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'background_color'</span>);
0200                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'scale_position'</span>);                
0201             <span class="keyword">end</span>
0202             
0203             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'element'</span>))
0204                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'show'</span>);
0205                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0206                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0207                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'color'</span>);
0208                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'background_color'</span>);               
0209             <span class="keyword">end</span>
0210 
0211             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'node'</span>))
0212                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'show'</span>);
0213                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0214                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0215                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'color'</span>);
0216                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'background_color'</span>);               
0217             <span class="keyword">end</span>
0218             
0219             
0220         <span class="keyword">else</span> <span class="comment">% Support options from old version of show_fem for compatibility.</span>
0221             <span class="comment">% fill in default options</span>
0222             optionstr = zeros(1, 100);
0223             optionstr(1:length(src_opts)) = src_opts;
0224 
0225             opts.colorbar.show         = optionstr(1);
0226             opts.electrode.number.show = optionstr(2);
0227             <span class="keyword">switch</span> optionstr(3)
0228                 <span class="keyword">case</span> 1
0229                     opts.element.number.show = 1;
0230                 <span class="keyword">case</span> 2
0231                     opts.node.number.show = 1;
0232                 <span class="keyword">case</span> 3
0233                     opts.element.number.show = 1;
0234                     opts.node.number.show = 1;
0235             <span class="keyword">end</span>
0236         <span class="keyword">end</span>
0237     <span class="keyword">end</span>
0238 
0239     <span class="comment">% Display first image if several images are available.</span>
0240     <span class="keyword">if</span> (numel(mdl) &gt; 1)
0241         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1);
0242         mdl = mdl(1);
0243     <span class="keyword">end</span>
0244  
0245     <span class="comment">% if we have an img input, define mdl</span>
0246     <span class="keyword">if</span> strcmp(mdl(1).type , <span class="string">'image'</span> )
0247         img = mdl;
0248         mdl = img.fwd_model;
0249     <span class="keyword">else</span>
0250         img = [];
0251     <span class="keyword">end</span>
0252 
0253 <a name="_sub2" href="#_subfunctions" class="code">function refresh_current_axis(obj, evd)</a>
0254 UserData = get(gca, <span class="string">'UserData'</span>);
0255 <span class="keyword">if</span> (all(isfield(UserData, {<span class="string">'name'</span>, <span class="string">'img'</span>, <span class="string">'mdl'</span>, <span class="string">'opts'</span>})) &amp;&amp; <span class="keyword">...</span>
0256         strcmp(UserData.name, <span class="string">'show_fem_data'</span>))
0257     [az, el] = view(gca);
0258     <span class="keyword">if</span> (az ~= UserData.opts.viewpoint.az || el ~= UserData.opts.viewpoint.el)
0259         UserData.opts.viewpoint.az = az;
0260         UserData.opts.viewpoint.el = el;
0261         delete(UserData.handles);
0262         UserData.handles = <a href="#_sub3" class="code" title="subfunction hh = draw_all(img, mdl, opts)">draw_all</a>(UserData.img, UserData.mdl, UserData.opts);
0263         set(gca, <span class="string">'UserData'</span>, UserData);
0264     <span class="keyword">end</span>
0265 <span class="keyword">end</span>
0266 
0267 <a name="_sub3" href="#_subfunctions" class="code">function hh = draw_all(img, mdl, opts)</a>
0268 
0269     hh = <a href="#_sub4" class="code" title="subfunction hh = draw_fem(img, mdl, opts)">draw_fem</a>(img, mdl, opts);
0270 
0271     <span class="comment">% Number elements if necessary.</span>
0272     <span class="keyword">if</span> (opts.element.number.show)
0273         h= <a href="#_sub5" class="code" title="subfunction hh = draw_numbers(positions, opts)">draw_numbers</a>(<a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(mdl), opts.element.number);
0274         hh = [hh; h];
0275     <span class="keyword">end</span>
0276 
0277     <span class="comment">% Number nodes if necessary.</span>
0278     <span class="keyword">if</span> (opts.node.number.show)
0279         h = <a href="#_sub5" class="code" title="subfunction hh = draw_numbers(positions, opts)">draw_numbers</a>(mdl.nodes, opts.node.number);
0280         hh = [hh; h];
0281     <span class="keyword">end</span>
0282 
0283     <span class="comment">% Number electrodes if necessary.</span>
0284     <span class="keyword">if</span> (opts.electrode.number.show &amp;&amp; isfield(mdl, <span class="string">'electrode'</span>))
0285         n_elec = numel(mdl.electrode);
0286         mesh_center = ones(n_elec, 1)*mean(mdl.nodes, 1);
0287 
0288         elec_pos = zeros(n_elec, size(mesh_center, 2));
0289 
0290         <span class="keyword">for</span> i = 1:n_elec
0291             <span class="keyword">if</span> (isfield(mdl.electrode(i), <span class="string">'nodes'</span>))
0292                 elec_pos(i, :) = mean(mdl.nodes(mdl.electrode(i).nodes, :), 1);
0293             <span class="keyword">elseif</span> (isfield(mdl.electrode(i), <span class="string">'pos'</span>))
0294                 elec_pos(i, :) = mean(mdl.electrode(i).pos, 1)*eye(size(<span class="keyword">...</span>
0295                                                         elec_pos(i, :), 2), 3);
0296             <span class="keyword">end</span>
0297         <span class="keyword">end</span>
0298 
0299         <a href="#_sub5" class="code" title="subfunction hh = draw_numbers(positions, opts)">draw_numbers</a>(opts.electrode.number.scale_position*(elec_pos - mesh_center) + mesh_center, opts.electrode.number);
0300     <span class="keyword">end</span>
0301 
0302     <span class="keyword">if</span> (size(mdl.elems, 2) == 4)  
0303         view(opts.viewpoint.az, opts.viewpoint.el);
0304     <span class="keyword">end</span>
0305 
0306     axis image;
0307     
0308 <a name="_sub4" href="#_subfunctions" class="code">function hh = draw_fem(img, mdl, opts)</a>
0309     
0310     <span class="comment">% Assign colors and alpha to elements.</span>
0311     <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0312         <span class="keyword">if</span> ~isempty(img)
0313             elems = mdl.sub_elements;
0314             electrode_field = <span class="string">'sub_elements'</span>;
0315         <span class="keyword">else</span>
0316             elems = mdl.boundary;
0317             electrode_field = <span class="string">'boundary'</span>;
0318         <span class="keyword">end</span>
0319         triangle_alpha = 0.5*ones(size(elems, 1), 1);
0320         triangle_edge_color = <span class="string">'none'</span>;
0321         triangle_edge_width = 0.5;
0322         
0323         <span class="comment">% Color mesh edges.</span>
0324         edge_edges = mdl.boundary_edges;
0325         edge_width = ones(size(edge_edges, 1), 1)*opts.edge.width;
0326         edge_color = ones(size(edge_edges, 1), 1)*opts.edge.color;
0327         
0328         <span class="keyword">if</span> opts.edge.significant.show
0329             <span class="keyword">if</span> opts.edge.significant.viewpoint_dependent.show 
0330                 <span class="keyword">if</span> exist(<span class="string">'viewmtx'</span>)
0331                 <span class="comment">% Highlight profile of boundary according to viewing angle.</span>
0332                 T = viewmtx(opts.viewpoint.az, opts.viewpoint.el);
0333                 <span class="keyword">else</span> <span class="comment">% octave doesn't have viewmtx yet</span>
0334                 T = ones(4);
0335                 <span class="keyword">end</span>
0336                 transformed_boundary_normal_vector = mdl.boundary_normal_vector*T(1:3,1:3)';
0337                 boundary_edges_idx2 = (transformed_boundary_normal_vector(mdl.edge2boundary(:, 1), 3).*transformed_boundary_normal_vector(mdl.edge2boundary(:, 2), 3) &lt;= 0);
0338 
0339                 edge_width(boundary_edges_idx2)    = opts.edge.significant.viewpoint_dependent.width;
0340                 edge_color(boundary_edges_idx2, :) = ones(sum(boundary_edges_idx2), 1)*opts.edge.significant.viewpoint_dependent.color;
0341             <span class="keyword">end</span>
0342 
0343             <span class="comment">% Highlight significant edges where boundary shape bends more than</span>
0344             <span class="comment">% 45 degrees.</span>
0345             boundary_edges_idx = dot(mdl.boundary_normal_vector(<span class="keyword">...</span>
0346                                      mdl.edge2boundary(:, 1), :), <span class="keyword">...</span>
0347                                      mdl.boundary_normal_vector(<span class="keyword">...</span>
0348                                      mdl.edge2boundary(:, 2), :), 2) <span class="keyword">...</span>
0349                                      &lt;= cosd(opts.edge.significant.angle);
0350             edge_width(boundary_edges_idx)    = opts.edge.significant.width;
0351             edge_color(boundary_edges_idx, :) = ones(sum(boundary_edges_idx), 1)*opts.edge.significant.color;
0352         <span class="keyword">end</span>
0353     <span class="keyword">else</span>
0354         elems = mdl.elems;
0355         electrode_field = <span class="string">'boundary'</span>;
0356         triangle_alpha = ones(size(elems, 1), 1);
0357         triangle_edge_color = opts.edge.color;
0358         triangle_edge_width = opts.edge.width;
0359         
0360         <span class="comment">% Highlight mesh boundary.</span>
0361         <span class="keyword">if</span> opts.edge.significant.show
0362             edge_edges = mdl.boundary;
0363             edge_width = opts.edge.significant.width*ones(size(edge_edges, 1), 1);
0364             edge_color = ones(size(edge_edges, 1), 1)*opts.edge.significant.color;
0365         <span class="keyword">else</span>
0366             edge_edges = [];
0367         <span class="keyword">end</span>
0368     <span class="keyword">end</span>
0369     
0370     <span class="keyword">if</span> ~isempty(img)
0371         <span class="keyword">if</span> (size(mdl.elems, 2) == 4) 
0372             img_data = <a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>(img);
0373             <span class="keyword">if</span> size(img_data,1) == size(mdl.elems,1)
0374                 triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(mdl.element2sub_element*<span class="keyword">...</span>
0375                                     img_data, img);
0376             <span class="keyword">elseif</span> size(img_data,1) == size(mdl.nodes,1)
0377                 triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img_data, img);
0378             <span class="keyword">else</span>
0379                 error(<span class="string">'wrong size of data'</span>);
0380             <span class="keyword">end</span>
0381 
0382             factor = 3/8;
0383             
0384             alpha_map = zeros(size(colormap, 1), 1);
0385             alpha = linspace(0, 1, round(size(colormap, 1)*factor))';
0386             alpha_map(1:size(alpha, 1)) = alpha(end:-1:1);
0387             alpha_map(end:-1:(end-size(alpha, 1)+1)) = alpha(end:-1:1);
0388             
0389             factor = 3/8;
0390             alpha_map2 = ones(size(colormap, 1), 1);
0391             alpha2 = linspace(0, 1, round(size(colormap, 1)*factor))';
0392             alpha_map2((1:size(alpha2, 1)) + size(colormap, 1)/2) = alpha2;
0393             alpha_map2((end:-1:(end-size(alpha2, 1)+1)) - size(colormap, 1)/2) = alpha2;
0394             
0395             factor = 3/8;
0396             alpha_map3 = ones(size(colormap, 1), 1);
0397             alpha3 = linspace(0, 1, round(size(colormap, 1)*factor))';
0398             idx1 = (size(colormap, 1)/2 - size(alpha3, 1))/2;
0399             alpha_map3((-idx1:idx1) + size(colormap, 1)/2) = 0;
0400             alpha_map3((1:size(alpha3, 1)) + size(colormap, 1)/2 + (size(colormap, 1)/2 - size(alpha3, 1))/2) = alpha3;
0401             alpha_map3((end:-1:(end-size(alpha3, 1)+1)) - size(colormap, 1)/2 - (size(colormap, 1)/2 - size(alpha3, 1))/2) = alpha3;
0402     
0403             triangle_alpha = alpha_map3(triangle_color);
0404             
0405             <span class="comment">% Restore transparency for boundary elements;</span>
0406             <span class="keyword">if</span> size(img_data,1) == size(mdl.elems,1)
0407                 alpha_idx =  triangle_alpha(mdl.boundary_to_sub_element_idx, :) &lt; 0.5;
0408                 triangle_alpha(mdl.boundary_to_sub_element_idx(alpha_idx), :) = 0.5;
0409             <span class="keyword">else</span>
0410                 alpha_idx = triangle_alpha(mdl.boundary_node_idx, :) &lt; 0.5;
0411                 triangle_alpha(mdl.boundary_node_idx(alpha_idx), :) = 0.5;
0412             <span class="keyword">end</span>
0413         <span class="keyword">else</span>
0414             triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img);
0415         <span class="keyword">end</span>
0416         triangle_color = squeeze(triangle_color(:, 1, :));
0417     <span class="keyword">else</span>
0418         triangle_color = ones(size(elems, 1), 1)*[1 1 1];
0419     <span class="keyword">end</span>
0420     
0421     <span class="comment">% Assign colors for electrodes.</span>
0422     marker_position = [];
0423     marker_color    = [];
0424     
0425     <span class="keyword">if</span> (isfield(mdl, <span class="string">'electrode'</span>))
0426         <span class="keyword">for</span> i = 1:numel(mdl.electrode)
0427             <span class="keyword">if</span> (isfield(mdl.electrode(i), electrode_field) &amp;&amp; <span class="keyword">...</span>
0428                     ~isempty(mdl.electrode(i).(electrode_field)))
0429                 
0430                 <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0431                     triangle_color(<span class="keyword">...</span>
0432                         mdl.electrode(i).(electrode_field), :) = <span class="keyword">...</span>
0433                         ones(numel(mdl.electrode(i).(electrode_field)), <span class="keyword">...</span>
0434                         1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i),i, size(triangle_color, 2));
0435 
0436                     triangle_alpha(mdl.electrode(i).(electrode_field), <span class="keyword">...</span>
0437                                                                     :) = 1;
0438                     <span class="comment">% Highlight electrode edges.</span>
0439                     boundary_edges = [mdl.electrode(i).boundary_inner_edges;
0440                                       mdl.electrode(i).boundary_outer_edges];
0441                     edge_color(boundary_edges, :) = 0.5*ones(size(<span class="keyword">...</span>
0442                         boundary_edges, 1), 1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i), i, 3);
0443                     edge_width(mdl.electrode(i).boundary_outer_edges) = 1;
0444                 <span class="keyword">else</span>
0445 
0446                     edge_width(mdl.electrode(i).(electrode_field), :) = 3;
0447                     edge_color(mdl.electrode(i).(electrode_field), :) = <span class="keyword">...</span>
0448                         ones(numel(mdl.electrode(i).(electrode_field)), <span class="keyword">...</span>
0449                         1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i),i, 3);
0450                 <span class="keyword">end</span>
0451             <span class="keyword">else</span>
0452                 <span class="keyword">if</span> (isfield(mdl.electrode(i), <span class="string">'nodes'</span>))
0453                     marker_position(end + 1, :) = mean(mdl.nodes(<span class="keyword">...</span>
0454                                             mdl.electrode(i).nodes, :), 1);
0455                 <span class="keyword">elseif</span> (isfield(mdl.electrode(i), <span class="string">'pos'</span>))
0456                     marker_position(end + 1, :) = mean(<span class="keyword">...</span>
0457                                                mdl.electrode(i).pos, 1)*<span class="keyword">...</span>
0458                                   eye(size(marker_position(<span class="keyword">end</span>, :), 2), 3);
0459                 <span class="keyword">end</span>
0460                 marker_color(end + 1, :) = <a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i), i, 3);
0461             <span class="keyword">end</span>
0462         <span class="keyword">end</span>
0463     <span class="keyword">end</span>
0464 
0465     <span class="comment">% Draw triangles</span>
0466     hh = <a href="#_sub8" class="code" title="subfunction hh = draw_triangles(faces, vertices, color_data, alpha_data, ">draw_triangles</a>(elems, mdl.nodes, <span class="keyword">...</span>
0467                       triangle_color, triangle_alpha, <span class="keyword">...</span>
0468                       triangle_edge_color, triangle_edge_width);
0469 
0470     <span class="comment">% Draw edges if necessary</span>
0471     <span class="keyword">if</span> (~isempty(edge_edges))
0472         h = <a href="#_sub7" class="code" title="subfunction hh = draw_edges(edges, vertices, width_data, color_data)">draw_edges</a>(edge_edges, mdl.nodes, edge_width, edge_color);
0473         hh = [hh; h];
0474     <span class="keyword">end</span>
0475                   
0476     <span class="comment">% Draw markers if necessary.</span>
0477     <span class="keyword">if</span> (~isempty(marker_position))
0478         h = <a href="#_sub6" class="code" title="subfunction hh = draw_markers(points, colour, marker_size)">draw_markers</a>(marker_position, marker_color, 9);
0479         hh = [hh; h];
0480     <span class="keyword">end</span>
0481 
0482     <span class="keyword">if</span> opts.colorbar.show &amp;&amp; ~isempty( img )
0483 <span class="comment">%       psave = get(gca,'position');</span>
0484         <a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>( img ); 
0485 <span class="comment">%       set(gca,'position',psave); %%% Reset axes after colourbar and move</span>
0486     <span class="keyword">end</span>
0487     
0488 <a name="_sub5" href="#_subfunctions" class="code">function hh = draw_numbers(positions, opts)</a>
0489     hh = text(positions(:,1), positions(:,2), positions(:,3), <span class="keyword">...</span>
0490         arrayfun(@(x){int2str(x)}, 1:size(positions, 1)), <span class="keyword">...</span>
0491         <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="keyword">...</span>
0492         <span class="string">'VerticalAlignment'</span>,   <span class="string">'middle'</span>, <span class="keyword">...</span>
0493         <span class="string">'FontSize'</span>,            opts.font_size, <span class="keyword">...</span>
0494         <span class="string">'FontWeight'</span>,          opts.font_weight, <span class="keyword">...</span>
0495         <span class="string">'Color'</span>,               opts.color, <span class="keyword">...</span>
0496         <span class="string">'BackgroundColor'</span>,     opts.background_color);
0497 
0498 <a name="_sub6" href="#_subfunctions" class="code">function hh = draw_markers(points, colour, marker_size)</a>
0499     [unique_colour, unused, colour_idx] = unique(colour, <span class="string">'rows'</span>);
0500     
0501     <span class="keyword">for</span> i = 1:size(unique_colour, 1)
0502         points_idx = colour_idx == i;
0503         hh = line(points(points_idx, 1), points(points_idx, 2), <span class="keyword">...</span>
0504                   points(points_idx, 3), <span class="keyword">...</span>
0505                   <span class="string">'LineStyle'</span>, <span class="string">'none'</span>, <span class="keyword">...</span>
0506                   <span class="string">'Marker'</span>, <span class="string">'o'</span>, <span class="string">'MarkerSize'</span>, marker_size, <span class="keyword">...</span>
0507                   <span class="string">'MarkerFaceColor'</span>, unique_colour(i, :), <span class="keyword">...</span>
0508                   <span class="string">'MarkerEdgeColor'</span>, unique_colour(i, :));
0509     <span class="keyword">end</span>
0510         
0511 <a name="_sub7" href="#_subfunctions" class="code">function hh = draw_edges(edges, vertices, width_data, color_data)</a>
0512     [unique_width_color_data, unused, width_color_idx] = <span class="keyword">...</span><span class="comment"> </span>
0513                                    unique([width_data color_data], <span class="string">'rows'</span>); 
0514     hh = [];
0515     <span class="keyword">for</span> i = 1:size(unique_width_color_data, 1)
0516         <span class="keyword">if</span> (unique_width_color_data(i, 1) &gt; 0)
0517             edge_idx = (width_color_idx == i);
0518             points_list = [];
0519             points_list(1:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0520                                            vertices(edges(edge_idx, 1), :);
0521             points_list(2:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0522                                            vertices(edges(edge_idx, 2), :);
0523             points_list(3:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0524                                        nan(size(edges(edge_idx, :), 1), 3);
0525             h = line(points_list(:, 1), points_list(:, 2), <span class="keyword">...</span>
0526                       points_list(:, 3), <span class="string">'LineWidth'</span>, <span class="keyword">...</span>
0527                       unique_width_color_data(i, 1), <span class="string">'LineStyle'</span>, <span class="string">'-'</span>, <span class="keyword">...</span>
0528                       <span class="string">'Color'</span>, unique_width_color_data(i, 2:end));
0529             hh = [hh; h];
0530         <span class="keyword">end</span>
0531     <span class="keyword">end</span>
0532 
0533 <a name="_sub8" href="#_subfunctions" class="code">function hh = draw_triangles(faces, vertices, color_data, alpha_data, </a><span class="keyword">...</span>
0534                              edge_color, edge_width)
0535                          
0536     <span class="keyword">if</span> (size(color_data, 1) == 1)
0537         color_data = ones(size(faces, 1), 1)*color_data;
0538         face_color = <span class="string">'flat'</span>;
0539     <span class="keyword">elseif</span> (size(color_data, 1) == size(faces, 1))
0540         face_color = <span class="string">'flat'</span>;
0541     <span class="keyword">elseif</span> (size(color_data, 1) == size(vertices, 1))
0542         face_color = <span class="string">'interp'</span>;        
0543     <span class="keyword">else</span>
0544         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: color data and mesh do not match. Showing grey'</span>, 1);
0545         color_data = 0.5*ones(size(faces, 1), 3);
0546         face_color = <span class="string">'flat'</span>;      
0547     <span class="keyword">end</span>
0548     
0549     alpha_data_mapping = <span class="string">'none'</span>;
0550     <span class="keyword">if</span> (size(alpha_data, 1) == 1)
0551         alpha_data = ones(size(faces, 1), 1)*alpha_data;
0552         face_color = <span class="string">'flat'</span>;
0553     <span class="keyword">elseif</span> (size(alpha_data, 1) == size(faces, 1))
0554         face_alpha = <span class="string">'flat'</span>;
0555     <span class="keyword">elseif</span> (size(alpha_data, 1) == size(vertices, 1))
0556         face_alpha = <span class="string">'interp'</span>;  
0557         alpha_data_mapping = <span class="string">'scaled'</span>;  <span class="comment">% why is this needed??</span>
0558     <span class="keyword">else</span>
0559         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: alpha data and mesh do not match. Showing opaque'</span>, 1);
0560         alpha_data = 1;
0561         face_alpha = <span class="string">'flat'</span>;        
0562     <span class="keyword">end</span>
0563 
0564     hh = patch(<span class="string">'Faces'</span>, faces, <span class="string">'Vertices'</span>, vertices, <span class="keyword">...</span>
0565                <span class="string">'AlphaDataMapping'</span>, alpha_data_mapping, <span class="keyword">...</span>
0566                <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span>, <span class="keyword">...</span>
0567                <span class="string">'FaceVertexCData'</span>, color_data, <span class="keyword">...</span>
0568                <span class="string">'FaceVertexAlphaData'</span>, alpha_data, <span class="keyword">...</span>
0569                <span class="string">'FaceColor'</span>, face_color, <span class="string">'FaceAlpha'</span>, face_alpha, <span class="keyword">...</span>
0570                <span class="string">'EdgeColor'</span>, edge_color, <span class="string">'FaceLighting'</span>, <span class="string">'flat'</span>, <span class="keyword">...</span>
0571                <span class="string">'LineWidth'</span>, edge_width);
0572 
0573 <a name="_sub9" href="#_subfunctions" class="code">function colour = electr_colour(elec, e, colormap_width)</a>
0574     <span class="keyword">if</span> isfield(elec, <span class="string">'colour'</span>)
0575         desired_colour = elec.colour;
0576     <span class="keyword">else</span>
0577         <span class="keyword">switch</span> (e)
0578             <span class="keyword">case</span> 1
0579                 desired_colour = [0 .7 0]; <span class="comment">% light green electrode #1</span>
0580             <span class="keyword">case</span> 2
0581                 desired_colour = [0 .5 0]; <span class="comment">% mid-green electrode #2</span>
0582             <span class="keyword">otherwise</span>
0583                 desired_colour = [0 .3 0]; <span class="comment">% dark green</span>
0584         <span class="keyword">end</span>
0585     <span class="keyword">end</span>
0586     <span class="keyword">switch</span>(colormap_width)
0587         <span class="keyword">case</span> 1
0588             map = colormap;
0589             colormap_idx = find(all(map == ones(size(map, 1), 1)* <span class="keyword">...</span>
0590                                                        desired_colour, 2));
0591             <span class="keyword">if</span> ~isempty(colormap_idx)
0592                 colour = colormap_idx;
0593             <span class="keyword">else</span>
0594                 map = [map; desired_colour];
0595                 colormap(map);
0596                 colour = size(map, 1);
0597             <span class="keyword">end</span>
0598         <span class="keyword">case</span> 3 
0599             colour = desired_colour;
0600         <span class="keyword">otherwise</span>
0601             error(<span class="string">'Invalid colormap width.'</span>);
0602     <span class="keyword">end</span>
0603     
0604 <a name="_sub10" href="#_subfunctions" class="code">function mdl = find_sub_elements(mdl)</a>
0605     <span class="keyword">if</span> (~isfield(mdl, <span class="string">'sub_elements'</span>))
0606         <span class="comment">% Number of nodes per elements.</span>
0607         n_nodes_per_elem = size(mdl.elems, 2);
0608         
0609         <span class="comment">% Find sub-elements.</span>
0610         combos= nchoosek(1:n_nodes_per_elem, n_nodes_per_elem - 1);
0611         mdl.sub_elements = sort( <span class="keyword">...</span>
0612                            reshape(mdl.elems(:, combos')', <span class="keyword">...</span>
0613                                    n_nodes_per_elem - 1, []), <span class="keyword">...</span>
0614                                  1)';
0615                        
0616         <span class="comment">% Vector that associates each sub-element with</span>
0617         <span class="comment">% corresponding element.</span>
0618         sub_element_idx = reshape(ones(n_nodes_per_elem, 1) <span class="keyword">...</span>
0619                                            *(1:size(mdl.elems, 1)),[] , 1);
0620                                        
0621         sub_element_other_node_idx = reshape((n_nodes_per_elem:-1:1)'<span class="keyword">...</span>
0622                                      *ones(1, size(mdl.elems, 1)), [] , 1);
0623                                  
0624         sub_element_other_node = mdl.elems(sub2ind(size(mdl.elems), sub_element_idx, sub_element_other_node_idx));
0625                        
0626         <span class="comment">% Remove duplicate sub-elements.</span>
0627         <span class="comment">% Previously specified &quot;SPORTED&quot; but that is default, and not</span>
0628         <span class="comment">%   available in older versions</span>
0629         [mdl.sub_elements, ia, ic] = unique(<span class="keyword">...</span>
0630                                        mdl.sub_elements, <span class="string">'rows'</span>);
0631                                    
0632          sub_element_other_node = sub_element_other_node(ia, :);                    
0633                                 
0634         <span class="comment">% Compute a matrix that converts a property defined on the elements</span>
0635         <span class="comment">% to a property defined on the sub-elements.</span>
0636         mdl.element2sub_element = <a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(ic, sub_element_idx, <span class="keyword">...</span>
0637                              ones(n_nodes_per_elem*size(mdl.elems, 1), 1));
0638                          
0639         <span class="comment">% Normalize each row to one to account for boundary sub-elements</span>
0640         <span class="comment">% and internal sub-elements.</span>
0641         mdl.element2sub_element = spdiags(1./sum(<span class="keyword">...</span>
0642                                      mdl.element2sub_element, 2), <span class="keyword">...</span>
0643                                     0, size(mdl.sub_elements, 1), <span class="keyword">...</span>
0644                       size(mdl.sub_elements, 1))*mdl.element2sub_element;
0645                   
0646         <span class="comment">% Extract boundary from sub-elements.</span>
0647         mdl.boundary = mdl.sub_elements;
0648         boundary_other_node = sub_element_other_node;
0649         mdl.boundary_to_sub_element_idx = (1:size(mdl.sub_elements, 1))';
0650 
0651         sorted_ic = sort(ic);
0652 
0653         mdl.boundary(sorted_ic(diff(sorted_ic) == 0), :) = [];
0654         boundary_other_node(sorted_ic(diff(sorted_ic) == 0), :) = [];
0655         mdl.boundary_to_sub_element_idx(sorted_ic(diff(sorted_ic) == 0)) = [];
0656 
0657         <span class="comment">% in case we get vertex data we need the boundary nodes</span>
0658         mdl.boundary_node_idx  = (unique(mdl.boundary(:)));
0659         
0660         
0661         <span class="keyword">if</span> (size(mdl.boundary, 2) == 3)
0662             <span class="comment">% Compute normal vectors.</span>
0663             Node1 = mdl.nodes(mdl.boundary(:, 1), :);
0664             Node2 = mdl.nodes(mdl.boundary(:, 2), :);
0665             Node3 = mdl.nodes(mdl.boundary(:, 3), :);
0666             Node4 = mdl.nodes(boundary_other_node, :);
0667             mdl.boundary_normal_vector = cross(Node1 - Node2, <span class="keyword">...</span>
0668                                                Node3 - Node2, 2);
0669  
0670             <span class="comment">% Normalize normal vectors.</span>
0671             norm = 1./sqrt(sum(mdl.boundary_normal_vector <span class="keyword">...</span>
0672                                          .*mdl.boundary_normal_vector, 2));
0673             mdl.boundary_normal_vector = mdl.boundary_normal_vector <span class="keyword">...</span>
0674                                                         .*[norm norm norm];
0675               
0676             <span class="comment">% Check if normal is outward. If not, invert direction.</span>
0677             normal_vector_idx = dot(mdl.boundary_normal_vector, <span class="keyword">...</span>
0678                                                      Node4 - Node2, 2) &gt; 0;
0679             mdl.boundary_normal_vector(normal_vector_idx, :) = <span class="keyword">...</span>
0680                          -mdl.boundary_normal_vector(normal_vector_idx, :);
0681                                                     
0682             <span class="comment">% Find boundary edges.</span>
0683             mdl.boundary_edges = sort(reshape(mdl.boundary(:, <span class="keyword">...</span>
0684                                             nchoosek(1:3, 2)')', 2, []), 1)';
0685 
0686             <span class="comment">% Vector that associates each edge with its</span>
0687             <span class="comment">% corresponding two boundary elements.</span>
0688             sub_boundary_edges_idx = reshape(ones(3, 1) <span class="keyword">...</span>
0689                                        *(1:size(mdl.boundary, 1)), [] , 1);
0690 
0691             [mdl.boundary_edges, sorted_idx] = sortrows(mdl.boundary_edges);
0692 
0693             mdl.boundary_edges = mdl.boundary_edges(1:2:<span class="keyword">end</span>, :);
0694 
0695             mdl.edge2boundary = reshape(sub_boundary_edges_idx(<span class="keyword">...</span>
0696                                                       sorted_idx), 2, [])';               
0697         <span class="keyword">end</span>
0698 
0699         <span class="comment">% Extract electrode boundary if necessary.</span>
0700         <span class="keyword">if</span> (isfield(mdl, <span class="string">'electrode'</span>))
0701             <span class="keyword">for</span> i = 1:numel(mdl.electrode)
0702                 mdl.electrode(i).boundary = find(all(ismember(<span class="keyword">...</span>
0703                                 mdl.boundary, mdl.electrode(i).nodes), 2));
0704                 mdl.electrode(i).sub_elements = <span class="keyword">...</span>
0705                                     mdl.boundary_to_sub_element_idx( <span class="keyword">...</span>
0706                                                 mdl.electrode(i).boundary);
0707                 
0708                 <span class="comment">% Find electrode edges.</span>
0709                 <span class="keyword">if</span> (isfield(mdl, <span class="string">'boundary_edges'</span>))
0710                     edge_candidates = sum(ismember(mdl.edge2boundary, <span class="keyword">...</span>
0711                                             mdl.electrode(i).boundary), 2);
0712                     mdl.electrode(i).boundary_inner_edges = find(<span class="keyword">...</span>
0713                                                      edge_candidates == 2);
0714                     mdl.electrode(i).boundary_outer_edges = find(<span class="keyword">...</span>
0715                                                      edge_candidates == 1);                                           
0716                 <span class="keyword">end</span>
0717             <span class="keyword">end</span>
0718         <span class="keyword">end</span>
0719     <span class="keyword">end</span>
0720    
0721 <a name="_sub11" href="#_subfunctions" class="code">function dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)</a>
0722     <span class="keyword">if</span> (isfield(src_struct, parent_field_name) &amp;&amp; <span class="keyword">...</span>
0723         isfield(dest_struct, parent_field_name) &amp;&amp; <span class="keyword">...</span>
0724         isfield(src_struct.(parent_field_name), child_field_name))
0725             dest_struct.(parent_field_name).(child_field_name) = <span class="keyword">...</span>
0726                 src_struct.(parent_field_name).(child_field_name);
0727     <span class="keyword">end</span>
0728 
0729 <span class="comment">% TESTS:</span>
0730 <a name="_sub12" href="#_subfunctions" class="code">function do_unit_test</a>
0731    ver= <a href="../../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'interpreter_version'</span>);
0732    clf
0733 
0734    img=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,8)); 
0735    img.elem_data= 3*sin(linspace(-2,2,<a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(img))');
0736    subplot(3,4,1); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img.fwd_model,[0,0,1]) 
0737    title(<span class="string">'regular mesh numbered'</span>);
0738 
0739 <span class="keyword">if</span> ~ver.isoctave 
0740    imgn = rmfield(img,<span class="string">'elem_data'</span>);
0741    imgn.node_data= 3*sin(linspace(-5,5,<a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(img))');
0742    subplot(3,4,9); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(imgn) 
0743    title(<span class="string">'interpolated node colours'</span>);
0744 <span class="keyword">end</span>
0745 
0746    img2(1) = img; img2(2) = img;
0747    subplot(3,4,2); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img,[1]);
0748    title(<span class="string">'colours with legend'</span>);
0749    subplot(3,4,3); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img2,[0,1]);
0750    title(<span class="string">'colours with legend'</span>);
0751    img.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0752    subplot(3,4,4); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img,[0,1,1]);
0753    title(<span class="string">'RGB colours'</span>);
0754    subplot(3,4,4); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img);
0755    title(<span class="string">'RGB colours'</span>);
0756 
0757    img.elem_data = [1:10];
0758    subplot(3,4,12);<a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img); <span class="comment">%Should show grey</span>
0759    title(<span class="string">'error -&gt; show grey'</span>);
0760 
0761 <span class="keyword">if</span> ~ver.isoctave
0762    imgn.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0763    subplot(3,4,10);<a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(imgn,[0,1]) 
0764    title(<span class="string">'interpolated node colours'</span>);
0765 
0766 
0767    subplot(3,4,11);hh=<a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(imgn); set(hh(1),<span class="string">'EdgeColor'</span>,[0,0,1]);
0768    title(<span class="string">'with edge colours'</span>);
0769 
0770 <span class="keyword">end</span>
0771 
0772    img3=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]));
0773    img3.elem_data= randn(828,1);                       
0774    subplot(3,4,5); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3.fwd_model) 
0775    subplot(3,4,6); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,[1])
0776    subplot(3,4,7); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,[1,1])
0777    subplot(3,4,8); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,[1,1,1])</pre></div>
<hr><address>Generated on Fri 30-Dec-2022 20:46:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>