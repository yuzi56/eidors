<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ng_write_opt</title>
  <meta name="keywords" content="ng_write_opt">
  <meta name="description" content="NG_WRITE_OPT Write an ng.opt file in current directory">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="../index.html">meshing</a> &gt; <a href="index.html">netgen</a> &gt; ng_write_opt.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/meshing/netgen&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>ng_write_opt
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>NG_WRITE_OPT Write an ng.opt file in current directory</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function opt = ng_write_opt(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">NG_WRITE_OPT Write an ng.opt file in current directory
  NG_WRITE_OPT, without inputs, creates a default ng.opt

  NG_WRITE_OPT(OPTSTRUCT) creates uses options as specified in OPTSTRUCT

  NG_WRITE_OPT('sec.option',val,...) offers an alternative interface to
  modify specific options

  NG_WRITE_OPT(OPTSTR,...) where OPTSTR is one of 'very_coarse', 'coarse',
  'moderate', 'fine', and 'very_fine', based on the corresponding defaults
  in Netgen 5.0. Any additional inputs modify selected fields of that
  default. NG_WRITE_OPT('moderate',...) is equivalent to
  NG_WRITE_OPT(...).

  OPTSTRUCT = NG_WRITE_OPT(...) returns a struct with the options.
  No file is written.

  NG_WRITE_OPT(PATH) copies the file specified in PATH as ng.opt to the
  current directory.

 
  Note: some options only take effect when meshoptions.fineness is 6
  (custom).

  BEWARE: NG_WRITE_OPT will overwrite any existing ng.opt file in the current
  directory. 
 
  Example:
  ng_write_opt('meshoptions.fineness',6,'options.minmeshsize',20);
  call_netgen(...)
  delete('ng.opt'); % clean up

 To specify a volume for refinement, specify
  ng_write_opt('MSZPOINTS', [list of x,y,z,maxh])
   or
  ng_write_opt('MSZBRICK', [xmin, xmax, ymin, ymax, zmin, zmax, maxh])
   or
  ng_write_opt('MSZSPHERE', [xctr, yctr, zctr, radius, maxh])
  ng_write_opt('MSZCYLINDER', [x1, y1, z1, x2, y2, z2, radius, maxh])
     where (x1,y1,z1) and (x2,y2,z2) are the limits on the axis

  See also <a href="call_netgen.html" class="code" title="function status= call_netgen(geo_file, vol_file, msz_file, finelevel)">CALL_NETGEN</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="ng_mk_gen_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_gen_models(shape_str, elec_pos,  elec_shape, elec_obj, extra_ng_code, mszpoints);">ng_mk_gen_models</a>	NG_MK_GEN_MODELS: create generic models using netgen</li><li><a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>	NG_WRITE_OPT Write an ng.opt file in current directory</li><li><a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>	NUM_NODES: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="ng_mk_2d_model.html" class="code" title="function mdl = ng_mk_2d_model(varargin)">ng_mk_2d_model</a>	NG_MG_2D_MODELS create a 2D mesh with Netgen via the in2d interface</li><li><a href="ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="ng_mk_extruded_model.html" class="code" title="function [fmdl,mat_idx] = ng_mk_extruded_model(shape, elec_pos, elec_shape,extra_ng_code)">ng_mk_extruded_model</a>	NG_MAKE_EXTRUDED_MODEL: create extruded models using netgen</li><li><a href="ng_read_opt.html" class="code" title="function opt = ng_read_opt(fname)">ng_read_opt</a>	NG_READ_OPT Read Netgen's ng.opt</li><li><a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>	NG_WRITE_OPT Write an ng.opt file in current directory</li><li><a href="../../../eidors/models/mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>	MK_THORAX_MODEL FEM models of the thorax</li><li><a href="../../../eidors/models/place_elec_on_surf.html" class="code" title="function mdl2 = place_elec_on_surf(mdl,elec_pos, elec_spec,ng_opt_file, maxh)">place_elec_on_surf</a>	PLACE_ELEC_ON_SURF Place electrodes on the surface of a model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function opt = process_input(varargin)</a></li><li><a href="#_sub2" class="code">function val = msz_brick(val)</a></li><li><a href="#_sub3" class="code">function val = msz_sphere(val)</a></li><li><a href="#_sub4" class="code">function pts = space_around_zero(lim,maxh);</a></li><li><a href="#_sub5" class="code">function val = msz_cylinder(val)</a></li><li><a href="#_sub6" class="code">function fname = write_tmp_mszfile( mszpoints )</a></li><li><a href="#_sub7" class="code">function opt = copy_field(opt,usr)</a></li><li><a href="#_sub8" class="code">function write_ng_file(opt)</a></li><li><a href="#_sub9" class="code">function write_field(fid,s,str)</a></li><li><a href="#_sub10" class="code">function opt = default_opt(varargin)</a></li><li><a href="#_sub11" class="code">function do_unit_test</a></li><li><a href="#_sub12" class="code">function test_caching()</a></li><li><a href="#_sub13" class="code">function test_main_options()</a></li><li><a href="#_sub14" class="code">function unit_test_MSZ</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function opt = ng_write_opt(varargin)</a>
0002 <span class="comment">%NG_WRITE_OPT Write an ng.opt file in current directory</span>
0003 <span class="comment">%  NG_WRITE_OPT, without inputs, creates a default ng.opt</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%  NG_WRITE_OPT(OPTSTRUCT) creates uses options as specified in OPTSTRUCT</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%  NG_WRITE_OPT('sec.option',val,...) offers an alternative interface to</span>
0008 <span class="comment">%  modify specific options</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%  NG_WRITE_OPT(OPTSTR,...) where OPTSTR is one of 'very_coarse', 'coarse',</span>
0011 <span class="comment">%  'moderate', 'fine', and 'very_fine', based on the corresponding defaults</span>
0012 <span class="comment">%  in Netgen 5.0. Any additional inputs modify selected fields of that</span>
0013 <span class="comment">%  default. NG_WRITE_OPT('moderate',...) is equivalent to</span>
0014 <span class="comment">%  NG_WRITE_OPT(...).</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%  OPTSTRUCT = NG_WRITE_OPT(...) returns a struct with the options.</span>
0017 <span class="comment">%  No file is written.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%  NG_WRITE_OPT(PATH) copies the file specified in PATH as ng.opt to the</span>
0020 <span class="comment">%  current directory.</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%  Note: some options only take effect when meshoptions.fineness is 6</span>
0024 <span class="comment">%  (custom).</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  BEWARE: NG_WRITE_OPT will overwrite any existing ng.opt file in the current</span>
0027 <span class="comment">%  directory.</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%  Example:</span>
0030 <span class="comment">%  ng_write_opt('meshoptions.fineness',6,'options.minmeshsize',20);</span>
0031 <span class="comment">%  call_netgen(...)</span>
0032 <span class="comment">%  delete('ng.opt'); % clean up</span>
0033 <span class="comment">%</span>
0034 <span class="comment">% To specify a volume for refinement, specify</span>
0035 <span class="comment">%  ng_write_opt('MSZPOINTS', [list of x,y,z,maxh])</span>
0036 <span class="comment">%   or</span>
0037 <span class="comment">%  ng_write_opt('MSZBRICK', [xmin, xmax, ymin, ymax, zmin, zmax, maxh])</span>
0038 <span class="comment">%   or</span>
0039 <span class="comment">%  ng_write_opt('MSZSPHERE', [xctr, yctr, zctr, radius, maxh])</span>
0040 <span class="comment">%  ng_write_opt('MSZCYLINDER', [x1, y1, z1, x2, y2, z2, radius, maxh])</span>
0041 <span class="comment">%     where (x1,y1,z1) and (x2,y2,z2) are the limits on the axis</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%  See also CALL_NETGEN</span>
0044 
0045 <span class="comment">% (C) 2012 Bartlomiej Grychtol. License: GPL version 2 or version 3</span>
0046 <span class="comment">% $Id: ng_write_opt.m 6464 2022-12-10 15:28:57Z aadler $</span>
0047 
0048 <span class="comment">%TODO:</span>
0049 <span class="comment">% 1. Check which options require meshoptions.fineness = 6 and enforce it</span>
0050 
0051 <span class="comment">% if input is 'UNIT_TEST', run tests</span>
0052 <span class="keyword">if</span> nargin == 1 &amp;&amp; ischar(varargin{1}) &amp;&amp; strcmp(varargin{1},<span class="string">'UNIT_TEST'</span>) 
0053    <a href="#_sub11" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0054 
0055 <span class="keyword">if</span> nargin == 1 &amp;&amp; ischar(varargin{1}) &amp;&amp;  exist(varargin{1},<span class="string">'file'</span>) <span class="comment">% a path</span>
0056    copyfile(varargin{1},<span class="string">'ng.opt'</span>);
0057    <span class="keyword">return</span>
0058 <span class="keyword">end</span>
0059 
0060 nargs = nargin;
0061 
0062 str = {};
0063 <span class="comment">% modify as per user input</span>
0064 <span class="keyword">if</span> nargs &gt;= 1 &amp;&amp; ischar(varargin{1}) &amp;&amp; ~any(varargin{1} == <span class="string">'.'</span>)  <span class="keyword">...</span>
0065               &amp;&amp; isempty(strfind(varargin{1},<span class="string">'MSZ'</span>))
0066    str = varargin(1);
0067    varargin(1) = [];
0068    nargs = nargs - 1;
0069 <span class="keyword">end</span>
0070 
0071 <span class="comment">% get default options</span>
0072 opt = <a href="#_sub10" class="code" title="subfunction opt = default_opt(varargin)">default_opt</a>(str{:});
0073 
0074 <span class="keyword">if</span> nargs == 0
0075     usr = struct;
0076 <span class="keyword">end</span>
0077 <span class="comment">% modify as per user input</span>
0078 <span class="keyword">if</span> nargs == 1 &amp;&amp; isstruct(varargin{1})
0079    usr = varargin{1};
0080 <span class="keyword">end</span>
0081 <span class="keyword">if</span> nargs &gt; 1 <span class="comment">% string value pairs</span>
0082    usr = <a href="#_sub1" class="code" title="subfunction opt = process_input(varargin)">process_input</a>(varargin{:}); 
0083 <span class="keyword">end</span>
0084 opt = <a href="#_sub7" class="code" title="subfunction opt = copy_field(opt,usr)">copy_field</a>(opt,usr);
0085 
0086 <span class="keyword">if</span> nargout == 1 <span class="comment">% do not write a file if output was requested</span>
0087    <span class="keyword">return</span>
0088 <span class="keyword">end</span>
0089 
0090 <span class="comment">% write the file</span>
0091 <a href="#_sub8" class="code" title="subfunction write_ng_file(opt)">write_ng_file</a>(opt);
0092 
0093 <a name="_sub1" href="#_subfunctions" class="code">function opt = process_input(varargin)</a>
0094 <span class="keyword">if</span> mod(nargin,2)~=0
0095    error(<span class="string">'EIDORS:WrongInput'</span>,<span class="string">'Even number of inputs expected'</span>);
0096 <span class="keyword">end</span>
0097 <span class="keyword">for</span> i = 1:nargin/2
0098    idx = (i-1)*2 +1;
0099    val = varargin{idx+1};
0100    <span class="keyword">switch</span> varargin{idx}
0101 <span class="comment">%  ng_write_opt('MSZPOINTS', [list of x,y,z,maxh])</span>
0102    <span class="keyword">case</span> <span class="string">'MSZPOINTS'</span>
0103     <span class="comment">%  ng_write_opt('MSZPOINTS', [list of x,y,z,maxh])</span>
0104        tmpname = <a href="#_sub6" class="code" title="subfunction fname = write_tmp_mszfile( mszpoints )">write_tmp_mszfile</a>( val );
0105        opt.options.meshsizefilename = tmpname;
0106    <span class="keyword">case</span> <span class="string">'MSZBRICK'</span>
0107        val = <a href="#_sub2" class="code" title="subfunction val = msz_brick(val)">msz_brick</a>(val);
0108        tmpname = <a href="#_sub6" class="code" title="subfunction fname = write_tmp_mszfile( mszpoints )">write_tmp_mszfile</a>( val );
0109        opt.options.meshsizefilename = tmpname;
0110    <span class="keyword">case</span> <span class="string">'MSZSPHERE'</span>
0111        val = <a href="#_sub3" class="code" title="subfunction val = msz_sphere(val)">msz_sphere</a>(val);
0112        tmpname = <a href="#_sub6" class="code" title="subfunction fname = write_tmp_mszfile( mszpoints )">write_tmp_mszfile</a>( val );
0113        opt.options.meshsizefilename = tmpname;
0114    <span class="keyword">case</span> <span class="string">'MSZCYLINDER'</span>
0115        val = <a href="#_sub5" class="code" title="subfunction val = msz_cylinder(val)">msz_cylinder</a>(val);
0116        tmpname = <a href="#_sub6" class="code" title="subfunction fname = write_tmp_mszfile( mszpoints )">write_tmp_mszfile</a>( val );
0117        opt.options.meshsizefilename = tmpname;
0118    <span class="keyword">otherwise</span>
0119        eval(sprintf(<span class="string">'opt.%s = val;'</span>,varargin{idx}));
0120    <span class="keyword">end</span>
0121 <span class="keyword">end</span>
0122 
0123 <a name="_sub2" href="#_subfunctions" class="code">function val = msz_brick(val)</a>
0124 <span class="comment">%  ng_write_opt('MSZBRICK', [xmin, xmax, ymin, ymax, zmin, zmax, maxh])</span>
0125     maxh = val(7);
0126     xpts= floor(abs(diff(val(1:2))/maxh))+1;
0127     ypts= floor(abs(diff(val(3:4))/maxh))+1;
0128     zpts= floor(abs(diff(val(5:6))/maxh))+1;
0129     xsp= linspace(val(1),val(2), xpts);
0130     ysp= linspace(val(3),val(4), ypts);
0131     zsp= linspace(val(5),val(6), zpts);
0132     [xsp,ysp,zsp] = ndgrid(xsp,ysp,zsp);
0133     val = [xsp(:),ysp(:),zsp(:), maxh+0*xsp(:)];
0134 
0135 <a name="_sub3" href="#_subfunctions" class="code">function val = msz_sphere(val)</a>
0136 <span class="comment">%  ng_write_opt('MSZSPHERE', [xctr, yctr, zctr, radius, maxh])</span>
0137     maxh = val(5);
0138     radius = val(4);
0139     npts= floor(2*radius/maxh)+1;
0140     xsp= linspace(val(1) - radius, val(1) + radius, npts);
0141     ysp= linspace(val(2) - radius, val(2) + radius, npts);
0142     zsp= linspace(val(3) - radius, val(3) + radius, npts);
0143     [xsp,ysp,zsp] = ndgrid(xsp,ysp,zsp);
0144     s_idx = ((xsp-val(1)).^2 + <span class="keyword">...</span>
0145              (ysp-val(2)).^2 + <span class="keyword">...</span>
0146              (zsp-val(3)).^2) &lt; radius^2;
0147     s_idx = s_idx(:);
0148     val = [xsp(s_idx),ysp(s_idx),zsp(s_idx), maxh+0*xsp(s_idx)];
0149 
0150 <span class="comment">% space points around zero with spacing maxh</span>
0151 <a name="_sub4" href="#_subfunctions" class="code">function pts = space_around_zero(lim,maxh);</a>
0152     pts = 0:maxh:lim;
0153     pts = [-fliplr(pts(2:end)),pts];
0154 
0155 <a name="_sub5" href="#_subfunctions" class="code">function val = msz_cylinder(val)</a>
0156     <span class="comment">% [x1, y1, z1, x2, y2, z2, radius, maxh])</span>
0157     len2= norm(val(1:3) - val(4:6))/2;
0158     ctr =     (val(1:3) + val(4:6))/2;
0159     maxh = val(8);
0160     radius = val(7);
0161     xsp= <a href="#_sub4" class="code" title="subfunction pts = space_around_zero(lim,maxh);">space_around_zero</a>(radius, maxh);
0162     ysp= <a href="#_sub4" class="code" title="subfunction pts = space_around_zero(lim,maxh);">space_around_zero</a>(radius, maxh);
0163     zsp= <a href="#_sub4" class="code" title="subfunction pts = space_around_zero(lim,maxh);">space_around_zero</a>(len2, maxh);
0164     [xsp,ysp,zsp] = ndgrid(xsp,ysp,zsp);
0165     s_idx = (xsp.^2 + ysp.^2) &lt; radius^2;
0166     xsp = xsp(s_idx(:));
0167     ysp = ysp(s_idx(:));
0168     zsp = zsp(s_idx(:));
0169 <span class="comment">% Rotate:</span>
0170 <span class="comment">% https://math.stackexchange.com/questions/180418/calculate-rotation-matrix-to-align-vector-a-to-vector-b-in-3d/897677#897677</span>
0171     ab = [0;0;2*len2] + [val(4:6)-val(1:3)]';
0172     R=2*ab*ab'/(ab'*ab) - eye(3);
0173     val = [xsp,ysp,zsp]*R + ctr;
0174     val(:,4) = maxh;
0175 
0176 <a name="_sub6" href="#_subfunctions" class="code">function fname = write_tmp_mszfile( mszpoints )</a>
0177    <span class="comment">% From Documentation: Syntax is</span>
0178    <span class="comment">% np</span>
0179    <span class="comment">% x1 y1 z1 h1</span>
0180    <span class="comment">% x2 y2 z2 h2</span>
0181    n_pts_elecs=  size(mszpoints,1);
0182    fname = [tempname,<span class="string">'.msz'</span>];
0183    fname = strrep(fname,<span class="string">'\'</span>,<span class="string">'/'</span>); <span class="comment">% needs unix-style path on windows</span>
0184    fid=fopen(fname,<span class="string">'w'</span>);
0185    fprintf(fid,<span class="string">'%d\n'</span>,n_pts_elecs);
0186 <span class="comment">%  for i = 1:size(mszpoints,1)</span>
0187 <span class="comment">%     fprintf(fid,'%10f %10f %10f %10f\n', mszpoints(i,:));</span>
0188 <span class="comment">%  end</span>
0189 <span class="comment">%  vectorize to speed up</span>
0190    fprintf(fid,<span class="string">'%10f %10f %10f %10f\n'</span>, mszpoints');
0191    fprintf(fid,<span class="string">'0\n'</span>); <span class="comment">% lines</span>
0192    fclose(fid); <span class="comment">% ptsfn</span>
0193 
0194 <span class="comment">% copy all fields from usr to opt</span>
0195 <span class="comment">% check that the fields exist in opt</span>
0196 <a name="_sub7" href="#_subfunctions" class="code">function opt = copy_field(opt,usr)</a>
0197 optnms = fieldnames(opt);
0198 usrnms = fieldnames(usr);
0199 <span class="keyword">for</span> i = 1:length(usrnms)
0200    <span class="comment">% check if field exist</span>
0201    <span class="keyword">if</span> ~ismember(usrnms{i},optnms)
0202      error(<span class="string">'Unsupported option %s'</span>,usrnms{i});
0203    <span class="keyword">end</span>
0204    <span class="keyword">if</span> isstruct(usr.(usrnms{i})) <span class="comment">% recurse</span>
0205       opt.(usrnms{i}) = <a href="#_sub7" class="code" title="subfunction opt = copy_field(opt,usr)">copy_field</a>(opt.(usrnms{i}), usr.(usrnms{i}) );
0206    <span class="keyword">else</span>
0207       opt.(usrnms{i}) = usr.(usrnms{i});
0208    <span class="keyword">end</span>
0209 <span class="keyword">end</span>
0210 
0211 
0212 <span class="comment">% write the ng.opt file</span>
0213 <a name="_sub8" href="#_subfunctions" class="code">function write_ng_file(opt)</a>
0214 fid = fopen(<span class="string">'ng.opt'</span>,<span class="string">'w'</span>);
0215 flds = fieldnames(opt);
0216 <a href="#_sub9" class="code" title="subfunction write_field(fid,s,str)">write_field</a>(fid,opt,[]);
0217 fclose(fid);
0218 
0219 
0220 <span class="comment">% recurses over fields and prints to file</span>
0221 <a name="_sub9" href="#_subfunctions" class="code">function write_field(fid,s,str)</a>
0222 <span class="keyword">if</span> isstruct(s)
0223    <span class="keyword">if</span> isempty(str)
0224       str = <span class="string">''</span>;
0225    <span class="keyword">else</span>
0226       str = [str <span class="string">'.'</span>];
0227    <span class="keyword">end</span>
0228    flds = fieldnames(s);
0229    <span class="keyword">for</span> i = 1:length(flds)
0230       <a href="#_sub9" class="code" title="subfunction write_field(fid,s,str)">write_field</a>(fid,s.(flds{i}),[str flds{i}]);
0231    <span class="keyword">end</span>
0232 <span class="keyword">elseif</span> ischar(s)
0233    fprintf(fid,<span class="string">'%s  %s\n'</span>, str, s);
0234 <span class="keyword">elseif</span> round(s) == s
0235    fprintf(fid,<span class="string">'%s  %d\n'</span>, str, s);
0236 <span class="keyword">else</span>
0237    fprintf(fid,<span class="string">'%s  %f\n'</span>, str, s);
0238 <span class="keyword">end</span>
0239 
0240 
0241 <a name="_sub10" href="#_subfunctions" class="code">function opt = default_opt(varargin)</a>
0242 <span class="keyword">if</span> nargin == 0
0243     str = <span class="string">'moderate'</span>;
0244 <span class="keyword">else</span>
0245     str = varargin{1};
0246 <span class="keyword">end</span>
0247 <span class="keyword">switch</span> str
0248     <span class="keyword">case</span> <span class="string">'very_coarse'</span>
0249         <span class="comment">% fineness 1</span>
0250         v = [6, 1.0, 0.3, 0.7, 0.25, 0.8, 0.20, 0.5, 0.25, 1.0];
0251     <span class="keyword">case</span> <span class="string">'coarse'</span>
0252         <span class="comment">% fineness 2</span>
0253         v = [6, 1.5, 0.5, 0.5, 0.50, 1.0, 0.35, 1.0, 0.50, 1.5];
0254     <span class="keyword">case</span> <span class="string">'moderate'</span>
0255         <span class="comment">% fineness 3</span>
0256         v = [6, 2.0, 1.0, 0.3, 1.00, 1.5, 0.50, 2.0, 1.00, 2.0];
0257     <span class="keyword">case</span> <span class="string">'fine'</span>
0258         <span class="comment">% fineness 4</span>
0259         v = [6, 3.0, 2.0, 0.2, 1.50, 2.0, 1.50, 3.5, 1.50, 3.0];
0260     <span class="keyword">case</span> <span class="string">'very_fine'</span>
0261         <span class="comment">% fineness 5</span>
0262         v = [6, 5.0, 3.0, 0.1, 3.00, 5.0, 3.00, 5.0, 3.00, 5.0];
0263     <span class="keyword">otherwise</span> <span class="comment">% use moderate</span>
0264         <span class="comment">% this is called if some other ng_write_opt is used, like MSZBRICK</span>
0265         v = [6, 2.0, 1.0, 0.3, 1.00, 1.5, 0.50, 2.0, 1.00, 2.0];
0266 <span class="keyword">end</span>
0267 
0268 opt.dirname = <span class="string">'.'</span>;
0269 opt.loadgeomtypevar = <span class="string">'&quot;All Geometry types (*.stl,*.stlb,*.step,*.stp,...)&quot;'</span>;
0270 opt.exportfiletype = <span class="string">'&quot;Neutral Format&quot;'</span>;
0271 opt.meshoptions.fineness = v(1);
0272 opt.meshoptions.firststep = <span class="string">'ag'</span>;
0273 opt.meshoptions.laststep = <span class="string">'ov'</span>;
0274 opt.options.localh = 1;
0275 opt.options.delaunay = 1;
0276 opt.options.checkoverlap = 1;
0277 opt.options.checkchartboundary = 1;
0278 opt.options.startinsurface = 0;
0279 opt.options.blockfill = 1;
0280 opt.options.debugmode = 0;
0281 opt.options.dooptimize = 1;
0282 opt.options.parthread = 1;
0283 opt.options.elsizeweight = 0.2;
0284 opt.options.secondorder = 0;
0285 opt.options.elementorder = 1;
0286 opt.options.quad = 0;
0287 opt.options.inverttets = 0;
0288 opt.options.inverttrigs = 0;
0289 opt.options.autozrefine = 0;
0290 opt.options.meshsize = 1000;
0291 opt.options.minmeshsize = 0;
0292 opt.options.curvaturesafety = v(2);
0293 opt.options.segmentsperedge = v(3);
0294 opt.options.meshsizefilename = <span class="string">''</span>;
0295 opt.options.badellimit = 175;
0296 opt.options.optsteps2d = 3;
0297 opt.options.optsteps3d = 5;
0298 opt.options.opterrpow = 2;
0299 opt.options.grading = v(4);
0300 opt.options.printmsg = 2;
0301 opt.geooptions.drawcsg = 1;
0302 opt.geooptions.detail = 0.001;
0303 opt.geooptions.accuracy = 1e-6;
0304 opt.geooptions.facets = 20;
0305 opt.geooptions.minx = -1000;
0306 opt.geooptions.miny = -1000;
0307 opt.geooptions.minz = -1000;
0308 opt.geooptions.maxx = 1000;
0309 opt.geooptions.maxy = 1000;
0310 opt.geooptions.maxz = 1000;
0311 opt.viewoptions.specpointvlen = 0.3;
0312 opt.viewoptions.light.amb = 0.3;
0313 opt.viewoptions.light.diff = 0.7;
0314 opt.viewoptions.light.spec = 1;
0315 opt.viewoptions.light.locviewer = 0;
0316 opt.viewoptions.mat.shininess = 50;
0317 opt.viewoptions.mat.transp = 0.3;
0318 opt.viewoptions.colormeshsize = 0;
0319 opt.viewoptions.whitebackground = 1;
0320 opt.viewoptions.drawcolorbar = 1;
0321 opt.viewoptions.drawcoordinatecross = 1;
0322 opt.viewoptions.drawnetgenlogo = 1;
0323 opt.viewoptions.stereo = 0;
0324 opt.viewoptions.drawfilledtrigs = 1;
0325 opt.viewoptions.drawedges = 0;
0326 opt.viewoptions.drawbadels = 0;
0327 opt.viewoptions.centerpoint = 0;
0328 opt.viewoptions.drawelement = 0;
0329 opt.viewoptions.drawoutline = 1;
0330 opt.viewoptions.drawtets = 0;
0331 opt.viewoptions.drawprisms = 0;
0332 opt.viewoptions.drawpyramids = 0;
0333 opt.viewoptions.drawhexes = 0;
0334 opt.viewoptions.drawidentified = 0;
0335 opt.viewoptions.drawpointnumbers = 0;
0336 opt.viewoptions.drawededges = 1;
0337 opt.viewoptions.drawedpoints = 1;
0338 opt.viewoptions.drawedpointnrs = 0;
0339 opt.viewoptions.drawedtangents = 0;
0340 opt.viewoptions.shrink = 1;
0341 opt.stloptions.showtrias = 0;
0342 opt.stloptions.showfilledtrias = 1;
0343 opt.stloptions.showedges = 1;
0344 opt.stloptions.showmarktrias = 0;
0345 opt.stloptions.showactivechart = 0;
0346 opt.stloptions.yangle = 30;
0347 opt.stloptions.contyangle = 20;
0348 opt.stloptions.edgecornerangle = 60;
0349 opt.stloptions.chartangle = 15;
0350 opt.stloptions.outerchartangle = 70;
0351 opt.stloptions.usesearchtree = 0;
0352 opt.stloptions.chartnumber = 1;
0353 opt.stloptions.charttrignumber = 1;
0354 opt.stloptions.chartnumberoffset = 0;
0355 opt.stloptions.atlasminh = 0.1;
0356 opt.stloptions.resthsurfcurvfac = v(5);
0357 opt.stloptions.resthsurfcurvenable = 0;
0358 opt.stloptions.resthatlasfac = 2;
0359 opt.stloptions.resthatlasenable = 1;
0360 opt.stloptions.resthchartdistfac = v(6);
0361 opt.stloptions.resthchartdistenable = 0;
0362 opt.stloptions.resthlinelengthfac = v(7);
0363 opt.stloptions.resthlinelengthenable = 1;
0364 opt.stloptions.resthcloseedgefac = v(8);
0365 opt.stloptions.resthcloseedgeenable = 1;
0366 opt.stloptions.resthedgeanglefac = v(9);
0367 opt.stloptions.resthedgeangleenable = 0;
0368 opt.stloptions.resthsurfmeshcurvfac = v(10);
0369 opt.stloptions.resthsurfmeshcurvenable = 0;
0370 opt.stloptions.recalchopt = 1;
0371 opt.visoptions.subdivisions = 1;
0372 
0373 <a name="_sub11" href="#_subfunctions" class="code">function do_unit_test</a>
0374    <a href="#_sub13" class="code" title="subfunction test_main_options()">test_main_options</a>()
0375    <a href="#_sub14" class="code" title="subfunction unit_test_MSZ">unit_test_MSZ</a>()
0376    <a href="#_sub12" class="code" title="subfunction test_caching()">test_caching</a>()
0377 
0378 <a name="_sub12" href="#_subfunctions" class="code">function test_caching()</a>
0379    <span class="keyword">for</span> test=0:10; <span class="keyword">switch</span> test
0380       <span class="keyword">case</span> 0; fclose(fopen(<span class="string">'ng.opt'</span>,<span class="string">'w'</span>)); <span class="comment">%exist!</span>
0381               delete(<span class="string">'ng.opt'</span>);
0382               <a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a> clear
0383               nel_ = 1599;
0384       <span class="keyword">case</span> 1; <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'moderate'</span>); <span class="comment">% default</span>
0385               nel_ = 1599;
0386       <span class="keyword">case</span> 2; <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'coarse'</span>);
0387               nel_ = 570;
0388       <span class="keyword">case</span> 3; <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'MSZCYLINDER'</span>,[0,0,.1,0,0,.2,1,0.05]);
0389               nel_ = 43861;
0390       <span class="keyword">otherwise</span>; <span class="keyword">break</span>;
0391       <span class="keyword">end</span>
0392       fmdl= <a href="ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>(1,[2,0.5],0.1);
0393       nel = <a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(fmdl);
0394       <a href="../../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(fmdl); title(sprintf(<span class="string">'Nel=%d'</span>,nel))
0395       <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(sprintf( <span class="keyword">...</span>
0396            <span class="string">'Cache: ng.opt #%d'</span>,test), nel, nel_);
0397    <span class="keyword">end</span>
0398 
0399 <a name="_sub13" href="#_subfunctions" class="code">function test_main_options()</a>
0400 opt.meshoptions.fineness = 6;
0401 <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(opt);
0402 fid = fopen(<span class="string">'ng.opt'</span>,<span class="string">'r'</span>); str= fread(fid,[1,inf],<span class="string">'uint8=&gt;char'</span>); fclose(fid);
0403 <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'fineness=6'</span>,isempty( <span class="keyword">...</span>
0404     strfind(str, <span class="string">'meshoptions.fineness  6'</span>)), 0);
0405 
0406 <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'meshoptions.fineness'</span>,4,<span class="string">'meshoptions.firststep'</span>,<span class="string">'aaa'</span>);
0407 fid = fopen(<span class="string">'ng.opt'</span>,<span class="string">'r'</span>); str= fread(fid,[1,inf],<span class="string">'uint8=&gt;char'</span>); fclose(fid);
0408 <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'firststep=aaa'</span>,isempty( <span class="keyword">...</span>
0409     strfind(str, <span class="string">'meshoptions.firststep  aaa'</span>)), 0);
0410 
0411 <span class="comment">% the last one will not be written since output was requested</span>
0412 opt = <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'meshoptions.fineness'</span>,4,<span class="string">'meshoptions.firststep'</span>,<span class="string">'bbb'</span>);
0413 fid = fopen(<span class="string">'ng.opt'</span>,<span class="string">'r'</span>); str= fread(fid,[1,inf],<span class="string">'uint8=&gt;char'</span>); fclose(fid);
0414 <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'firststep=bbb'</span>,isempty( <span class="keyword">...</span>
0415     strfind(str, <span class="string">'meshoptions.firststep  bbb'</span>)), 1);
0416 
0417 <a name="_sub14" href="#_subfunctions" class="code">function unit_test_MSZ</a>
0418    shape_str =  <span class="keyword">...</span>
0419      <span class="string">'solid mainobj = orthobrick(-9,-9,-9;9,9,9);'</span>;
0420    i=0; <span class="keyword">while</span>(true); i=i+1; <span class="keyword">switch</span> i
0421        <span class="keyword">case</span> 1; n_exp = 8;
0422            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'very_coarse'</span>);
0423        <span class="keyword">case</span> 2; n_exp = 22;
0424            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'fine'</span>);
0425        <span class="keyword">case</span> 3; n_exp = 59;
0426            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'very_fine'</span>);
0427        <span class="keyword">case</span> 4; n_exp = 8;
0428            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'moderate'</span>);
0429        <span class="keyword">case</span> 5; n_exp = 746;
0430            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'MSZSPHERE'</span>,[5,5,5,4,1]);
0431        <span class="keyword">case</span> 6; n_exp = 106;
0432            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'MSZBRICK'</span>,[5,5,5,9,9,9,1]);
0433        <span class="keyword">case</span> 7; n_exp = 544;
0434            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'MSZCYLINDER'</span>,[5,5,5,8,8,8,5,1]);
0435        <span class="keyword">case</span> 8; n_exp = 23;
0436            <a href="ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>(<span class="string">'MSZCYLINDER'</span>,[5,5,5,8,8,8,5,5]);
0437          
0438        <span class="keyword">otherwise</span>; <span class="keyword">break</span>
0439        <span class="keyword">end</span>
0440        <a href="../../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a> clear
0441        fmdl = <a href="ng_mk_gen_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_gen_models(shape_str, elec_pos,  elec_shape, elec_obj, extra_ng_code, mszpoints);">ng_mk_gen_models</a>(shape_str,[],[],<span class="string">''</span>);
0442        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'opt:'</span>, <a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(fmdl), n_exp)
0443 <span class="comment">%      show_fem(fmdl); disp(num_nodes(fmdl))</span>
0444    <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 30-Dec-2022 20:46:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>