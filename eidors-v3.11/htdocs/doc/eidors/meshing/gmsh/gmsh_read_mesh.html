<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of gmsh_read_mesh</title>
  <meta name="keywords" content="gmsh_read_mesh">
  <meta name="description" content="[srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="../index.html">meshing</a> &gt; <a href="index.html">gmsh</a> &gt; gmsh_read_mesh.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/meshing/gmsh&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>gmsh_read_mesh
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>[srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">[srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)
 Function to read in a mesh model from Gmsh and saves it in
 five arrays; surface (srf), veritices (vtx), face no. (fc)
 volume (simp) and edges (edg)

 srf        = The surfaces indices into vtx
 simp       = The volume indices into vtx
 vtx        = The vertices matrix
 fc         = A one column matrix containing the face numbers
 edg        = Edge segment information
 filename   = Name of file containing NetGen .vol information
 mat_ind    = Material index
 phys_names = Structure of &quot;Physical&quot; entities in the mesh
              .dim   = dimension
              .name  = name (string)
              .tag   = physical tag
              .nodes = N-x-dim array of indices into vtx

 This mostly works on GMSH v2. A very basic GMSH v4 reader is now
 included.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="gmsh_read_mesh.html" class="code" title="function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">gmsh_read_mesh</a>	[srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="create_circle_mesh_gmsh.html" class="code" title="function mdl = create_circle_mesh_gmsh(basename, center, rad, elem_size )">create_circle_mesh_gmsh</a>	Create a 2D Circular FEM using GMSH</li><li><a href="gmsh_mk_2d_model.html" class="code" title="function mdl = gmsh_mk_2d_model(varargin)">gmsh_mk_2d_model</a>	GMSH_MK_2D_MODEL create a 2D mesh with GMSH</li><li><a href="gmsh_mk_fwd_model.html" class="code" title="function [fwd_mdl, mat_indices]=gmsh_mk_fwd_model( vol_filename, name, eprefix,stim_pattern, z_contact)">gmsh_mk_fwd_model</a>	GMSH_MK_FWD_MODEL: create a fwd_model object from a Gmsh file</li><li><a href="gmsh_read_mesh.html" class="code" title="function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">gmsh_read_mesh</a>	[srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function mat = get_lines_with_nodes( fid, gmshformat )</a></li><li><a href="#_sub2" class="code">function gmshformat = parse_format(fid)</a></li><li><a href="#_sub3" class="code">function n_rows = parse_rows(tline, gmshformat)</a></li><li><a href="#_sub4" class="code">function names = parse_names( fid, version )</a></li><li><a href="#_sub5" class="code">function elements = parse_entities( fid, gmshformat )</a></li><li><a href="#_sub6" class="code">function entities = parse_v4_entities(fid, gmshformat)</a></li><li><a href="#_sub7" class="code">function elements = parse_elements( fid, gmshformat )</a></li><li><a href="#_sub8" class="code">function elements = parse_v4_elements(fid,tline,gmshformat)</a></li><li><a href="#_sub9" class="code">function elements = parse_v2_elements(fid,n_rows)</a></li><li><a href="#_sub10" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)</a>
0002 <span class="comment">%[srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)</span>
0003 <span class="comment">% Function to read in a mesh model from Gmsh and saves it in</span>
0004 <span class="comment">% five arrays; surface (srf), veritices (vtx), face no. (fc)</span>
0005 <span class="comment">% volume (simp) and edges (edg)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% srf        = The surfaces indices into vtx</span>
0008 <span class="comment">% simp       = The volume indices into vtx</span>
0009 <span class="comment">% vtx        = The vertices matrix</span>
0010 <span class="comment">% fc         = A one column matrix containing the face numbers</span>
0011 <span class="comment">% edg        = Edge segment information</span>
0012 <span class="comment">% filename   = Name of file containing NetGen .vol information</span>
0013 <span class="comment">% mat_ind    = Material index</span>
0014 <span class="comment">% phys_names = Structure of &quot;Physical&quot; entities in the mesh</span>
0015 <span class="comment">%              .dim   = dimension</span>
0016 <span class="comment">%              .name  = name (string)</span>
0017 <span class="comment">%              .tag   = physical tag</span>
0018 <span class="comment">%              .nodes = N-x-dim array of indices into vtx</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% This mostly works on GMSH v2. A very basic GMSH v4 reader is now</span>
0021 <span class="comment">% included.</span>
0022 
0023 <span class="comment">% $Id: gmsh_read_mesh.m 6146 2021-09-24 21:02:06Z alistair_boyle $</span>
0024 <span class="comment">% (C) 2009 Bartosz Sawicki. Licensed under GPL V2</span>
0025 <span class="comment">% Modified by James Snyder, Mark Campbell, Symon Stowe, Alistair Boyle</span>
0026 
0027 <span class="keyword">if</span> ischar(filename) &amp;&amp; strcmp(filename,<span class="string">'UNIT_TEST'</span>); <a href="#_sub10" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0028 
0029 fid = fopen(filename,<span class="string">'r'</span>);
0030 phys_names = [];
0031 entities = [];
0032 <span class="keyword">while</span> 1
0033     tline = fgetl(fid);
0034     <span class="keyword">if</span> ~ischar(tline); fclose(fid); <span class="keyword">break</span>; <span class="keyword">end</span>
0035 
0036     <span class="keyword">if</span> strcmp(tline,<span class="string">'$MeshFormat'</span>)
0037        gmshformat = <a href="#_sub2" class="code" title="subfunction gmshformat = parse_format(fid)">parse_format</a>( fid );
0038     <span class="keyword">elseif</span> strcmp(tline, <span class="string">'$Entities'</span>)
0039        entities= <a href="#_sub5" class="code" title="subfunction elements = parse_entities( fid, gmshformat )">parse_entities</a>( fid, gmshformat );
0040     <span class="keyword">elseif</span> strcmp(tline,<span class="string">'$Elements'</span>)
0041        elements= <a href="#_sub7" class="code" title="subfunction elements = parse_elements( fid, gmshformat )">parse_elements</a>( fid, gmshformat );
0042     <span class="keyword">elseif</span> strcmp(tline,<span class="string">'$Nodes'</span>)
0043        nodes= <a href="#_sub1" class="code" title="subfunction mat = get_lines_with_nodes( fid, gmshformat )">get_lines_with_nodes</a>( fid, gmshformat );
0044     <span class="keyword">elseif</span> strcmp(tline,<span class="string">'$PhysicalNames'</span>)
0045        phys_names= <a href="#_sub4" class="code" title="subfunction names = parse_names( fid, version )">parse_names</a>( fid, gmshformat );
0046     <span class="keyword">end</span>
0047 <span class="keyword">end</span>
0048 
0049 <span class="comment">% look up nodes for each of phys_names</span>
0050 <span class="keyword">if</span> ~isempty(phys_names)
0051     <span class="keyword">if</span> (gmshformat &gt;= 4.0)
0052         assert(~isempty(entities), <span class="string">'expected $Entities section (GMSH format 4)'</span>);
0053         <span class="keyword">for</span> i = 1:length(phys_names)
0054             phys_tag = phys_names(i).tag;
0055             dim = phys_names(i).dim;
0056             tmpentities = find(arrayfun(@(x) any(x.phys_tag == phys_tag), entities));
0057             tags = cat(1,entities(tmpentities).entity_tag);
0058             tmpelements = find(arrayfun(@(x) and(any(x.entity_tag == tags), (x.dim == dim)), elements));
0059             phys_names(i).nodes = cat(1,elements(tmpelements).simp);
0060             <span class="keyword">for</span> j = tmpelements(:)'
0061                 assert(length(elements(j).phys_tag) &gt; 0, <span class="keyword">...</span>
0062                     <span class="string">'GMSH format v4 mesh volume elements can only have one $PhysicalName when imported into EIDORS'</span>);
0063                 elements(j).phys_tag = phys_tag;
0064             <span class="keyword">end</span>
0065         <span class="keyword">end</span>
0066     <span class="keyword">else</span> <span class="comment">% GMSH 2.0 doesn't have Entities</span>
0067         assert(isempty(entities), <span class="string">'unexpected $Entities section (GMSH format 2)'</span>);
0068         <span class="keyword">for</span> i = 1:length(phys_names)
0069             dim = phys_names(i).dim;
0070             tag = phys_names(i).tag;
0071             tmpelements = find(arrayfun(@(x) and(any(x.phys_tag == tag), (x.dim == dim)), elements));
0072             phys_names(i).nodes = cat(1,elements(tmpelements).simp);
0073         <span class="keyword">end</span>
0074     <span class="keyword">end</span>
0075 <span class="keyword">end</span>
0076 
0077 edg = [];
0078 bc = [];
0079 mat_ind = [];
0080 
0081 <span class="comment">% Select 2d vs 3d model by checking if Z is all the same</span>
0082 <span class="keyword">if</span> length( unique( nodes(:,4) ) ) &gt; 1
0083     vtx = nodes(:,2:4);
0084     <span class="comment">% Type 2: 3-node triangle</span>
0085     tri = find(arrayfun(@(x)x.type==2,elements));
0086     <span class="comment">% Type 4: 4-node tetrahedron</span>
0087     tet = find(arrayfun(@(x)x.type==4,elements));
0088     simp = cat(1,elements(tet).simp);
0089     srf = cat(1,elements(tri).simp);
0090     mat_ind = cat(1,elements(tet).phys_tag);
0091 <span class="keyword">else</span>
0092     vtx = nodes(:,2:3);
0093     tri = find(arrayfun(@(x)x.type==2,elements));
0094     simp = cat(1,elements(tri).simp);
0095     srf = [];
0096     mat_ind = cat(1,elements(tri).phys_tag);
0097 <span class="keyword">end</span>
0098 
0099 elemtags = cat(1,elements.phys_tag);
0100 fc = elemtags(tri,1);
0101 <span class="keyword">end</span>
0102 
0103 <a name="_sub1" href="#_subfunctions" class="code">function mat = get_lines_with_nodes( fid, gmshformat )</a>
0104     tline = fgetl(fid);
0105     n_rows = <a href="#_sub3" class="code" title="subfunction n_rows = parse_rows(tline, gmshformat)">parse_rows</a>(tline,gmshformat);
0106     <span class="keyword">switch</span> floor(gmshformat)
0107     <span class="comment">% Version 2 Line Format:</span>
0108     <span class="comment">% node-number x-coord y-coord z-coord</span>
0109     <span class="comment">% Version 4 Line Format: (not always like this)</span>
0110     <span class="comment">% node-number</span>
0111     <span class="comment">% x-coord y-coord z-coord</span>
0112     <span class="keyword">case</span> 2; mat= fscanf(fid,<span class="string">'%f'</span>,[4,n_rows])';
0113     <span class="keyword">case</span> 4;
0114         n = sscanf(tline, <span class="string">'%d'</span>)';
0115         n_block = n(1);
0116         n_nodes = n(2);
0117         mat = zeros(n_nodes,4);
0118         <span class="keyword">while</span> n_block &gt; 0
0119             n_block = n_block - 1;
0120             tline = fgetl(fid);
0121             blk = sscanf(tline, <span class="string">'%d'</span>)';
0122             blk_nodes = blk(end); <span class="comment">% n(2) for v4.0, n(4) for v4.1</span>
0123             node_tag = zeros(1, blk_nodes);
0124             el = zeros(blk_nodes,3);
0125             <span class="keyword">if</span> gmshformat == 4.1 <span class="comment">% v4.1: node tags first as a block, then node coordinates in a block</span>
0126                 <span class="keyword">for</span> i = 1:blk_nodes
0127                     tline = fgetl(fid);
0128                     node_tag(i) = sscanf(tline, <span class="string">'%d'</span>)';
0129                 <span class="keyword">end</span>
0130                 <span class="keyword">for</span> i = 1:blk_nodes
0131                     tline = fgetl(fid);
0132                     el(i,:) = sscanf(tline, <span class="string">'%f'</span>)';
0133                 <span class="keyword">end</span>
0134             <span class="keyword">else</span> <span class="comment">% v4.0: node tag and coordinates on the same line</span>
0135                 <span class="keyword">for</span> i = 1:blk_nodes
0136                     tline = fgetl(fid);
0137                     data = sscanf(tline, <span class="string">'%f'</span>)';
0138                     node_tag(i) = data(1);
0139                     el(i,:) = data(2:end);
0140                 <span class="keyword">end</span>
0141                 <span class="comment">%data = fscanf(fid,'%f',[4,blk_nodes])';</span>
0142                 <span class="comment">%node_tag = data(:,1);</span>
0143                 <span class="comment">%el = data(:,2:end);</span>
0144             <span class="keyword">end</span>
0145             mat(node_tag,:) = [node_tag(:), el(:,1:end)];
0146         <span class="keyword">end</span>
0147         assert(n_block == 0, <span class="string">'failed to consume all $Nodes blocks'</span>);
0148     <span class="keyword">otherwise</span>; error(<span class="string">'cant parse gmsh file of this format'</span>);
0149     <span class="keyword">end</span>
0150 <span class="keyword">end</span>
0151 
0152 <a name="_sub2" href="#_subfunctions" class="code">function gmshformat = parse_format(fid)</a>
0153    tline = fgetl(fid);
0154    rawformat = sscanf(tline,<span class="string">'%f'</span>);
0155    tline = fgetl(fid); <span class="comment">% should be EndMeshFormat</span>
0156    gmshformat = rawformat(1);
0157 <span class="keyword">end</span>
0158 
0159 <a name="_sub3" href="#_subfunctions" class="code">function n_rows = parse_rows(tline, gmshformat)</a>
0160    n_rows = sscanf(tline,<span class="string">'%d'</span>);
0161    <span class="keyword">switch</span> floor(gmshformat)
0162      <span class="keyword">case</span> 2; n_rows = n_rows(1);
0163      <span class="keyword">case</span> 4; n_rows = n_rows(2);
0164      <span class="keyword">otherwise</span>; error(<span class="string">'cant parse gmsh file of this format'</span>);
0165    <span class="keyword">end</span>
0166 <span class="keyword">end</span>
0167 
0168 <a name="_sub4" href="#_subfunctions" class="code">function names = parse_names( fid, version )</a>
0169     <span class="comment">% Line Format:</span>
0170     <span class="comment">% physical-dimension physical-number &quot;physical-name&quot;</span>
0171     tline = fgetl(fid);
0172     n_rows = sscanf(tline,<span class="string">'%d'</span>);
0173     names = struct(<span class="string">'tag'</span>,{},<span class="string">'dim'</span>,{},<span class="string">'name'</span>,{});
0174     <span class="keyword">for</span> i = 1:n_rows
0175         tline = fgetl(fid);
0176         <span class="keyword">if</span> exist(<span class="string">'OCTAVE_VERSION'</span>)
0177             parts = strsplit(tline,<span class="string">' '</span>);
0178         <span class="keyword">else</span>
0179             parts = regexp(tline,<span class="string">' '</span>,<span class="string">'split'</span>);
0180         <span class="keyword">end</span>
0181         nsz = size(names,2)+1;
0182         names(nsz).dim = str2double( parts(1) );
0183         names(nsz).tag = str2double( parts(2) );
0184         tname = parts(3);
0185         names(nsz).name = strrep(tname{1},<span class="string">'&quot;'</span>,<span class="string">''</span>);
0186     <span class="keyword">end</span>
0187 <span class="keyword">end</span> <span class="comment">% end function</span>
0188 
0189 <a name="_sub5" href="#_subfunctions" class="code">function elements = parse_entities( fid, gmshformat )</a>
0190     elements = [];
0191     <span class="keyword">switch</span> floor(gmshformat)
0192       <span class="keyword">case</span> 2; warning(<span class="string">'ignoring $Entities$ for GMSH v2 file'</span>);
0193       <span class="keyword">case</span> 4;
0194           elements = <a href="#_sub6" class="code" title="subfunction entities = parse_v4_entities(fid, gmshformat)">parse_v4_entities</a>(fid, gmshformat);
0195       <span class="keyword">otherwise</span> error(<span class="string">'cant parse this file type'</span>);
0196     <span class="keyword">end</span>
0197  <span class="keyword">end</span>
0198 
0199 <a name="_sub6" href="#_subfunctions" class="code">function entities = parse_v4_entities(fid, gmshformat)</a>
0200 <span class="comment">% http://gmsh.info/doc/texinfo/gmsh.html#MSH-file-format</span>
0201 <span class="comment">% $Entities</span>
0202 <span class="comment">%  numPoints(size_t) numCurves(size_t)</span>
0203 <span class="comment">%    numSurfaces(size_t) numVolumes(size_t)</span>
0204 <span class="comment">%  pointTag(int) X(double) Y(double) Z(double)</span>
0205 <span class="comment">%    numPhysicalTags(size_t) physicalTag(int) ...</span>
0206 <span class="comment">%  ...</span>
0207 <span class="comment">%  curveTag(int) minX(double) minY(double) minZ(double)</span>
0208 <span class="comment">%    maxX(double) maxY(double) maxZ(double)</span>
0209 <span class="comment">%    numPhysicalTags(size_t) physicalTag(int) ...</span>
0210 <span class="comment">%    numBoundingPoints(size_t) pointTag(int) ...</span>
0211 <span class="comment">%  ...</span>
0212 <span class="comment">%  surfaceTag(int) minX(double) minY(double) minZ(double)</span>
0213 <span class="comment">%    maxX(double) maxY(double) maxZ(double)</span>
0214 <span class="comment">%    numPhysicalTags(size_t) physicalTag(int) ...</span>
0215 <span class="comment">%    numBoundingCurves(size_t) curveTag(int) ...</span>
0216 <span class="comment">%  ...</span>
0217 <span class="comment">%  volumeTag(int) minX(double) minY(double) minZ(double)</span>
0218 <span class="comment">%    maxX(double) maxY(double) maxZ(double)</span>
0219 <span class="comment">%    numPhysicalTags(size_t) physicalTag(int) ...</span>
0220 <span class="comment">%    numBoundngSurfaces(size_t) surfaceTag(int) ...</span>
0221 <span class="comment">%  ...</span>
0222 <span class="comment">% $EndEntities</span>
0223 <span class="comment">% Entities are necessary to map '$PhysicalNames' to 'entityDim' &amp; 'entityTag'</span>
0224 <span class="comment">% in $Elements and $Nodes.</span>
0225 <span class="comment">% Note that the entityTag can repeat for each type of entityDim, so when we</span>
0226 <span class="comment">% look up the elements associated with a PhysicalName we need to then use the</span>
0227 <span class="comment">% entityDim AND entityTag to find matching Nodes/Elements.</span>
0228     entities = struct(<span class="string">'phys_tag'</span>,{},<span class="string">'dim'</span>,{},<span class="string">'entity_tag'</span>,{});
0229     tline = fgetl(fid);
0230     bl = sscanf(tline, <span class="string">'%d'</span>)'; <span class="comment">% Get the line info</span>
0231     n_points = bl(1);
0232     n_curves = bl(2);
0233     n_surf = bl(3);
0234     n_vol = bl(4);
0235     <span class="comment">%fprintf('entities: %d pts, %d curves, %d surf, %d vol\n', n_points, n_curves, n_surf, n_vol);</span>
0236     tline = fgetl(fid); <span class="comment">% get the EndElements</span>
0237     <span class="keyword">while</span> ~strcmp(tline, <span class="string">'$EndEntities'</span>)
0238         bl = sscanf(tline, <span class="string">'%f'</span>)'; <span class="comment">% Get the line info</span>
0239         off = 8; <span class="comment">% offset for 'numPhysicalTags'</span>
0240         <span class="keyword">if</span> n_points &gt; 0
0241             n_points = n_points - 1;
0242             dim = 0; <span class="comment">% point</span>
0243             off = 5; <span class="comment">% offset for 'numPhysicalTags'</span>
0244         <span class="keyword">elseif</span> n_curves &gt; 0
0245             n_curves = n_curves - 1;
0246             dim = 1; <span class="comment">% line/curve</span>
0247         <span class="keyword">elseif</span> n_surf &gt; 0
0248             n_surf = n_surf - 1;
0249             dim = 2; <span class="comment">% surface</span>
0250         <span class="keyword">elseif</span> n_vol &gt; 0
0251             n_vol = n_vol - 1;
0252             dim = 3; <span class="comment">% volume</span>
0253         <span class="keyword">else</span>
0254             error(<span class="string">'extra $Entities found in v4.1 GMSH file'</span>);
0255         <span class="keyword">end</span>
0256         <span class="keyword">if</span> bl(off) &gt; 0
0257             entities(end+1).phys_tag = bl((off+1):int64(off+bl(off)));
0258             entities(end).entity_tag = int64(bl(1));
0259             entities(end).dim = dim;
0260         <span class="keyword">end</span>
0261         tline = fgetl(fid);
0262     <span class="keyword">end</span>
0263     assert(n_points == 0, <span class="string">'missing Entity/points from GMSH 4.1 file'</span>);
0264     assert(n_curves == 0, <span class="string">'missing Entity/curves from GMSH 4.1 file'</span>);
0265     assert(n_surf == 0, <span class="string">'missing Entity/surfaces from GMSH 4.1 file'</span>);
0266     assert(n_vol == 0, <span class="string">'missing Entity/volumes from GMSH 4.1 file'</span>);
0267 <span class="keyword">end</span>
0268 
0269 
0270 <a name="_sub7" href="#_subfunctions" class="code">function elements = parse_elements( fid, gmshformat )</a>
0271    tline = fgetl(fid);
0272    n_rows = <a href="#_sub3" class="code" title="subfunction n_rows = parse_rows(tline, gmshformat)">parse_rows</a>(tline,gmshformat);
0273    <span class="keyword">switch</span> floor(gmshformat)
0274      <span class="keyword">case</span> 2; elements = <a href="#_sub9" class="code" title="subfunction elements = parse_v2_elements(fid,n_rows)">parse_v2_elements</a>(fid,n_rows);
0275      <span class="keyword">case</span> 4; elements = <a href="#_sub8" class="code" title="subfunction elements = parse_v4_elements(fid,tline,gmshformat)">parse_v4_elements</a>(fid,tline,gmshformat);
0276      <span class="keyword">otherwise</span> error(<span class="string">'cant parse this file type'</span>);
0277    <span class="keyword">end</span>
0278 <span class="keyword">end</span>
0279 
0280 <a name="_sub8" href="#_subfunctions" class="code">function elements = parse_v4_elements(fid,tline,gmshformat)</a>
0281 <span class="comment">% http://gmsh.info/doc/texinfo/gmsh.html#MSH-file-format</span>
0282 <span class="comment">% $Elements</span>
0283 <span class="comment">% numEntityBlocks numElements minElementTag maxElementTag</span>
0284 <span class="comment">% ...</span>
0285 <span class="comment">% entityDim entityTag elementType numElementsInBlock</span>
0286 <span class="comment">% elementTag nodeTag ... nodeTag</span>
0287 <span class="comment">% ...</span>
0288 <span class="comment">% $EndElements</span>
0289 <span class="comment">% An entity is a node, curve, surface or volume</span>
0290 <span class="comment">% Each entity has a list of contained elements and corresponding node tags</span>
0291 <span class="comment">% 0D - 1 node tag (ignore these)</span>
0292 <span class="comment">% 1D - 2 node tags</span>
0293 <span class="comment">% 2D - 3 node tags</span>
0294 <span class="comment">% 3D - 4 node tags</span>
0295     elements = struct(<span class="string">'simp'</span>,{},<span class="string">'type'</span>,{},<span class="string">'entity_tag'</span>,{},<span class="string">'dim'</span>,{},<span class="string">'phys_tag'</span>,{});
0296     bl = sscanf(tline, <span class="string">'%d'</span>)'; <span class="comment">% Get the line info</span>
0297     n_blocks = bl(1);
0298     n_elems = bl(2);
0299     e_block = 0;
0300     tline = fgetl(fid);
0301     <span class="keyword">while</span> ~strcmp(tline, <span class="string">'$EndElements'</span>)
0302         bl = sscanf(tline, <span class="string">'%d'</span>)'; <span class="comment">% Get the line info</span>
0303         <span class="keyword">if</span> e_block == 0
0304             n_blocks = n_blocks - 1;
0305             <span class="keyword">if</span> gmshformat &gt;= 4.1
0306                 e_dim = bl(1); <span class="comment">% entityDim</span>
0307                 e_tag = bl(2); <span class="comment">% entityTag</span>
0308             <span class="keyword">else</span> <span class="comment">% 4.0</span>
0309                 e_tag = bl(1); <span class="comment">% entityTag</span>
0310                 e_dim = bl(2); <span class="comment">% entityDim</span>
0311             <span class="keyword">end</span>
0312             e_type = bl(3); <span class="comment">% elementType</span>
0313             e_block = bl(4); <span class="comment">% numElementsInBlock: Size of entity block</span>
0314         <span class="keyword">else</span>
0315             n_elems = n_elems - 1;
0316             e_block = e_block - 1;
0317             elements(bl(1)).type = e_type;
0318             elements(bl(1)).entity_tag = e_tag;
0319             elements(bl(1)).dim = e_dim;
0320             elements(bl(1)).phys_tag = 0; <span class="comment">% determined later</span>
0321             elements(bl(1)).simp = bl(2:end);
0322         <span class="keyword">end</span>
0323         tline = fgetl(fid);
0324     <span class="keyword">end</span>
0325     tline = fgetl(fid); <span class="comment">% get the EndElements</span>
0326     assert(n_elems == 0, <span class="string">'missing Elements from GMSH 4 file'</span>);
0327     assert(n_blocks == 0, <span class="string">'missing Element/blocks from GMSH 4 file'</span>);
0328 <span class="keyword">end</span>
0329 
0330 <a name="_sub9" href="#_subfunctions" class="code">function elements = parse_v2_elements(fid,n_rows)</a>
0331 <span class="comment">% Line Format:</span>
0332 <span class="comment">% elm-number elm-type number-of-tags &lt; tag &gt; ... node-number-list</span>
0333 elements(n_rows).simp = [];
0334 elements(n_rows).phys_tag = [];
0335 elements(n_rows).geom_tag = [];
0336 elements(n_rows).type = [];
0337 elements(n_rows).dim = [];
0338 
0339 <span class="keyword">for</span> i = 1:n_rows
0340     tline = fgetl(fid);
0341     n = sscanf(tline, <span class="string">'%d'</span>)';
0342     elements(i).simp = n(n(3) + 4:end);
0343     elements(i).type = n(2);
0344     <span class="keyword">if</span> n(3) &gt; 0 <span class="comment">% get tags if they exist</span>
0345         <span class="comment">% By default, first tag is number of parent physical entity</span>
0346         <span class="comment">% second is parent elementary geometrical entity</span>
0347         <span class="comment">% third is number of parent mesh partitions followed by</span>
0348         <span class="comment">% partition ids</span>
0349         tags = n(4:3+n(3));
0350         <span class="keyword">if</span> length(tags) &gt;= 1
0351             elements(i).phys_tag = tags(1);
0352             elements(i).dim = length(elements(i).simp) - 1;
0353             <span class="keyword">if</span> length(tags) &gt;= 2
0354                 elements(i).geom_tag = tags(2);
0355             <span class="keyword">end</span>
0356         <span class="keyword">end</span>
0357     <span class="keyword">end</span>
0358 <span class="keyword">end</span>
0359 <span class="keyword">end</span>
0360 
0361 <a name="_sub10" href="#_subfunctions" class="code">function do_unit_test</a>
0362    selfdir = fileparts(which(<span class="string">'gmsh_read_mesh'</span>));
0363 
0364    [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names] = <a href="gmsh_read_mesh.html" class="code" title="function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">gmsh_read_mesh</a>(fullfile(selfdir, <span class="string">'test-4.0.msh'</span>));
0365     <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'v4 vtx '</span>,vtx(2:3,:),[1,0;-1,0])
0366     <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'v4 simp'</span>,simp(2:3,:),[3,7,12; 12, 7,14]);
0367 
0368    [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names] = <a href="gmsh_read_mesh.html" class="code" title="function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">gmsh_read_mesh</a>(fullfile(selfdir, <span class="string">'test-2.2.msh'</span>));
0369     <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'v2 vtx '</span>,vtx(2:3,:),[1,0;-1,0])
0370     <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'v2 simp'</span>,simp(2:3,:),[2,4,15; 14,17,19]);
0371 
0372    vers = {<span class="string">'2.2'</span>, <span class="string">'4.0'</span>, <span class="string">'4.1'</span>};
0373    <span class="keyword">for</span> ver = vers(:)'
0374        ver = ver{1};
0375        [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names] = <span class="keyword">...</span>
0376            <a href="gmsh_read_mesh.html" class="code" title="function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">gmsh_read_mesh</a>( fullfile(selfdir, [<span class="string">'box-'</span> ver <span class="string">'.msh'</span>]) );
0377        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'2d v'</span> ver <span class="string">' vtx '</span>],vtx,[0,0;1,0;1,1;0,1;0.5,0.5])
0378        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'2d v'</span> ver <span class="string">' simp'</span>],simp,[2,5,1;1,5,4;3,5,2;,4,5,3]);
0379        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'2d v'</span> ver <span class="string">' phys'</span>],{phys_names(:).name},{<span class="string">'elec#1'</span>,<span class="string">'elec#2'</span>,<span class="string">'main'</span>});
0380 
0381        [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names] = <span class="keyword">...</span>
0382            <a href="gmsh_read_mesh.html" class="code" title="function [srf,vtx,fc,bc,simp,edg,mat_ind,phys_names,entities] = gmsh_read_mesh(filename)">gmsh_read_mesh</a>( fullfile(selfdir, [<span class="string">'cube-'</span> ver <span class="string">'.msh'</span>]) );
0383        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'3d v'</span> ver <span class="string">' vtx '</span>],vtx([1,2,13,end],:),[0,0,1;0,0,0;,0.5,0.5,0;0.5,0.5,1])
0384        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'3d v'</span> ver <span class="string">' simp'</span>],simp([1,2,23,end],:), <span class="keyword">...</span>
0385            [10,11,12,13;9,12,14,11;12,14,10,7;13,10,11,6]);
0386        <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'3d v'</span> ver <span class="string">' phys'</span>],{phys_names(:).name},{<span class="string">'elec#1'</span>,<span class="string">'elec#2'</span>,<span class="string">'main'</span>});
0387    <span class="keyword">end</span>
0388 
0389 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 30-Dec-2022 20:46:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>