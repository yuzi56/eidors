<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of stim_meas_list</title>
  <meta name="keywords" content="stim_meas_list">
  <meta name="description" content="STIM_MEAS_LIST: mk stimulation pattern from list of electrodes">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; stim_meas_list.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>stim_meas_list
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>STIM_MEAS_LIST: mk stimulation pattern from list of electrodes</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">STIM_MEAS_LIST: mk stimulation pattern from list of electrodes
 [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, amplitude, gain);
 [sp_mp]         = stim_meas_list( stim);

 stim =    EIDORS stimulation structure
     use: fwd_model.stimulation = stim;
 meas_sel =EIDORS meas_select (select all values specified)
                to form part of a fwd_model object

 sp_mp = matrix [stim+, stim-, meas+, meas-] x N_patterns

 Nelec  = Num of electrodes         DEFAULT = max sp_mp
 current= drive current levels,     DEFAULT = .010 Amp
 gain   = gain on voltage channels  DEFAULT = 1

 example: stim_meas_list([1,2,3,4; 1,2,4,5])
    create stim pattern in to elecs 1,2 with differential
    measurements on electrodes 3,4 and 4,5;
    then convert the stim struct back to a list of stim/meas pairs
  s=stim_meas_list([1,2,3,4; 1,2,4,5]);
  stim_meas_list(s)
  ans=[1,2,3,4; 1,2,4,5]</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>	MK_STIM_PATTERNS: create an EIDORS stimulation pattern structure</li><li><a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>	STIM_MEAS_LIST: mk stimulation pattern from list of electrodes</li><li><a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>	FWD_SOLVE: calculate data from a fwd_model object and an image</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/algorithms/left_divide.html" class="code" title="function [V] = left_divide(E,I,tol,~,V)">left_divide</a>	[V] = LEFT_DIVIDE(E,I,tol,pp,V);</li><li><a href="../../eidors/interface/sigmatome2_filter.html" class="code" title="function [Filter, stim_pattern]= sigmatome2_filter(test);">sigmatome2_filter</a>	SIGMATOME2_FILTER:  Hardware filter and stim_patterns for Sigmatome II device</li><li><a href="../../eidors/meshing/mat_idx_to_electrode.html" class="code" title="function [fmdl,rm_elems] = mat_idx_to_electrode(fmdl, mat_idxes)">mat_idx_to_electrode</a>	MAT_IDX_TO_ELECTRODE: create electrodes from mat_idx values</li><li><a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>	STIM_MEAS_LIST: mk stimulation pattern from list of electrodes</li><li><a href="stim_pattern_geophys.html" class="code" title="function [stim,S]= stim_pattern_geophys( n_elec, pat_type,  options )">stim_pattern_geophys</a>	STIM_PATTERN_GEOPHYS: Create Geophysical Stimulation Patterns</li><li><a href="../../eidors/solvers/forward/calc_transferimpedance.html" class="code" title="function transfimp = calc_transferimpedance( img)">calc_transferimpedance</a>	CALC_TRANSFERIMPEDANCE: Calculates transfer impedance matrix</li><li><a href="../../eidors/solvers/forward/fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="../../eidors/solvers/forward/fwd_solve_halfspace.html" class="code" title="function data = fwd_solve_halfspace(fwd_model, img)">fwd_solve_halfspace</a>	FWD_SOLVE_HALFSPACE: data = fwd_solve_halfspace(img)</li><li><a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>	JACOBIAN_ADJOINT: J= jacobian_adjoint( img )</li><li><a href="../../eidors/solvers/forward/jacobian_movement_2p5d_1st_order.html" class="code" title="function J = jacobian_movement_2p5d_1st_order( fwd_model, img)">jacobian_movement_2p5d_1st_order</a>	JACOBIAN_MOVEMENT_2P5D: J = jacobian_movement_2p5d_1st_order( img )</li><li><a href="../../eidors/solvers/forward/system_mat_fields.html" class="code" title="function FC= system_mat_fields( fwd_model )">system_mat_fields</a>	SYSTEM_MAT_FIELDS: fields (elem to nodes) fraction of system mat</li><li><a href="../../eidors/solvers/forward/system_mat_instrument.html" class="code" title="function s_mat = system_mat_instrument( img);">system_mat_instrument</a>	SYSTEM_MAT_INSTRUMENT:</li><li><a href="../../eidors/tests/test_3d_resistor.html" class="code" title="function test_3d_resistor">test_3d_resistor</a>	Create 3D model of a Rectangular resistor</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function stim_flat = flatten_stim(stim, nst, nvt)</a></li><li><a href="#_sub2" class="code">function  do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);</a>
0002 <span class="comment">%STIM_MEAS_LIST: mk stimulation pattern from list of electrodes</span>
0003 <span class="comment">% [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, amplitude, gain);</span>
0004 <span class="comment">% [sp_mp]         = stim_meas_list( stim);</span>
0005 <span class="comment">%</span>
0006 <span class="comment">% stim =    EIDORS stimulation structure</span>
0007 <span class="comment">%     use: fwd_model.stimulation = stim;</span>
0008 <span class="comment">% meas_sel =EIDORS meas_select (select all values specified)</span>
0009 <span class="comment">%                to form part of a fwd_model object</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% sp_mp = matrix [stim+, stim-, meas+, meas-] x N_patterns</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Nelec  = Num of electrodes         DEFAULT = max sp_mp</span>
0014 <span class="comment">% current= drive current levels,     DEFAULT = .010 Amp</span>
0015 <span class="comment">% gain   = gain on voltage channels  DEFAULT = 1</span>
0016 <span class="comment">%</span>
0017 <span class="comment">% example: stim_meas_list([1,2,3,4; 1,2,4,5])</span>
0018 <span class="comment">%    create stim pattern in to elecs 1,2 with differential</span>
0019 <span class="comment">%    measurements on electrodes 3,4 and 4,5;</span>
0020 <span class="comment">%    then convert the stim struct back to a list of stim/meas pairs</span>
0021 <span class="comment">%  s=stim_meas_list([1,2,3,4; 1,2,4,5]);</span>
0022 <span class="comment">%  stim_meas_list(s)</span>
0023 <span class="comment">%  ans=[1,2,3,4; 1,2,4,5]</span>
0024 
0025 <span class="comment">% (C) 2010,2015 Andy Adler, Alistair Boyle. License: GPL version 2 or version 3</span>
0026 <span class="comment">% $Id: stim_meas_list.m 5838 2018-10-23 03:33:21Z aadler $</span>
0027 
0028 <span class="keyword">if</span> ischar(sp_mp) &amp;&amp; strcmp(sp_mp,<span class="string">'UNIT_TEST'</span>); <a href="#_sub2" class="code" title="subfunction  do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0029 
0030 <span class="keyword">if</span> isstruct(sp_mp)
0031   stim = sp_mp;
0032   meas_sel = [];
0033   nst = length(stim);
0034   nvt = 0;
0035   <span class="keyword">for</span> i = 1:nst;
0036     nvt = nvt + size(stim(i).stim_pattern, 2) * size(stim(i).meas_pattern, 1);
0037   <span class="keyword">end</span>
0038   stim = <a href="#_sub1" class="code" title="subfunction stim_flat = flatten_stim(stim, nst, nvt)">flatten_stim</a>(stim, nst, nvt);
0039   stim = stim(:,[2 1 4 3]);
0040   <span class="keyword">return</span>
0041 <span class="keyword">end</span>
0042 
0043 <span class="keyword">if</span> nargin &lt;2; Nelec = max(sp_mp(:)); <span class="keyword">end</span>
0044 <span class="keyword">if</span> nargin &lt;3; current = 1;           <span class="keyword">end</span>
0045 <span class="keyword">if</span> nargin &lt;4; gain    = 1;           <span class="keyword">end</span>
0046 
0047 <span class="keyword">if</span> any(sp_mp(:) &gt; Nelec);
0048     error(<span class="string">'Electrode patterns require more electrodes than Nelec'</span>);
0049 <span class="keyword">end</span>
0050 stim = struct([]);
0051 Npat = size(sp_mp,1);
0052 is = 0;
0053 current = current.*ones(Npat,1); <span class="comment">% Extend if required</span>
0054 <span class="keyword">for</span> i=1:Npat
0055    cur = sp_mp(i,1:2);
0056    new_stim = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>( cur, 1, current(i)*[-1,1], Nelec,1);
0057    <span class="comment">% create a new stim if it isn't the same as the last one</span>
0058    <span class="keyword">if</span> (is &lt; 1) || any(any(stim(is).stim_pattern ~= new_stim))
0059      is = is + 1;
0060    <span class="keyword">end</span>
0061    stim(is).stimulation = <span class="string">'Amp'</span>;
0062    stim(is).stim_pattern = new_stim;
0063    mes = sp_mp(i,3:4);
0064    <span class="keyword">if</span> isfield(stim(is),<span class="string">'meas_pattern'</span>) <span class="comment">% append pattern if required</span>
0065      stim(is).meas_pattern = [ stim(is).meas_pattern; <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>( 1, mes, gain *  [-1,1], 1, Nelec)];
0066    <span class="keyword">else</span>
0067      stim(is).meas_pattern = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>( 1, mes, gain *  [-1,1], 1, Nelec);
0068    <span class="keyword">end</span>
0069 <span class="keyword">end</span>
0070 
0071 <span class="comment">% take in a stim/meas struct</span>
0072 <span class="comment">% return a matrix of stim/meas pairs, per row with drive current 'i' and measurement gain 'g' calculated</span>
0073 <span class="comment">% [ +s -s +m -m i g ]</span>
0074 <a name="_sub1" href="#_subfunctions" class="code">function stim_flat = flatten_stim(stim, nst, nvt)</a>
0075   stim_flat = zeros(nvt, 6);
0076   idx = 1;
0077   <span class="comment">% TODO calculate 'gain' when it matched (m+ == - m-)</span>
0078   <span class="comment">% TODO calculate 'gain' when it is unmatched (m+ ~= m-)</span>
0079   <span class="comment">% TODO calculate 'current' when it matched (s+ == - s-)</span>
0080   <span class="comment">% TODO calculate 'current' when it is unmatched (s+ ~= s-)</span>
0081   <span class="keyword">for</span> i = 1:nst
0082       nmp= size(stim(i).meas_pattern, 1); <span class="comment">% number of measurement patterns for this stim pair</span>
0083       [sp, jnk, spv]= find(stim(i).stim_pattern&gt;0);
0084       [sn, jnk, snv]= find(stim(i).stim_pattern&lt;0);      
0085       [order, mp, mpv]= find(stim(i).meas_pattern&gt;0);  
0086       [~, idx2sort] = sort(order); mp = mp(idx2sort); mpv = mpv(idx2sort);
0087       [order, mn, mnv]= find(stim(i).meas_pattern&lt;0);    
0088       [~, idx2sort] = sort(order); mn = mn(idx2sort); mnv = mnv(idx2sort);
0089       <span class="comment">% expand s+/s- to match the size of m+/m-</span>
0090       sp  = zeros(nmp,1)+sp;
0091       sn  = zeros(nmp,1)+sn;
0092       spv = zeros(nmp,1)+spv;
0093       snv = zeros(nmp,1)+snv;
0094       stim_flat(idx:idx+nmp-1,:) = <span class="keyword">...</span>
0095         [ sp sn <span class="keyword">...</span><span class="comment"> % stim pairs</span>
0096             mp mn spv mpv];  <span class="comment">% meas pairs</span>
0097       idx = idx + nmp;
0098   <span class="keyword">end</span>
0099 
0100 <a name="_sub2" href="#_subfunctions" class="code">function  do_unit_test</a>
0101    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,16);
0102    img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl);
0103    list_in = [1,2,3,4;1,2,4,5];
0104    img.fwd_model.stimulation = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(list_in,16);
0105    list_out = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(img.fwd_model.stimulation);
0106    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#1'</span>, list_in, list_out);
0107 
0108 
0109    vh = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0110    list_in = [6,7,3,4;1,2,4,5];
0111    img.fwd_model.stimulation = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(list_in,16);
0112    list_out = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(img.fwd_model.stimulation);
0113    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#2'</span>, list_in, list_out);
0114 
0115    vh = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0116    
0117    
0118    nElecs = 16;
0119    stim = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>( nElecs, 1, <span class="string">'{ad}'</span>, <span class="string">'{ad}'</span>);
0120    sp_mp = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(stim);
0121    inj_diff = mod(sp_mp(:,2) - sp_mp(:,1), nElecs);
0122    meas_diff = mod(sp_mp(:,3) - sp_mp(:,4), nElecs);
0123    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#3'</span>, true, all(inj_diff == 1) &amp;&amp; all(meas_diff == 1));
0124    
0125    stim = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>( nElecs, 1, <span class="string">'{ad}'</span>, <span class="string">'{ad}'</span>, {<span class="string">'no_meas_current'</span>, <span class="string">'no_rotate_meas'</span>});
0126    sp_mp = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(stim);
0127    inj_diff = mod(sp_mp(:,2) - sp_mp(:,1), nElecs);
0128    meas_diff = mod(sp_mp(:,3) - sp_mp(:,4), nElecs);
0129    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#4'</span>, true, all(inj_diff == 1) &amp;&amp; all(meas_diff == 1));
0130    
0131    stim = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>( nElecs, 1, <span class="string">'{ad}'</span>, <span class="string">'{ad}'</span>, {<span class="string">'no_meas_current'</span>});
0132    sp_mp = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(stim);
0133    inj_diff = mod(sp_mp(:,2) - sp_mp(:,1), nElecs);
0134    meas_diff = mod(sp_mp(:,3) - sp_mp(:,4), nElecs);
0135    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#5'</span>, true, all(inj_diff == 1) &amp;&amp; all(meas_diff == 1));
0136    
0137    Skip = 3;
0138    stim = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>( nElecs, 1, [0 1+Skip], [0 1+Skip], {<span class="string">'no_meas_current'</span>, <span class="string">'no_rotate_meas'</span>});
0139    sp_mp = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(stim);
0140    inj_diff = mod(sp_mp(:,2) - sp_mp(:,1), nElecs);
0141    meas_diff = mod(sp_mp(:,3) - sp_mp(:,4), nElecs);
0142    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#6'</span>, true, all(inj_diff == Skip+1) &amp;&amp; all(meas_diff == Skip+1));
0143    
0144    nElecs = 32;
0145    Skip = 7;
0146    stim = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>( nElecs, 1, [0 1+Skip], [0 1+Skip], {<span class="string">'meas_current'</span>, <span class="string">'rotate_meas'</span>});
0147    sp_mp = <a href="stim_meas_list.html" class="code" title="function [stim, meas_sel]= stim_meas_list( sp_mp , Nelec, current, gain);">stim_meas_list</a>(stim);
0148    inj_diff = mod(sp_mp(:,2) - sp_mp(:,1), nElecs);
0149    meas_diff = mod(sp_mp(:,3) - sp_mp(:,4), nElecs);
0150 
0151 
0152    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'pattern#7'</span>, true, all(inj_diff == Skip+1) &amp;&amp; all(meas_diff == Skip+1));
0153    
0154    
0155    
0156</pre></div>
<hr><address>Generated on Fri 30-Dec-2022 20:46:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>