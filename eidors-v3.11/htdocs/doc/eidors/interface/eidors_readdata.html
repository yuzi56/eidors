<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of eidors_readdata</title>
  <meta name="keywords" content="eidors_readdata">
  <meta name="description" content="EIDORS readdata - read data files from various EIT equipment">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">interface</a> &gt; eidors_readdata.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/interface&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>eidors_readdata
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>EIDORS readdata - read data files from various EIT equipment</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [vv, auxdata, stim]= eidors_readdata( fname, format, frame_range, extra ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> EIDORS readdata - read data files from various EIT equipment
    manufacturers

 [vv, auxdata, stim ]= eidors_readdata( fname, format, frame_range, extra )
    frame_range is the list of frames to load from the file (ie. 1:100).
    if the frames are beyond the number in the file, no data is returned
    to get all frames, use frame_range= []

 Currently the list of supported file formats is:
    - &quot;EIT&quot; Files, may be one of 
          - Draeger Pulmovista (2008+)
          - GoeIIMF/Carefusion (2010+)
          - Swisstom BB2/Pioneer (2010+)
       The function will attempt to autodetect the format
       
    - MCEIT (GoeIIMF / Viasys) &quot;get&quot; file format 
        format = &quot;GET&quot; or &quot;MCEIT&quot;
        Note that the data is &quot;untwisted&quot; to correspond to a &quot;no_rotate_meas&quot; stim pattern
    - MCEIT (GoeIIMF) &quot;get&quot; file format
        format = &quot;GET-RAW&quot;
        Data in original order, corresponds to &quot;rotate_meas&quot; stim pattern

    - Draeger (Pulmovista) &quot;EIT&quot; file format (2008+)
        format = &quot;DRAEGER-EIT&quot;

    - Draeger &quot;get&quot; file format (- 2007 - format for Draeger equipment)
        format = &quot;DRAEGER-GET&quot;

    - Swisstom EIT equipment &quot;EIT&quot; (Pioneer set and BB2):
           'LQ1' (2010 - 2011)
           'LQ2' (2013 - 2014)
           'LQ4' (2015+)

    - Dixtal file format, from Dixtal inc, Brazil
        format = 'DIXTAL_encode' extract encoder from provided Dll
           - Output: [encodepage] = eidors_readdata( path,'DIXTAL_encode');
              where path= '/path/to/Criptografa_New.dll' (provided with system)
        format = 'DIXTAL'
           - output: [vv] = eidors_readdata( fname, 'DIXTAL', [], encodepage );
    - New Carefusion &quot;EIT&quot; file format
        format = &quot;GOEIIMF-EIT&quot; or &quot;carefusion&quot;</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="eidors_readdata.html" class="code" title="function [vv, auxdata, stim]= eidors_readdata( fname, format, frame_range, extra )">eidors_readdata</a>	EIDORS readdata - read data files from various EIT equipment</li><li><a href="get_contrib_data.html" class="code" title="function p = get_contrib_data( contrib , file )">get_contrib_data</a>	GET_CONTRIB_DATA Get files from the EIDORS data_contrib repository</li><li><a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>	MK_STIM_PATTERNS: create an EIDORS stimulation pattern structure</li><li><a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload).</li><li><a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>	PROGRESS_MSG Progress messages and timing.</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="eidors_readdata.html" class="code" title="function [vv, auxdata, stim]= eidors_readdata( fname, format, frame_range, extra )">eidors_readdata</a>	EIDORS readdata - read data files from various EIT equipment</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function stim = basic_stim(N_el);</a></li><li><a href="#_sub2" class="code">function fmt = pre_proc_spec_fmt( format, fname );</a></li><li><a href="#_sub3" class="code">function df= is_get_file_a_draeger_file( fname)</a></li><li><a href="#_sub4" class="code">function df= is_eit_file_a_draeger_file( fname );</a></li><li><a href="#_sub5" class="code">function df= is_eit_file_a_swisstom_file( fname );</a></li><li><a href="#_sub6" class="code">function df = is_eit_file_a_carefusion_file( fname )</a></li><li><a href="#_sub7" class="code">function [vv, auxdata, auxtime] = carefusion_eit_readdata( fname );</a></li><li><a href="#_sub8" class="code">function [vv,curr,volt,auxdata] = draeger_get_readdata( fname );</a></li><li><a href="#_sub9" class="code">function jnk</a></li><li><a href="#_sub10" class="code">function vv = sheffield_readdata( fname );</a></li><li><a href="#_sub11" class="code">function [vv,curr,volt,auxdata,auxtime,rawdata] = mceit_readdata( fname );</a></li><li><a href="#_sub12" class="code">function array208=transfer104_208(array104),</a></li><li><a href="#_sub13" class="code">function vv= untwist(dd);</a></li><li><a href="#_sub14" class="code">function  vv = its_readdata( fname )</a></li><li><a href="#_sub15" class="code">function idx= ptr104_208;</a></li><li><a href="#_sub16" class="code">function vv = iirc_readdata( fname );</a></li><li><a href="#_sub17" class="code">function [stimulations,meas_select] = UCT_sequence_file( fname );</a></li><li><a href="#_sub18" class="code">function [cur_data,no_cur_data] = UCT_calibration_file( fname );</a></li><li><a href="#_sub19" class="code">function [v_raw] = UCT_LoadDataFrame(infilename)</a></li><li><a href="#_sub20" class="code">function [vv] = landquart1_readdata( fname );</a></li><li><a href="#_sub21" class="code">function [vv, elecImps, tStampsAbs, tStampsRel] = landquart2_readdata( fname )</a></li><li><a href="#_sub22" class="code">function [vv, evtlist, elecImps, tStampsAbs, tStampsRel, n_elec, amp, skip, extra, patPosition] = landquart4_readdata( fname )</a></li><li><a href="#_sub23" class="code">function [vv] = landquart4pre_readdata( fname )</a></li><li><a href="#_sub24" class="code">function [vv] = dixtal_read_codepage( fname );</a></li><li><a href="#_sub25" class="code">function [vv] = dixtal_read_data( file_name, frame_range, encodepage1 );</a></li><li><a href="#_sub26" class="code">function  data = proc_dixtal_data( b, encodepage );</a></li><li><a href="#_sub27" class="code">function [fr] = read_draeger_header( filename );</a></li><li><a href="#_sub28" class="code">function [vd, tstamp, event, signals, counter] = read_draeger_file(filename)</a></li><li><a href="#_sub29" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [vv, auxdata, stim]= eidors_readdata( fname, format, frame_range, extra )</a>
0002 <span class="comment">% EIDORS readdata - read data files from various EIT equipment</span>
0003 <span class="comment">%    manufacturers</span>
0004 <span class="comment">%</span>
0005 <span class="comment">% [vv, auxdata, stim ]= eidors_readdata( fname, format, frame_range, extra )</span>
0006 <span class="comment">%    frame_range is the list of frames to load from the file (ie. 1:100).</span>
0007 <span class="comment">%    if the frames are beyond the number in the file, no data is returned</span>
0008 <span class="comment">%    to get all frames, use frame_range= []</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Currently the list of supported file formats is:</span>
0011 <span class="comment">%    - &quot;EIT&quot; Files, may be one of</span>
0012 <span class="comment">%          - Draeger Pulmovista (2008+)</span>
0013 <span class="comment">%          - GoeIIMF/Carefusion (2010+)</span>
0014 <span class="comment">%          - Swisstom BB2/Pioneer (2010+)</span>
0015 <span class="comment">%       The function will attempt to autodetect the format</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%    - MCEIT (GoeIIMF / Viasys) &quot;get&quot; file format</span>
0018 <span class="comment">%        format = &quot;GET&quot; or &quot;MCEIT&quot;</span>
0019 <span class="comment">%        Note that the data is &quot;untwisted&quot; to correspond to a &quot;no_rotate_meas&quot; stim pattern</span>
0020 <span class="comment">%    - MCEIT (GoeIIMF) &quot;get&quot; file format</span>
0021 <span class="comment">%        format = &quot;GET-RAW&quot;</span>
0022 <span class="comment">%        Data in original order, corresponds to &quot;rotate_meas&quot; stim pattern</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%    - Draeger (Pulmovista) &quot;EIT&quot; file format (2008+)</span>
0025 <span class="comment">%        format = &quot;DRAEGER-EIT&quot;</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%    - Draeger &quot;get&quot; file format (- 2007 - format for Draeger equipment)</span>
0028 <span class="comment">%        format = &quot;DRAEGER-GET&quot;</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%    - Swisstom EIT equipment &quot;EIT&quot; (Pioneer set and BB2):</span>
0031 <span class="comment">%           'LQ1' (2010 - 2011)</span>
0032 <span class="comment">%           'LQ2' (2013 - 2014)</span>
0033 <span class="comment">%           'LQ4' (2015+)</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%    - Dixtal file format, from Dixtal inc, Brazil</span>
0036 <span class="comment">%        format = 'DIXTAL_encode' extract encoder from provided Dll</span>
0037 <span class="comment">%           - Output: [encodepage] = eidors_readdata( path,'DIXTAL_encode');</span>
0038 <span class="comment">%              where path= '/path/to/Criptografa_New.dll' (provided with system)</span>
0039 <span class="comment">%        format = 'DIXTAL'</span>
0040 <span class="comment">%           - output: [vv] = eidors_readdata( fname, 'DIXTAL', [], encodepage );</span>
0041 <span class="comment">%    - New Carefusion &quot;EIT&quot; file format</span>
0042 <span class="comment">%        format = &quot;GOEIIMF-EIT&quot; or &quot;carefusion&quot;</span>
0043 
0044 <span class="comment">%    - Sheffield MK I &quot;RAW&quot; file format</span>
0045 <span class="comment">%        format = &quot;RAW&quot; or &quot;sheffield&quot;</span>
0046 <span class="comment">%    - ITS (International Tomography Systems)</span>
0047 <span class="comment">%        format = &quot;ITS&quot; or &quot;p2k&quot;</span>
0048 <span class="comment">%    - IIRC (Impedance Imaging Research Center, Korea)</span>
0049 <span class="comment">%        format = &quot;txt&quot; or &quot;IIRC&quot;</span>
0050 <span class="comment">%    - University of Cape Town formats</span>
0051 <span class="comment">%        format = &quot;UCT_SEQ&quot;  UCT sequence file</span>
0052 <span class="comment">%           - Output: [ stimulation, meas_select]= eidors_readdata(fname, 'UCT_SEQ')</span>
0053 <span class="comment">%        format = &quot;UCT_CAL&quot;  UCT calibration file</span>
0054 <span class="comment">%           - Output: [vv, no_cur_caldata_raw ]= eidors_readdata( fname, 'UCT_CAL' )</span>
0055 <span class="comment">%                 where no_cur_caldata_raw is data captured with no current</span>
0056 <span class="comment">%        format = &quot;UCT_DATA&quot;  UCT data frame file</span>
0057 <span class="comment">%           - Output: [vv]= eidors_readdata( fname, 'UCT_DATA' )</span>
0058 <span class="comment">%</span>
0059 <span class="comment">% Usage</span>
0060 <span class="comment">% [vv, auxdata, stim ]= eidors_readdata( fname, format )</span>
0061 <span class="comment">%     vv      = measurements - data frames in each column</span>
0062 <span class="comment">%     auxdata = auxillary data - if provided by system</span>
0063 <span class="comment">%     stim    = stimulation structure, to be used with</span>
0064 <span class="comment">%                fwd_model.stimulation.</span>
0065 <span class="comment">%     fname = file name</span>
0066 <span class="comment">%     stim.framerate = acquisition rate (frames/sec) if available</span>
0067 <span class="comment">%</span>
0068 <span class="comment">%  if format is unspecified, an attempt to autodetect is made</span>
0069 
0070 <span class="comment">% (C) 2005-09 Andy Adler. License: GPL version 2 or version 3</span>
0071 <span class="comment">% $Id: eidors_readdata.m 6402 2022-11-02 13:01:59Z aadler $</span>
0072 
0073 <span class="comment">% TODO:</span>
0074 <span class="comment">%   - output an eidors data object</span>
0075 <span class="comment">%   - test whether file format matches specified stimulation pattern</span>
0076 <span class="comment">%   - todo MCEIT provides curr and volt on driven electrodes.</span>
0077 <span class="comment">%       how can this be provided to system?</span>
0078 
0079 <span class="keyword">if</span> nargin&gt;=1 &amp;&amp; strcmp(fname,<span class="string">'UNIT_TEST'</span>); <a href="#_sub29" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0080 
0081 <span class="keyword">if</span> ~exist(fname,<span class="string">'file'</span>)
0082    error([fname,<span class="string">' does not exist'</span>]);
0083 <span class="keyword">end</span>
0084 
0085 <span class="keyword">if</span> nargin &lt; 2
0086 <span class="comment">% unspecified file format, autodetect</span>
0087    dotpos = find(fname == <span class="string">'.'</span>);
0088    <span class="keyword">if</span> isempty( dotpos ) 
0089       error(<span class="string">'file format unspecified, can`t autodetect'</span>);
0090    <span class="keyword">else</span>
0091       dotpos= dotpos(end);
0092       format= fname( dotpos+1:end );
0093    <span class="keyword">end</span>
0094 <span class="keyword">end</span>
0095 
0096 
0097 auxdata = []; <span class="comment">% default, can be overriden if the format has it</span>
0098 fmt = <a href="#_sub2" class="code" title="subfunction fmt = pre_proc_spec_fmt( format, fname );">pre_proc_spec_fmt</a>( format, fname );
0099 <span class="keyword">switch</span> fmt
0100    <span class="keyword">case</span> <span class="string">'mceit'</span>;
0101       [vv,curr,volt,auxdata_out,auxtime,rawdata] = <a href="#_sub11" class="code" title="subfunction [vv,curr,volt,auxdata,auxtime,rawdata] = mceit_readdata( fname );">mceit_readdata</a>( fname );
0102       auxdata.auxdata = auxdata_out;
0103       auxdata.auxtime = auxtime;
0104       auxdata.curr    = curr;
0105       auxdata.volt    = volt;
0106 
0107 
0108       <span class="keyword">if</span> strcmp(lower(format),<span class="string">'get-raw'</span>)
0109           vv= rawdata(1:208,:);
0110           stim = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16,1,[0,1],[0,1], {<span class="string">'no_meas_current'</span>,<span class="string">'rotate_meas'</span>}, 1);
0111       <span class="keyword">else</span>
0112           stim = <a href="#_sub1" class="code" title="subfunction stim = basic_stim(N_el);">basic_stim</a>(16);
0113       <span class="keyword">end</span>
0114    <span class="keyword">case</span> <span class="string">'draeger-get'</span>
0115       vv = <a href="#_sub8" class="code" title="subfunction [vv,curr,volt,auxdata] = draeger_get_readdata( fname );">draeger_get_readdata</a>( fname );
0116 
0117       stim = <a href="#_sub1" class="code" title="subfunction stim = basic_stim(N_el);">basic_stim</a>(16);
0118 
0119    <span class="keyword">case</span> <span class="string">'draeger-eit'</span>
0120      [fr] = <a href="#_sub27" class="code" title="subfunction [fr] = read_draeger_header( filename );">read_draeger_header</a>( fname );
0121      <span class="comment">% Currently Draeger equipment uses this pattern with 5mA injection</span>
0122      stim = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16,1,[0,1],[0,1],{<span class="string">'rotate_meas'</span>,<span class="string">'no_meas_current'</span>},.005);
0123      [stim(:).framerate] = deal(fr);
0124      [vvOrig, tstamp, event, signals, counter] = <a href="#_sub28" class="code" title="subfunction [vd, tstamp, event, signals, counter] = read_draeger_file(filename)">read_draeger_file</a>( fname );
0125      <span class="comment">% Based on the draeger *get file converter</span>
0126      ft = [.00098242, .00019607];<span class="comment">% estimated AA: 2016-04-07</span>
0127      vv = ft(1)*vvOrig(1:208,:) - ft(2)*vvOrig(322+(1:208),:);
0128      auxdata.vv = vvOrig; <span class="comment">% the actual voltages</span>
0129      auxdata.tstamp = tstamp;
0130      auxdata.event = event;
0131      auxdata.signals = signals;
0132      <span class="comment">% Based on correlating and scaling with outputs of *.get file</span>
0133      <span class="comment">% Note that this does not 100% fit but is the best possible guess so far</span>
0134      fc = 194326.3536;
0135      auxdata.curr = vvOrig(224+(1:16), :) / fc;
0136      fv = 0.11771;
0137      auxdata.volt = 1/fv * (vvOrig(256+(1:16), :) - vvOrig(578+(1:16), :));
0138      auxdata.counter = counter;
0139 
0140    <span class="keyword">case</span> {<span class="string">'raw'</span>, <span class="string">'sheffield'</span>}
0141       vv = <a href="#_sub10" class="code" title="subfunction vv = sheffield_readdata( fname );">sheffield_readdata</a>( fname );
0142 
0143       stim = <a href="#_sub1" class="code" title="subfunction stim = basic_stim(N_el);">basic_stim</a>(16);
0144    <span class="keyword">case</span> {<span class="string">'p2k'</span>, <span class="string">'its'</span>}
0145       vv = <a href="#_sub14" class="code" title="subfunction  vv = its_readdata( fname )">its_readdata</a>( fname );
0146 
0147       stim = <span class="string">'UNKNOWN'</span>;
0148    <span class="keyword">case</span> {<span class="string">'txt'</span>,<span class="string">'iirc'</span>}
0149       vv = <a href="#_sub16" class="code" title="subfunction vv = iirc_readdata( fname );">iirc_readdata</a>( fname );
0150 
0151       stim = <a href="#_sub1" class="code" title="subfunction stim = basic_stim(N_el);">basic_stim</a>(16);
0152    <span class="keyword">case</span> <span class="string">'uct_seq'</span>
0153       [vv,auxdata] = <a href="#_sub17" class="code" title="subfunction [stimulations,meas_select] = UCT_sequence_file( fname );">UCT_sequence_file</a>( fname );
0154 
0155       stim = <span class="string">'UNKNOWN'</span>;
0156    <span class="keyword">case</span> <span class="string">'uct_cal'</span>
0157       [vv,auxdata] = <a href="#_sub18" class="code" title="subfunction [cur_data,no_cur_data] = UCT_calibration_file( fname );">UCT_calibration_file</a>( fname );
0158 
0159       stim = <span class="string">'UNKNOWN'</span>;
0160    <span class="keyword">case</span> <span class="string">'uct_data'</span>
0161       [vv] = <a href="#_sub19" class="code" title="subfunction [v_raw] = UCT_LoadDataFrame(infilename)">UCT_LoadDataFrame</a>( fname );
0162 
0163       stim = <span class="string">'UNKNOWN'</span>;
0164    <span class="keyword">case</span> {<span class="string">'carefusion'</span>,<span class="string">'goeiimf-eit'</span>}
0165       [vv, auxdata_out, auxtime] = <a href="#_sub7" class="code" title="subfunction [vv, auxdata, auxtime] = carefusion_eit_readdata( fname );">carefusion_eit_readdata</a>( fname );
0166       auxdata.auxdata = auxdata_out;
0167       auxdata.auxtime = auxtime;
0168   
0169       stim = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16,1,[0,1],[0,1], {<span class="string">'no_meas_current'</span>,<span class="string">'rotate_meas'</span>}, .005);
0170 
0171    <span class="keyword">case</span> <span class="string">'lq1'</span>
0172       [vv] = <a href="#_sub20" class="code" title="subfunction [vv] = landquart1_readdata( fname );">landquart1_readdata</a>( fname );
0173 
0174       stim = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(32,1,[0,5],[0,5],{<span class="string">'no_rotate_meas'</span>,<span class="string">'no_meas_current'</span>},.005);
0175       
0176    <span class="keyword">case</span> {<span class="string">'lq2'</span>,<span class="string">'lq3'</span>}
0177       [vv, elecImps, tStampsAbs, tStampsRel] = <a href="#_sub21" class="code" title="subfunction [vv, elecImps, tStampsAbs, tStampsRel] = landquart2_readdata( fname )">landquart2_readdata</a>( fname );
0178       auxdata.elec_impedance = elecImps;
0179       auxdata.t_abs = tStampsAbs;
0180       auxdata.t_rel = tStampsRel;
0181 
0182       stim = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(32,1,[0,5],[0,5],{<span class="string">'no_rotate_meas'</span>,<span class="string">'no_meas_current'</span>},.005);
0183      
0184    <span class="keyword">case</span> <span class="string">'lq4pre'</span>
0185       [vv] = <a href="#_sub23" class="code" title="subfunction [vv] = landquart4pre_readdata( fname )">landquart4pre_readdata</a>( fname );
0186 
0187       stim = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(32,1,[0,5],[0,5],{<span class="string">'no_rotate_meas'</span>,<span class="string">'no_meas_current'</span>},.005);
0188 
0189    <span class="keyword">case</span> <span class="string">'lq4'</span>
0190       [vv, evtlist, elecImps, tStampsAbs, tStampsRel, n_elec, amp, skip, extra, patPosition] = <a href="#_sub22" class="code" title="subfunction [vv, evtlist, elecImps, tStampsAbs, tStampsRel, n_elec, amp, skip, extra, patPosition] = landquart4_readdata( fname )">landquart4_readdata</a>( fname );
0191       auxdata.event = evtlist;
0192       auxdata.elec_impedance = elecImps;
0193       auxdata.t_abs = tStampsAbs;
0194       auxdata.t_rel = tStampsRel;
0195       auxdata.pat_position = patPosition;
0196       <span class="keyword">for</span> fn = fieldnames(extra)' <span class="comment">% copy extra's fields into auxdata</span>
0197          auxdata.(fn{1}) = extra.(fn{1});
0198       <span class="keyword">end</span>
0199 
0200       [stim, auxdata.meas_sel] = <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(n_elec,1,[0,skip+1],[0,skip+1],{<span class="string">'no_rotate_meas'</span>,<span class="string">'no_meas_current'</span>},amp);
0201       
0202    <span class="keyword">case</span> <span class="string">'dixtal_encode'</span>
0203       [vv] = <a href="#_sub24" class="code" title="subfunction [vv] = dixtal_read_codepage( fname );">dixtal_read_codepage</a>( fname );
0204       stim = <span class="string">'N/A'</span>;
0205 
0206    <span class="keyword">case</span> <span class="string">'dixtal'</span>
0207       [vv] = <a href="#_sub25" class="code" title="subfunction [vv] = dixtal_read_data( file_name, frame_range, encodepage1 );">dixtal_read_data</a>( fname, frame_range, extra );
0208       auxdata = vv(1025:<span class="keyword">end</span>,:);
0209       vv      = vv([1:1024],:);
0210       stim= <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(32,1,[0,4],[0,4], <span class="keyword">...</span><span class="comment"> </span>
0211               {<span class="string">'meas_current'</span>,<span class="string">'no_rotate_meas'</span>}, 1);
0212 
0213    <span class="keyword">otherwise</span>
0214       error(<span class="string">'eidors_readdata: file &quot;%s&quot; format unknown'</span>, format);
0215 <span class="keyword">end</span>
0216 
0217 <a name="_sub1" href="#_subfunctions" class="code">function stim = basic_stim(N_el);</a>
0218    stim= <a href="../../eidors/models/mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16,1,[0,1],[0,1], <span class="keyword">...</span><span class="comment"> \</span>
0219           {<span class="string">'no_meas_current'</span>,<span class="string">'no_rotate_meas'</span>}, 1);
0220 
0221 <a name="_sub2" href="#_subfunctions" class="code">function fmt = pre_proc_spec_fmt( format, fname );</a>
0222    fmt= lower(format);
0223    <span class="keyword">if</span> strcmp(fmt,<span class="string">'get'</span>)
0224       <span class="keyword">if</span> <a href="#_sub3" class="code" title="subfunction df= is_get_file_a_draeger_file( fname)">is_get_file_a_draeger_file</a>( fname)
0225          fmt= <span class="string">'draeger-get'</span>;
0226       <span class="keyword">else</span>
0227          fmt= <span class="string">'mceit'</span>;
0228       <span class="keyword">end</span>
0229    <span class="keyword">end</span>
0230 
0231    <span class="keyword">if</span> strcmp(fmt,<span class="string">'get-raw'</span>)
0232       fmt= <span class="string">'mceit'</span>;
0233    <span class="keyword">end</span>
0234    
0235 
0236    <span class="keyword">if</span> strcmp(fmt,<span class="string">'eit'</span>)
0237       draeger =   <a href="#_sub4" class="code" title="subfunction df= is_eit_file_a_draeger_file( fname );">is_eit_file_a_draeger_file</a>( fname );
0238       swisstom=   <a href="#_sub5" class="code" title="subfunction df= is_eit_file_a_swisstom_file( fname );">is_eit_file_a_swisstom_file</a>( fname );
0239       carefusion= <a href="#_sub6" class="code" title="subfunction df = is_eit_file_a_carefusion_file( fname )">is_eit_file_a_carefusion_file</a>( fname );
0240       <span class="keyword">if</span> carefusion
0241          <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'&quot;%s&quot; appears to be in GOEIIMF/Carefusion format'</span>,fname,3);
0242          fmt= <span class="string">'carefusion'</span>;
0243       <span class="keyword">elseif</span> draeger
0244          <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'&quot;%s&quot; appears to be in Draeger format'</span>,fname,3);
0245          fmt= <span class="string">'draeger-eit'</span>;
0246       <span class="keyword">elseif</span> swisstom
0247          fmt= sprintf(<span class="string">'lq%d'</span>,swisstom);
0248          <span class="keyword">if</span> swisstom == 3.5
0249             fmt= <span class="string">'lq4pre'</span>;
0250          <span class="keyword">end</span>
0251          <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'&quot;%s&quot; appears to be in %s format'</span>,fname,upper(fmt),3);
0252       <span class="keyword">else</span>
0253          error(<span class="string">'EIT file specified, but it doesn''t seem to be a Carefusion file'</span>)
0254       <span class="keyword">end</span>
0255    <span class="keyword">end</span>
0256 
0257 <a name="_sub3" href="#_subfunctions" class="code">function df= is_get_file_a_draeger_file( fname)</a>
0258    fid= fopen(fname,<span class="string">'rb'</span>);
0259    d= fread(fid,[1 26],<span class="string">'uchar'</span>);
0260    fclose(fid);
0261    df = all(d == <span class="string">'---Draeger EIT-Software---'</span>);
0262 
0263 <a name="_sub4" href="#_subfunctions" class="code">function df= is_eit_file_a_draeger_file( fname );</a>
0264    fid= fopen(fname,<span class="string">'rb'</span>);
0265    d= fread(fid,[1 80],<span class="string">'uchar'</span>);
0266    fclose(fid);
0267    ff = strfind(char(d), <span class="string">'---Draeger EIT-Software'</span>);
0268    <span class="keyword">if</span> ff;
0269       df = 1;
0270       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Draeger format: %s'</span>, d(ff(1)+(0:30)),4);
0271    <span class="keyword">else</span> 
0272       df = 0;
0273    <span class="keyword">end</span>
0274 
0275 <a name="_sub5" href="#_subfunctions" class="code">function df= is_eit_file_a_swisstom_file( fname );</a>
0276    fid= fopen(fname,<span class="string">'rb'</span>);
0277    d= fread(fid,[1 4],<span class="string">'uchar'</span>);
0278    fclose(fid);
0279    
0280 <span class="comment">% Note that there are two possible LQ4 formats, either with</span>
0281 <span class="comment">%     d=[0,0,0,4] or with d = [4,0,0,0]</span>
0282 <span class="comment">%  we call the first one version 3.5</span>
0283    <span class="keyword">if</span> any(d(4)==[2,3,4]) &amp;&amp; all(d([1,2,3]) == 0);
0284       df = d(4);
0285       <span class="keyword">if</span> d(4)==4; df = 3.5; <span class="keyword">end</span>
0286 <span class="comment">%     eidors_msg('Swisstom format: LQ%d', df, 4);</span>
0287    <span class="keyword">elseif</span> any(d(1:4) == [4,0,0,0])
0288       df = 4;
0289    <span class="keyword">else</span> 
0290       df = 0;
0291    <span class="keyword">end</span>
0292 
0293 <a name="_sub6" href="#_subfunctions" class="code">function df = is_eit_file_a_carefusion_file( fname )</a>
0294    fid= fopen(fname,<span class="string">'rb'</span>);
0295    d= fread(fid,[1 80],<span class="string">'uchar'</span>);
0296    fclose(fid);
0297    df = 0;
0298    <span class="keyword">if</span> d(1:2) ~= [255,254]; <span class="keyword">return</span>; <span class="keyword">end</span>
0299    <span class="keyword">if</span> d(4:2:end) ~= 0; <span class="keyword">return</span>; <span class="keyword">end</span>
0300    str= char(d(3:2:end));
0301    tests1= <span class="string">'&lt;?xml version=&quot;1.0&quot; ?&gt;'</span>;
0302    tests2= <span class="string">'&lt;EIT_File&gt;'</span>;
0303    <span class="keyword">if</span> ~any(strfind(str,tests1)); <span class="keyword">return</span>; <span class="keyword">end</span>
0304    <span class="keyword">if</span> ~any(strfind(str,tests2)); <span class="keyword">return</span>; <span class="keyword">end</span>
0305    
0306    df= 1;
0307    <span class="keyword">return</span>
0308 
0309 <a name="_sub7" href="#_subfunctions" class="code">function [vv, auxdata, auxtime] = carefusion_eit_readdata( fname );</a>
0310    fid= fopen(fname,<span class="string">'rb'</span>);
0311    d= fread(fid,[1 180],<span class="string">'uchar'</span>);
0312    str= char(d(3:2:end));
0313    outv = regexp(str,<span class="string">'&lt;Header&gt;(\d+) bytes&lt;/Header&gt;'</span>,<span class="string">'tokens'</span>);
0314    <span class="keyword">if</span> length(outv) ~=1; 
0315       error(<span class="string">'format problem reading carefusion eit files'</span>);
0316    <span class="keyword">end</span>
0317    header = str2num(outv{1}{1});
0318 
0319 <span class="comment">% NOTE: we're throwing away the header completely. This isn't</span>
0320 <span class="comment">% the 'right' way to read a file.</span>
0321 
0322    fseek(fid, header, -1); <span class="comment">% From the beginning</span>
0323    d_EIT= fread(fid,[inf],<span class="string">'float32'</span>);
0324 
0325    fseek(fid, header, -1); <span class="comment">% From the beginning</span>
0326    d_struct= fread(fid,[inf],<span class="string">'int32'</span>);  <span class="comment">% In the struct, meaning of every int: 1 Type, 2 Waveform channel No., 3 sequence No., 4 size in byte, 5 count</span>
0327    fclose(fid);
0328    pt_EIT=1;               <span class="comment">% pointer of the EIT data</span>
0329    vv=[];
0330    auxdata=[];
0331    
0332    <span class="keyword">while</span> (pt_EIT&lt;=length(d_struct))
0333       <span class="keyword">switch</span> d_struct(pt_EIT)
0334          <span class="keyword">case</span> 3, <span class="comment">% type=3,  EIT transimpedance measurement</span>
0335            <span class="comment">% d_struct(pt_EIT+2), Sequence No., start from 0</span>
0336            vv(1:256,1+d_struct(pt_EIT+2))= d_EIT(pt_EIT+6:pt_EIT+6+255);
0337            pt_EIT=pt_EIT+6+256;
0338          <span class="keyword">case</span> 7, <span class="comment">%type=7, EIT image vector</span>
0339            pt_EIT=pt_EIT+912+6;        <span class="comment">% drop the image</span>
0340          <span class="keyword">case</span> 8, <span class="comment">%type=8, Waveform data</span>
0341             aux_seg_len = d_struct(pt_EIT+3)/4*d_struct(pt_EIT+4);
0342            <span class="keyword">if</span> (d_struct(pt_EIT+1) == 0)     <span class="comment">% waveform channel 0 is the analog input</span>
0343                aux_segment = d_EIT(pt_EIT+6 : pt_EIT+6+aux_seg_len-1);
0344                auxdata = [auxdata; aux_segment];
0345            <span class="keyword">else</span>
0346                <span class="comment">% drop all other waveform channels (see Waves/Waveform in header file for what they are)</span>
0347            <span class="keyword">end</span>  
0348            pt_EIT=pt_EIT+6+aux_seg_len;           
0349          <span class="keyword">case</span> 10,<span class="comment">% type = 10, unknown type</span>
0350            <span class="comment">%drop</span>
0351            pt_EIT=pt_EIT+6+d_struct(pt_EIT+3)/4*d_struct(pt_EIT+4);
0352          <span class="keyword">otherwise</span>,
0353            <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'WARNING: unknown type in carefusion file type'</span>);
0354            pt_EIT=pt_EIT+6+d_struct(pt_EIT+3)/4*d_struct(pt_EIT+4);
0355        <span class="keyword">end</span>
0356    <span class="keyword">end</span>
0357    vv=vv(47+[1:208],:);
0358    auxtime = (cumsum([1 13*ones(1,15)])-1)/208;             <span class="comment">% relative time as fractions of the EIT frame: assuming uniform sampling - not sure this is 100% correct(!)</span>
0359    auxtime = reshape(repmat(1:size(vv,2), length(auxtime), 1),[],1) + repmat(auxtime, 1, size(vv,2))';
0360    
0361 
0362 <span class="comment">% Read the old &lt;2006 Draeger &quot;get&quot; file format</span>
0363 <a name="_sub8" href="#_subfunctions" class="code">function [vv,curr,volt,auxdata] = draeger_get_readdata( fname );</a>
0364    fid= fopen(fname,<span class="string">'rb'</span>);
0365    emptyctr=0;
0366    <span class="keyword">while</span> emptyctr&lt;2
0367      line= fgetl(fid);
0368      <span class="keyword">if</span> isempty(line)
0369         emptyctr= emptyctr+1;
0370      <span class="keyword">else</span>
0371         <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'data not understood'</span>,0);
0372         emptyctr=0;
0373      <span class="keyword">end</span>
0374    <span class="keyword">end</span>
0375    d= fread(fid,inf,<span class="string">'float'</span>,0,<span class="string">'ieee-le'</span>);
0376    fclose(fid);
0377 
0378    <span class="keyword">if</span> rem( length(d), 256) ~=0
0379       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'File length strange - cropping file'</span>,0);
0380       d=d(1:floor(length(d)/256)*256);
0381    <span class="keyword">end</span>
0382 
0383    dd= reshape( d, 256, length(d)/256);
0384    vv= <a href="#_sub13" class="code" title="subfunction vv= untwist(dd);">untwist</a>(dd);
0385 
0386    curr=0.00512*dd(209:224,:);  <span class="comment">% Amps</span>
0387    volt=12*dd(225:240,:); <span class="comment">%Vrms</span>
0388    auxdata= dd(241:255,:);
0389    auxdata= auxdata(:);
0390     
0391 <a name="_sub9" href="#_subfunctions" class="code">function jnk</a>
0392 <span class="comment">%[adler@adler01 sept07]$ xxd Sch_Pneumoperitoneum_01_001.get | head -30</span>
0393 <span class="comment">%0000000: 2d2d 2d44 7261 6567 6572 2045 4954 2d53  ---Draeger EIT-S</span>
0394 <span class="comment">%0000010: 6f66 7477 6172 652d 2d2d 0d0a 2d2d 2d50  oftware---..---P</span>
0395 <span class="comment">%0000020: 726f 746f 636f 6c20 4461 7461 2d2d 2d2d  rotocol Data----</span>
0396 <span class="comment">%0000030: 2d0d 0a0d 0a44 6174 653a 2020 3138 2d30  -....Date:  18-0</span>
0397 <span class="comment">%0000040: 322d 3230 3034 0d0a 5469 6d65 3a20 2031  2-2004..Time:  1</span>
0398 <span class="comment">%0000050: 333a 3138 2050 4d0d 0a0d 0a46 696c 656e  3:18 PM....Filen</span>
0399 <span class="comment">%0000060: 616d 653a 2020 2020 2020 2020 2053 6368  ame:         Sch</span>
0400 <span class="comment">%0000070: 5f50 6e65 756d 6f70 6572 6974 6f6e 6575  _Pneumoperitoneu</span>
0401 <span class="comment">%0000080: 6d5f 3031 5f30 3031 2e67 6574 0d0a 4453  m_01_001.get..DS</span>
0402 <span class="comment">%0000090: 5020 5365 7269 616c 204e 722e 3a20 2020  P Serial Nr.:</span>
0403 <span class="comment">%00000a0: 4549 5430 322f 3035 2f30 3030 360d 0a0d  EIT02/05/0006...</span>
0404 <span class="comment">%00000b0: 0a46 7265 7175 656e 6379 205b 487a 5d3a  .Frequency [Hz]:</span>
0405 <span class="comment">%00000c0: 2020 2020 3937 3635 362e 330d 0a47 6169      97656.3..Gai</span>
0406 <span class="comment">%00000d0: 6e3a 2020 2020 2020 2020 2020 2020 2020  n:</span>
0407 <span class="comment">%00000e0: 2020 2031 3134 350d 0a41 6d70 6c69 7475     1145..Amplitu</span>
0408 <span class="comment">%00000f0: 6465 3a20 2020 2020 2020 2020 2020 2031  de:            1</span>
0409 <span class="comment">%0000100: 3030 300d 0a53 616d 706c 6520 5261 7465  000..Sample Rate</span>
0410 <span class="comment">%0000110: 205b 6b48 7a5d 3a20 2020 2035 3030 300d   [kHz]:    5000.</span>
0411 <span class="comment">%0000120: 0a50 6572 696f 6473 3a20 2020 2020 2020  .Periods:</span>
0412 <span class="comment">%0000130: 2020 2020 2020 2020 2032 300d 0a46 7261           20..Fra</span>
0413 <span class="comment">%0000140: 6d65 733a 2020 2020 2020 2020 2020 2020  mes:</span>
0414 <span class="comment">%0000150: 2020 2020 2031 300d 0a0d 0a0d 0a</span>
0415 <span class="comment">%                                       8bc33e       10........&gt;</span>
0416 <span class="comment">%0000160: 3f 0548633e bf20933d e192393d a568ea  ?.Hc&gt;. .=..9=.h.</span>
0417 <span class="comment">%0000170: 3c 2530f63c 27e6043d 2043ad3c 25ce93  &lt;%0.&lt;'..= C.&lt;%..</span>
0418 <span class="comment">%0000180: 3c aebcce3c 8714643d e3533d3e 65b6e1  &lt;...&lt;..d=.S=&gt;e..</span>
0419 <span class="comment">%0000190: 3e 7a62103f 81c4143e 8c99813d 35921d  &gt;zb.?...&gt;...=5..</span>
0420 <span class="comment">%00001a0: 3d 8e6b0d3d 690cf93c 9910713c 3c9289  =.k.=i..&lt;..q&lt;&lt;..</span>
0421 <span class="comment">%00001b0: 3c f6736f3c 2291453d ad1cab3d 386f15  &lt;.so&lt;&quot;.E=...=8o.</span>
0422 <span class="comment">%00001c0: 3e e82a143f 2a952e3f f568493e f08a8c  &gt;.*.?*..?.hI&gt;...</span>
0423 <span class="comment">%00001d0: 3d e43e0e3d 7040253d 19f4af3c 67fd93  =.&gt;.=p@%=...&lt;g..</span>
0424 
0425 <a name="_sub10" href="#_subfunctions" class="code">function vv = sheffield_readdata( fname );</a>
0426    fid=fopen(fname,<span class="string">'rb'</span>,<span class="string">'ieee-le'</span>);
0427    draw=fread(fid,[104,inf],<span class="string">'float32'</span>);
0428    fclose(fid);
0429    ldat = size(draw,2);
0430 
0431    [x,y]= meshgrid( 1:16, 1:16);
0432    idxm= y-x;
0433  <span class="comment">% HW gain table</span>
0434    gtbl = [0,849,213,87,45,28,21,19,21,28,45,87,213,849,0];
0435    idxm(idxm&lt;=0)= 1;
0436    idxm= gtbl(idxm);
0437 
0438  <span class="comment">% Multiply by gains</span>
0439    draw = draw .* (idxm(idxm&gt;0) * ones(1,ldat)); 
0440 
0441    vv= zeros(16*16, size(draw,2));
0442    vv(find(idxm),:) = draw;
0443 
0444  <span class="comment">% Add reciprocal measurements</span>
0445    vv= reshape(vv,[16,16,ldat]);
0446    vv= vv + permute( vv, [2,1,3]);
0447    vv= reshape(vv,[16*16,ldat]);
0448 
0449    
0450 
0451 <a name="_sub11" href="#_subfunctions" class="code">function [vv,curr,volt,auxdata,auxtime,rawdata] = mceit_readdata( fname );</a>
0452 
0453    fid= fopen(fname,<span class="string">'rb'</span>);
0454    d= fread(fid,inf,<span class="string">'float'</span>);
0455    fclose(fid);
0456 
0457    <span class="keyword">if</span> rem( length(d), 256) ~=0
0458       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'File length strange - cropping file'</span>,0);
0459       d=d(1:floor(length(d)/256)*256);
0460    <span class="keyword">end</span>
0461 
0462    dd= reshape( d, 256, length(d)/256);
0463    rawdata = dd;
0464    no_reciprocity = (dd(39,1)==0);      <span class="comment">%104 measurements per frame</span>
0465    <span class="keyword">if</span> no_reciprocity
0466        dd=<a href="#_sub12" class="code" title="subfunction array208=transfer104_208(array104),">transfer104_208</a>(dd);
0467    <span class="keyword">end</span>
0468    vv= <a href="#_sub13" class="code" title="subfunction vv= untwist(dd);">untwist</a>(dd);
0469 
0470    curr=0.00512*dd(209:224,:);  <span class="comment">% Amps</span>
0471    volt=12*dd(225:240,:); <span class="comment">%Vrms</span>
0472    auxdata= dd(241:256,:);
0473    auxdata= auxdata(:);
0474    <span class="comment">%input impedance=voltage./current-440;        Ohm</span>
0475    
0476    <span class="keyword">if</span> no_reciprocity
0477      <span class="comment">% remove every 14th, 15th and 16th sample as they are always zero</span>
0478      auxdata(14:16:end) = []; auxdata(14:15:end) = []; auxdata(14:14:end) = [];
0479      <span class="comment">% only 104 measurements were performed with NON-UNIFORM sampling of AUX in between EIT samples</span>
0480      <span class="comment">% Sampling procedure was thought to be: 13 AUX1 13 AUX2 12 AUX3 11 AUX4 10 AUX5 9 ... 2 AUX13 1 [END OF FRAME]</span>
0481 <span class="comment">%      auxtime = (cumsum([1 13 12:-1:2]) - 1) / 104;</span>
0482      <span class="comment">% However, this seems to be a little different, finally the sampling points were determined</span>
0483      <span class="comment">% empirically by measuring a sawtooth signal (linear ramp) and fitting the timings</span>
0484      auxtime = [0.0000,0.1390,0.2535,0.3617,0.4642,0.5486,0.6367,0.7110,0.7780,0.8354,0.8865,0.9304,0.9711];  <span class="comment">% mean fit at 25 Hz</span>
0485 <span class="comment">%      auxtime = [0.0000,0.1460,0.2789,0.3895,0.4875,0.5788,0.6608,0.7356,0.7986,0.8569,0.9045,0.9454,0.9824,]; % mean fit at 44 Hz</span>
0486    <span class="keyword">else</span>
0487      <span class="comment">% all 208 measurements were performed</span>
0488      auxtime = (cumsum([1 13*ones(1,15)])-1)/208;             <span class="comment">% relative time as fractions of the EIT frame</span>
0489    <span class="keyword">end</span>
0490    <span class="comment">% time of AUX signal relative to frame number (starting with 1 - Matlab style)</span>
0491    auxtime = reshape(repmat(1:size(dd,2), length(auxtime), 1),[],1) + repmat(auxtime, 1, size(dd,2))';
0492    
0493 
0494 <a name="_sub12" href="#_subfunctions" class="code">function array208=transfer104_208(array104),</a>
0495 <span class="comment">% The order in the 208-vector is</span>
0496 <span class="comment">% Index   Inject    Measure Pair</span>
0497 <span class="comment">% 1         1-2        3-4        (alternate pair is 3-4, 1-2, at location 39)</span>
0498 <span class="comment">% 2         1-2        4-5</span>
0499 <span class="comment">% 3         1-2        5-6</span>
0500 <span class="comment">% ¡­</span>
0501 <span class="comment">% 13        1-2        15-16</span>
0502 <span class="comment">% 14        2-3        4-5</span>
0503 <span class="comment">% 15        2-3        5-6</span>
0504 <span class="comment">% ¡­</span>
0505 <span class="comment">% 26        2-3        16-1</span>
0506 <span class="comment">% 27        3-4        5-6</span>
0507 <span class="comment">% ¡­</span>
0508 <span class="comment">% 39        3-4        1-2</span>
0509 <span class="comment">% 40        4-5        6-7</span>
0510 <span class="comment">% ¡­</span>
0511 
0512 ind=[39,51,63,75,87,99,111,123,135,147,159,171,183,52,64,76, <span class="keyword">...</span>
0513      88,100,112,124,136,148,160,172,184,196,65,77,89,101,113, <span class="keyword">...</span>
0514      125,137,149,161,173,185,197,78,90,102,114,126,138,150,162, <span class="keyword">...</span>
0515      174,186,198,91,103,115,127,139,151,163,175,187,199,104,116, <span class="keyword">...</span>
0516      128,140,152,164,176,188,200,117,129,141,153,165,177,189, <span class="keyword">...</span>
0517      201,130,142,154,166,178,190,202,143,155,167,179,191,203, <span class="keyword">...</span>
0518      156,168,180,192,204,169,181,193,205,182,194,206,195,207,208];
0519 ro=[1:13, 14:26, 27:38, 40:50, 53:62, 66:74, 79:86, 92:98, <span class="keyword">...</span>
0520     105:110,118:122,131:134,144:146,157:158,170:170];
0521 
0522 [x,y]=size(array104);
0523 <span class="keyword">if</span> x~=256 &amp;&amp; y~=256,
0524     <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>([<span class="string">'eidors_readdata: expectingin an input array '</span>, <span class="keyword">...</span>
0525                 <span class="string">'of size 208*n'</span>]);
0526     <span class="keyword">return</span>;
0527 <span class="keyword">elseif</span> y==256,
0528     array104=array104';
0529     y=x;
0530 <span class="keyword">end</span>
0531 array208=array104;
0532 <span class="keyword">for</span> i=1:y,
0533     array208(ind,i)=array104(ro,i);    
0534 <span class="keyword">end</span>
0535    
0536 
0537 <span class="comment">% measurements rotate with stimulation, we untwist them</span>
0538 <a name="_sub13" href="#_subfunctions" class="code">function vv= untwist(dd);</a>
0539    elec=16;
0540    pos_i= [0,1];
0541    ELS= rem(rem(0:elec^2-1,elec) - <span class="keyword">...</span>
0542         floor((0:elec^2-1)/elec)+elec,elec)';
0543    ELS=~any(rem( elec+[-1 0 [-1 0]+pos_i*[-1;1] ] ,elec)' <span class="keyword">...</span>
0544         *ones(1,elec^2)==ones(4,1)*ELS')';
0545    twist= [               0+(1:13), <span class="keyword">...</span>
0546                          13+(1:13), <span class="keyword">...</span>
0547            39-(0:-1:0),  26+(1:12), <span class="keyword">...</span>
0548            52-(1:-1:0),  39+(1:11), <span class="keyword">...</span>
0549            65-(2:-1:0),  52+(1:10), <span class="keyword">...</span>
0550            78-(3:-1:0),  65+(1: 9), <span class="keyword">...</span>
0551            91-(4:-1:0),  78+(1: 8), <span class="keyword">...</span>
0552           104-(5:-1:0),  91+(1: 7), <span class="keyword">...</span>
0553           117-(6:-1:0), 104+(1: 6), <span class="keyword">...</span>
0554           130-(7:-1:0), 117+(1: 5), <span class="keyword">...</span>
0555           143-(8:-1:0), 130+(1: 4), <span class="keyword">...</span>
0556           156-(9:-1:0), 143+(1: 3), <span class="keyword">...</span>
0557           169-(10:-1:0),156+(1: 2), <span class="keyword">...</span>
0558           182-(11:-1:0),169+(1: 1), <span class="keyword">...</span>
0559           195-(12:-1:0), <span class="keyword">...</span>
0560           208-(12:-1:0) ];
0561     vv= zeros(256,size(dd,2));
0562     vv(ELS,:)= dd(twist,:);
0563    <span class="comment">%vv= dd(1:208,:);</span>
0564 
0565 <span class="comment">% Read data from p2k files (I T S system)</span>
0566 <span class="comment">% FIXME: this code is very rough, it works for</span>
0567 <span class="comment">%   only eight ring data records</span>
0568 <a name="_sub14" href="#_subfunctions" class="code">function  vv = its_readdata( fname ) </a>
0569    fid= fopen( fname, <span class="string">'rb'</span>, <span class="string">'ieee-le'</span>);
0570    vv=[];
0571 
0572    <span class="comment">% don't know how to interpret header</span>
0573    header= fread(fid, 880, <span class="string">'uchar'</span>);
0574    frameno= 0;
0575    rings= 8;
0576    <span class="keyword">while</span>( ~feof(fid) )
0577        frameno= frameno+1;
0578        <span class="comment">% don't know how to interpret frame header</span>
0579        framehdr= fread(fid, 40);
0580        data= fread(fid, 104*rings, <span class="string">'double'</span>);
0581        vv= [vv, data];
0582    <span class="keyword">end</span>
0583 
0584    <span class="keyword">if</span> 0 <span class="comment">% convert a ring to 208</span>
0585       ringno= 1;
0586       ld= size(vv,2);
0587       vx= [zeros(1,ld);vv( ringno*104 + (-103:0) ,: )];
0588       idx= ptr104_208;
0589       vv= vx(idx+1,:);
0590    <span class="keyword">end</span>
0591 
0592 <span class="comment">% pointer to convert from 104 to 208 meas patterns</span>
0593 <a name="_sub15" href="#_subfunctions" class="code">function idx= ptr104_208;</a>
0594     idx= zeros(16);
0595     idx(1,:)= [0,0,1:13,0];
0596     ofs= 13;
0597     <span class="keyword">for</span> i= 2:14
0598         mm= 15-i;
0599         idx(i,:) = [zeros(1,i+1), (1:mm)+ofs ];
0600         ofs= ofs+ mm;
0601     <span class="keyword">end</span>
0602 
0603     idx= idx + idx';
0604     
0605 <a name="_sub16" href="#_subfunctions" class="code">function vv = iirc_readdata( fname );</a>
0606     fid= fopen( fname, <span class="string">'r'</span>);
0607     <span class="keyword">while</span> ~feof(fid)
0608        line = fgetl(fid);
0609        <span class="keyword">if</span> isempty(line)
0610            <span class="keyword">continue</span>;
0611        <span class="keyword">end</span>
0612        
0613        num= regexp(line,<span class="string">'Channel : (\d+)'</span>);
0614        <span class="keyword">if</span> ~isempty(num)
0615            channels= str2num( line(num(1):end ) );
0616            <span class="keyword">continue</span>;
0617        <span class="keyword">end</span>
0618        
0619        num= regexp(line,<span class="string">'Frequency : (\d+)kHz'</span>);
0620        <span class="keyword">if</span> ~isempty(num)
0621            freqency= str2num( line(num(1):end ) );
0622            <span class="keyword">continue</span>;
0623        <span class="keyword">end</span>
0624 
0625        num= regexp(line,<span class="string">'Scan Method : (\w+)'</span>);
0626        <span class="keyword">if</span> ~isempty(num)
0627            scan_method=  line(num(1):end );
0628            <span class="keyword">continue</span>;
0629        <span class="keyword">end</span>
0630 
0631        num= regexp(line,<span class="string">'Study : (\w+)'</span>);
0632        <span class="keyword">if</span> ~isempty(num)
0633            study=  line(num(1):end);
0634            <span class="keyword">continue</span>;
0635        <span class="keyword">end</span>
0636            
0637        <span class="keyword">if</span> strcmp(line,<span class="string">'Data'</span>);
0638            data= fscanf(fid,<span class="string">'%f'</span>,[4,inf])';
0639            <span class="keyword">continue</span>;
0640        <span class="keyword">end</span>
0641     <span class="keyword">end</span>
0642     vv= data(:,1) + 1i*data(:,2);
0643     <span class="keyword">if</span> length(vv) ~= channels^2
0644         error(<span class="string">'eidors_readdata: data length wrong'</span>)
0645     <span class="keyword">end</span>
0646 
0647 <span class="comment">% stimulation is the fwd_model stimulation data structure</span>
0648 <span class="comment">% meas_select indicates if data is NOT measures on current electrode</span>
0649 <a name="_sub17" href="#_subfunctions" class="code">function [stimulations,meas_select] = UCT_sequence_file( fname );</a>
0650    <span class="comment">% (c) Tim Long</span>
0651    <span class="comment">% 21 January 2005</span>
0652    <span class="comment">% University of Cape Town</span>
0653 
0654 
0655    <span class="comment">% open the file</span>
0656    fid = fopen(fname, <span class="string">'rt'</span>);
0657 
0658    <span class="comment">% check to see if file opened ok</span>
0659    <span class="keyword">if</span> fid == -1
0660          errordlg(<span class="string">'File not found'</span>,<span class="string">'ERROR'</span>)  
0661          <span class="keyword">return</span>;
0662    <span class="keyword">end</span>
0663 
0664 
0665    tline = fgetl(fid);             <span class="comment">% get the spacer at top of text file</span>
0666 
0667    <span class="comment">% the measurement and injection pattern is stored as follows:</span>
0668    <span class="comment">% I1V1:  db #$00,#$0F,#$00,#$00,#$10,#$00,#$00,#$21,#$00 ...</span>
0669    <span class="comment">% I2V2:  db #$11,#$0F,#$11,#$11,#$10,#$11,#$11,#$21,#$11 ...</span>
0670    <span class="comment">% etc</span>
0671    <span class="comment">% need to put all the bytes in a vector</span>
0672 
0673    <span class="comment">% tokenlist will store the list of bytes as strings</span>
0674    tokenlist = [];
0675 
0676 
0677    tline = fgetl(fid);             <span class="comment">% get first line of data</span>
0678 
0679    <span class="keyword">while</span> length(tline) ~= 0
0680        
0681        <span class="comment">% the first few characters in the line are junk</span>
0682        rem = tline(11:end);            <span class="comment">% extract only useful data</span>
0683        
0684        <span class="comment">% extract each byte</span>
0685        <span class="keyword">while</span> length(rem) ~=0
0686            [token, rem] = strtok(rem, <span class="string">','</span>);
0687            tokenlist = [tokenlist; token];
0688        <span class="keyword">end</span>
0689        
0690        <span class="comment">% get the next line in sequence file</span>
0691        tline = fgetl(fid);
0692    <span class="keyword">end</span>
0693 
0694    fclose(fid);
0695 
0696    <span class="comment">% got everything in string form... need to covert to number format</span>
0697 
0698    drive_lay = [];
0699    drive_elec = [];
0700    sense_lay = [];
0701 
0702    injection_no = 1;
0703    <span class="comment">% for each injection</span>
0704    <span class="keyword">for</span> i=1:3:length(tokenlist)
0705        
0706        <span class="comment">% get injection layer</span>
0707        tsource_layer = tokenlist(i,3);
0708        tsink_layer = tokenlist(i,4);
0709        source_layer = sscanf(tsource_layer, <span class="string">'%x'</span>);
0710        sink_layer = sscanf(tsink_layer, <span class="string">'%x'</span>);
0711        
0712        drive_lay = [drive_lay; [source_layer sink_layer]];
0713          
0714        
0715        <span class="comment">% get drive pair</span>
0716        tsource_elec = tokenlist(i+1,3);
0717        tsink_elec = tokenlist(i+1,4);
0718        source_elec = sscanf(tsource_elec, <span class="string">'%x'</span>);
0719        sink_elec = sscanf(tsink_elec, <span class="string">'%x'</span>);
0720        
0721        drive_elec = [drive_elec; [source_elec sink_elec]];
0722        
0723        
0724        <span class="comment">% get sense layer pair</span>
0725        tpos_layer = tokenlist(i+2,3);
0726        tneg_layer = tokenlist(i+2,4);
0727        pos_sense_layer = sscanf(tpos_layer, <span class="string">'%x'</span>);
0728        neg_sense_layer = sscanf(tneg_layer, <span class="string">'%x'</span>);
0729        
0730        sense_lay = [sense_lay; [pos_sense_layer neg_sense_layer]];
0731    <span class="keyword">end</span>
0732 
0733    n_elec = size(sense_lay,1);
0734    n_inj  = size(drive_lay,1);       <span class="comment">% every injection</span>
0735    elecs_per_plane = 16; <span class="comment">% FIXED FOR THE UCT DEVICE</span>
0736    raw_index = 0;
0737    meas_select = [];
0738 
0739    <span class="keyword">for</span> i=1:n_inj      <span class="comment">% for every injection</span>
0740        stimulations(i).stimulation= <span class="string">'mA'</span>;
0741        
0742        <span class="comment">% find the injection electrodes</span>
0743        e_inj_p = drive_lay(i, 1) * elecs_per_plane + drive_elec(i,1) + 1;
0744        e_inj_n = drive_lay(i, 2) * elecs_per_plane + drive_elec(i,2) + 1;
0745 
0746        <span class="comment">% create the stimulation pattern for this injection</span>
0747        inj = zeros(n_elec, 1);
0748        inj(e_inj_p) = 1;
0749        inj(e_inj_n) = -1;
0750        stimulations(i).stim_pattern = inj;
0751      
0752        <span class="comment">% the UCT instrument always makes 16 measurements per injection.</span>
0753        <span class="comment">% the +ve and -ve electrodes are always adjacent, but might be on</span>
0754        <span class="comment">% different planes</span>
0755        meas_pat = [];
0756        <span class="keyword">for</span> e = 0:15
0757            raw_index = raw_index + 1;
0758            meas = zeros(1, n_elec);   <span class="comment">% the measurement electrodes for this sample</span>
0759 
0760            <span class="comment">% find the measurement electrodes for this measurement (+ve elec is</span>
0761            <span class="comment">% next to -ve electrode)</span>
0762            e_meas_p = sense_lay(i,1) * elecs_per_plane + mod(e+1,elecs_per_plane) + 1;
0763            e_meas_n = sense_lay(i,2) * elecs_per_plane + e + 1;
0764 
0765            <span class="comment">% if either of the drive electrodes are equal to any of the sense</span>
0766            <span class="comment">% electrodes, we must not include this sample</span>
0767            <span class="keyword">if</span> any( e_meas_p == [e_inj_p, e_inj_n] ) | <span class="keyword">...</span>
0768               any( e_meas_n == [e_inj_p, e_inj_n] ) 
0769                <span class="keyword">continue</span>;
0770            <span class="keyword">end</span>
0771 
0772            meas(e_meas_p) = -1;
0773            meas(e_meas_n) = 1;
0774            meas_select = [meas_select;raw_index];
0775            
0776            <span class="comment">% add this measurement to the measurement pattern</span>
0777            meas_pat = [meas_pat; meas];
0778 
0779        <span class="keyword">end</span>     <span class="comment">% for each injection there are actually only 13-16 measurements</span>
0780        stimulations(i).meas_pattern = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(meas_pat);
0781    <span class="keyword">end</span>
0782 
0783 <a name="_sub18" href="#_subfunctions" class="code">function [cur_data,no_cur_data] = UCT_calibration_file( fname );</a>
0784    fid = fopen(fname, <span class="string">'rb'</span>);
0785    mag_num = fread(fid, 1, <span class="string">'int32'</span>);
0786    version = fread(fid, 1, <span class="string">'int32'</span>);
0787 <span class="comment">%  comments = fread(fid, 2048, 'char'); MATLAB CHANGED CHAR to 2 bytes</span>
0788    comments = fread(fid, 2048, <span class="string">'uint8'</span>);
0789    comments = char(comments');
0790    no_of_layers = fread(fid, 1, <span class="string">'int32'</span>);
0791    uppa_dac = fread(fid, 1, <span class="string">'float64'</span>);
0792    lowa_dac = fread(fid, 1, <span class="string">'float64'</span>);
0793    raw_frame_size = fread(fid, 1, <span class="string">'int32'</span>);
0794 
0795    no_cur_data = [];
0796    cur_data = [];
0797 
0798    <span class="keyword">for</span> i=1:no_of_layers
0799        no_cur_data = [no_cur_data;fread(fid, raw_frame_size, <span class="string">'float64'</span>)];
0800        cur_data = [cur_data;fread(fid, raw_frame_size, <span class="string">'float64'</span>)];
0801    <span class="keyword">end</span>
0802    fclose(fid);
0803 
0804 <span class="comment">%  no_cur_data = UCT_ShuffleData( no_cur_data);</span>
0805 <span class="comment">%  cur_data =    UCT_ShuffleData( cur_data);</span>
0806 
0807 <a name="_sub19" href="#_subfunctions" class="code">function [v_raw] = UCT_LoadDataFrame(infilename)</a>
0808 <span class="comment">% [v_raw] = LoadDataFrame(infilename)</span>
0809 <span class="comment">%</span>
0810 <span class="comment">% Loads the data from the tomography file</span>
0811 <span class="comment">%</span>
0812 <span class="comment">% (c) Tim Long</span>
0813 <span class="comment">% 21 January 2005</span>
0814 <span class="comment">% University of Cape Town</span>
0815 
0816 
0817 <span class="comment">% Open the file</span>
0818 fid = fopen(infilename, <span class="string">'rb'</span>);
0819 
0820 <span class="keyword">if</span> fid == -1
0821       errordlg(<span class="string">'File not found'</span>,<span class="string">'ERROR'</span>)  
0822       <span class="keyword">return</span>;
0823 <span class="keyword">end</span>
0824 
0825 <span class="comment">%%% new file changes</span>
0826 magic_number = fread(fid, 1, <span class="string">'uint32'</span>);
0827 
0828 <span class="keyword">if</span> magic_number ~= 2290649224
0829    disp(<span class="string">'UCT File: wrong file type'</span>); 
0830 <span class="keyword">end</span>
0831 version = fread(fid, 1, <span class="string">'uint32'</span>);
0832 foffset = fread(fid, 1, <span class="string">'uint32'</span>);
0833 no_of_layers = fread(fid, 1, <span class="string">'uint32'</span>);
0834 frame_size = fread(fid, 1, <span class="string">'uint32'</span>);
0835 fseek(fid, foffset-8, <span class="string">'cof'</span>);
0836 
0837 <span class="comment">%%% end of new file changes</span>
0838 <span class="comment">%%% old file stuff</span>
0839 <span class="comment">% no_of_layers = fread(fid, 1, 'uint32');</span>
0840 <span class="comment">% frame_size = fread(fid, 1, 'uint32');</span>
0841 
0842 frame_no = fread(fid, 1, <span class="string">'uint32'</span>);
0843 
0844 v_raw = [];
0845 <span class="keyword">while</span> feof(fid)==0
0846     v_raw = [v_raw, fread(fid, frame_size*no_of_layers, <span class="string">'float64'</span>)];
0847     frame_no = fread(fid, 1, <span class="string">'uint32'</span>);
0848 <span class="keyword">end</span>
0849 
0850 fclose(fid);
0851 <span class="comment">% UCT_ShuffleData??</span>
0852 
0853 <span class="comment">% Read data from the file format develped by Pascal</span>
0854 <span class="comment">% Gaggero at CSEM Landquart in Switzerland.</span>
0855 <a name="_sub20" href="#_subfunctions" class="code">function [vv] = landquart1_readdata( fname );</a>
0856    FrameSize = 1024;
0857 
0858    enableCounter=1;
0859    counter=0;
0860 
0861    fid=fopen(fname);
0862 
0863    codec=fread(fid,1,<span class="string">'int'</span>); <span class="comment">%read codec</span>
0864    <span class="keyword">if</span> codec~=1; error(<span class="string">'Codec unexpected value'</span>); <span class="keyword">end</span>
0865 
0866    nbFileInHeader=fread(fid,1,<span class="string">'int'</span>); <span class="comment">%read codec</span>
0867    
0868    <span class="keyword">for</span> i=1:nbFileInHeader
0869        lenghtFile = fread(fid,1,<span class="string">'int64'</span>); 
0870        <a href="#_sub9" class="code" title="subfunction jnk">jnk</a>= fread(fid,lenghtFile,<span class="string">'int8'</span>);<span class="comment">% discard the file</span>
0871    <span class="keyword">end</span>
0872    
0873    
0874    vv= []; 
0875    <span class="keyword">while</span> 1; 
0876        type=fread(fid,1,<span class="string">'int'</span>); <span class="comment">%check if not End of file</span>
0877        <span class="keyword">if</span> type == -1; <span class="keyword">break</span> ; <span class="keyword">end</span>
0878        
0879        nel= fread(fid,1,<span class="string">'int'</span>);
0880        sz= fread(fid,1,<span class="string">'int'</span>);
0881        iq=fread(fid,[2,sz/8],<span class="string">'int'</span>)';
0882 
0883        vv = [vv, iq*[1;1j]]; <span class="comment">%I+ 1j*Q vectors</span>
0884        
0885        <span class="keyword">for</span> j=1:nel-1
0886            sz= fread(fid,1,<span class="string">'int'</span>);
0887            <a href="#_sub9" class="code" title="subfunction jnk">jnk</a> = fread(fid,sz/4,<span class="string">'int'</span>);
0888        <span class="keyword">end</span>
0889        
0890    <span class="keyword">end</span>
0891    
0892 <span class="comment">% Read data from the file format develped by Swisstom, Landquart, Switzerland.</span>
0893 <a name="_sub21" href="#_subfunctions" class="code">function [vv, elecImps, tStampsAbs, tStampsRel] = landquart2_readdata( fname )</a>
0894    [fid msg]= fopen(fname,<span class="string">'r'</span>,<span class="string">'ieee-be'</span>,<span class="string">'UTF-8'</span>);
0895    <span class="keyword">try</span>
0896       format_version = fread(fid,1,<span class="string">'int32'</span>,<span class="string">'ieee-be'</span>);
0897       <span class="keyword">if</span> format_version ~= 3
0898          error(<span class="string">'unsupported file format version'</span>);
0899       <span class="keyword">else</span>
0900          <span class="comment">% get expected number of frames and preallocate variables</span>
0901          fseek(fid,16,<span class="string">'cof'</span>);
0902          nFrames = fread(fid, 1, <span class="string">'int32'</span>, <span class="string">'ieee-be'</span>);
0903          tStampsAbs = nan(1, nFrames);
0904          tStampsRel = nan(1, nFrames);
0905          viPayload = nan(64, nFrames);
0906          iqPayload = nan(2048, nFrames);
0907          
0908          <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Reading EIT frame'</span>, 0, nFrames);
0909 
0910          header_size = 2264; 
0911          fseek(fid,header_size + 8,<span class="string">'bof'</span>);
0912          
0913          <span class="comment">%%% get frame size and length of payload at end of frame</span>
0914          frame_length = fread(fid, 1, <span class="string">'int32'</span>, <span class="string">'ieee-be'</span>) + 12;
0915          <span class="comment">%%% move back to start of 1. frame</span>
0916          fseek(fid,header_size,<span class="string">'bof'</span>);
0917          
0918          <span class="comment">%%% Read frames</span>
0919          i = 1;
0920          <span class="keyword">while</span> fseek(fid, 1,<span class="string">'cof'</span>) ~= -1
0921             <span class="keyword">if</span> mod(i, 100) == 0
0922                 <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(i, nFrames);
0923             <span class="keyword">end</span>
0924             
0925             fseek(fid, -1,<span class="string">'cof'</span>);
0926             <span class="comment">% read absolute timestamp (milliseconds resolution)</span>
0927             tStampsAbs(i) = fread(fid,1,<span class="string">'int64'</span>,<span class="string">'ieee-be'</span>);
0928             pl = fread(fid,1,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);    <span class="comment">% payload length (i.e. frame length)</span>
0929             frame_header = fread(fid,15,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>); 
0930             <span class="comment">% read relative timestamp (microseconds resolution)</span>
0931             tStampsRel(i) = frame_header(5);    
0932             
0933             <span class="comment">% drop some unintersting parts</span>
0934             fseek(fid,12, <span class="string">'cof'</span>);
0935             
0936             <span class="comment">% get electrode impedance measurement</span>
0937             viPayload(:,i) = fread(fid,64,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
0938             <span class="comment">% get effective payload (voltage measurements)</span>
0939             iqPayload(:,i) = fread(fid,2048,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
0940             fseek(fid,header_size + i*frame_length,<span class="string">'bof'</span>);
0941             i = i +1;
0942          <span class="keyword">end</span>
0943 
0944       <span class="keyword">end</span>
0945    <span class="keyword">catch</span> err
0946       fclose(fid);
0947       rethrow(err);
0948    <span class="keyword">end</span>
0949    fclose(fid);
0950    
0951    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(inf);
0952    
0953    i = i-1;
0954    <span class="keyword">if</span> i ~= nFrames       
0955       <span class="comment">% remove data which were preallocated but not read</span>
0956       <span class="keyword">if</span> i &lt; nFrames       
0957          tStampsAbs(i+1:end) = [];
0958          tStampsRel(i+1:end) = [];
0959          viPayload(:,i+1:end) = [];
0960          iqPayload(:,i+1:end) = [];
0961       <span class="keyword">end</span>
0962       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'&quot;%s&quot;: expected %.0f frames but read %.0f'</span>,fname, nFrames, i ,3);
0963    <span class="keyword">end</span>
0964    
0965    <span class="comment">% convert into matlab date format, e.g. read via datestr(tStampAbs(1))</span>
0966    tStampsAbs = tStampsAbs/(24*3600*1E3) + datenum(1970, 1, 1, 1, 0, 0);
0967    <span class="comment">% strictly speaking we would need to correct for DST, but as this is only</span>
0968    <span class="comment">% supported by ML R2014b or higher we avoid it to be backwards compatible</span>
0969 <span class="comment">%    tStampsAbs = tStampsAbs + isdst(datetime(datevec(tStampsAbs(1)), 'TimeZone', 'local'))/24;   % add one hour if DST</span>
0970    
0971    <span class="comment">% this is just a simple guess</span>
0972    amplitudeFactor = 2.048 / (2^20 * 360 * 1000);
0973    vv = amplitudeFactor * (iqPayload(1:2:<span class="keyword">end</span>,:) + 1i*iqPayload(2:2:<span class="keyword">end</span>,:));
0974    
0975    elecImps = viPayload(1:2:<span class="keyword">end</span>,:) + 1i*viPayload(2:2:<span class="keyword">end</span>,:);
0976 
0977 <span class="comment">% Read data from the file format develped by Swisstom, Landquart, Switzerland.</span>
0978 <a name="_sub22" href="#_subfunctions" class="code">function [vv, evtlist, elecImps, tStampsAbs, tStampsRel, n_elec, amp, skip, extra, patPosition] = landquart4_readdata( fname )</a>
0979    evtlist = [];
0980    [fid msg]= fopen(fname,<span class="string">'r'</span>,<span class="string">'ieee-le'</span>,<span class="string">'UTF-8'</span>);
0981    <span class="keyword">try</span>
0982       format_version = fread(fid,1,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
0983       <span class="keyword">if</span> format_version ~= 4
0984          error(<span class="string">'unsupported file format version'</span>);
0985       <span class="keyword">else</span>          
0986          header_size = fread(fid,1,<span class="string">'int32'</span>, <span class="string">'ieee-le'</span>);   
0987          eit_frame_offset = 328; <span class="comment">% 60 + 12 + 256 = 328</span>
0988          iq_payload = 2048;
0989          vi_payload = 64;
0990          pat_position = 3; 
0991          
0992          <span class="comment">% get expected number of frames and preallocate variables</span>
0993          fseek(fid,16,<span class="string">'cof'</span>);
0994          nFrames = fread(fid, 1, <span class="string">'int32'</span>, <span class="string">'ieee-le'</span>);
0995          tStampsAbs = nan(1, nFrames);
0996          tStampsRel = nan(1, nFrames);
0997          viPayload = nan(vi_payload, nFrames);
0998          iqPayload = nan(iq_payload, nFrames);
0999          patPosition = nan(pat_position, nFrames);
1000 
1001          <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Reading EIT frame'</span>, 0, nFrames);
1002          fseek(fid,424,<span class="string">'bof'</span>);
1003          x = fread(fid, 2, <span class="string">'int16'</span>, <span class="string">'ieee-le'</span>);
1004          extra.filename = fread(fid,[1,100], <span class="string">'int16=&gt;char'</span>, <span class="string">'ieee-le'</span>);
1005          extra.conditions = fread(fid,[1,300], <span class="string">'int16=&gt;char'</span>, <span class="string">'ieee-le'</span>);
1006          extra.comments = fread(fid,[1,600], <span class="string">'int16=&gt;char'</span>, <span class="string">'ieee-le'</span>);
1007 
1008          <span class="comment">%fseek(fid,2428,'bof');</span>
1009          extra.frame_rate = fread(fid, 1, <span class="string">'float'</span>, <span class="string">'ieee-le'</span>);
1010          amp = fread(fid, 1, <span class="string">'float'</span>, <span class="string">'ieee-le'</span>);
1011          extra.freq = fread(fid, 1, <span class="string">'float'</span>, <span class="string">'ieee-le'</span>);
1012          extra.settle = fread(fid, 1, <span class="string">'float'</span>, <span class="string">'ieee-le'</span>);
1013 
1014          <span class="comment">%fseek(fid,2444,'bof');</span>
1015          skip = fread(fid, 1, <span class="string">'int16'</span>, <span class="string">'ieee-le'</span>);
1016          x = fread(fid, 1, <span class="string">'int16'</span>, <span class="string">'ieee-le'</span>);
1017          n_elec = fread(fid, 1, <span class="string">'int16'</span>, <span class="string">'ieee-le'</span>);
1018 
1019          fseek(fid,header_size,<span class="string">'bof'</span>);
1020          
1021          <span class="comment">%%% Read frames</span>
1022          i = 1;
1023          evti = 1;
1024          <span class="keyword">while</span> fseek(fid, 1,<span class="string">'cof'</span>) ~= -1
1025             <span class="keyword">if</span> mod(i, 100) == 0
1026                 <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(i, nFrames);
1027             <span class="keyword">end</span>
1028             
1029             fseek(fid, -1,<span class="string">'cof'</span>);
1030             <span class="comment">% drop frame header and some payload:</span>
1031             <span class="comment">% read absolute timestamp (milliseconds resolution)</span>
1032             tStampsAbs(i) = fread(fid,1,<span class="string">'int64'</span>,<span class="string">'ieee-le'</span>); 
1033             ft = fread(fid,1,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>); 
1034             pl = fread(fid,1,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
1035             <span class="keyword">if</span> ft == 1
1036                <span class="comment">% event</span>
1037                evtlist(evti).timestamp = tStampsAbs(i) ;
1038                evtlist(evti).frame = i ;
1039                evti = evti + 1;
1040                <span class="keyword">if</span> pl &gt; 0
1041                   evtlist(evti).eventId = fread(fid, 1, <span class="string">'int32'</span>, <span class="string">'ieee-le'</span>);
1042                 <span class="keyword">end</span>
1043             <span class="keyword">elseif</span> ft == 0
1044                 frame_header = fread(fid,15,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>); 
1045                 <span class="comment">% read relative timestamp (microseconds resolution)</span>
1046                 tStampsRel(i) = frame_header(5);   
1047                
1048                 <span class="comment">% get patient position</span>
1049                 patPosition(:, i) = fread(fid,pat_position,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);                
1050                 <span class="comment">% get electrode impedance measurement</span>
1051                 viPayload(:,i) = fread(fid,vi_payload,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
1052                 <span class="comment">% get effective payload (voltage measurements)</span>
1053                 iqPayload(:,i) = fread(fid,iq_payload,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
1054                 fseek(fid,pl-4*iq_payload-eit_frame_offset,<span class="string">'cof'</span>);
1055                 i = i+1;
1056             <span class="keyword">elseif</span> pl &gt; 0
1057                fseek(fid,pl,<span class="string">'cof'</span>); 
1058             <span class="keyword">else</span>
1059                <span class="comment">% nothing to do</span>
1060             <span class="keyword">end</span>
1061          <span class="keyword">end</span>         
1062       <span class="keyword">end</span>
1063    <span class="keyword">catch</span> err
1064       fclose(fid);
1065       rethrow(err);
1066    <span class="keyword">end</span>
1067    fclose(fid);
1068    
1069    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(inf);
1070    
1071    i = i-1;
1072    <span class="keyword">if</span> i ~= nFrames       
1073       <span class="comment">% remove data which were preallocated but not read</span>
1074       <span class="keyword">if</span> i &lt; nFrames       
1075          tStampsAbs(i+1:end) = [];
1076          tStampsRel(i+1:end) = [];
1077          viPayload(:,i+1:end) = [];
1078          iqPayload(:,i+1:end) = [];
1079          patPosition(:,i+1:end) = [];
1080       <span class="keyword">end</span>
1081       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'&quot;%s&quot;: expected %.0f frames but read %.0f'</span>,fname, nFrames, i ,3);
1082    <span class="keyword">end</span>
1083    
1084    <span class="comment">% convert into matlab date format, e.g. read via datestr(tStampAbs(1))</span>
1085    tStampsAbs = tStampsAbs/(24*3600*1E3) + datenum(1, 1, 1, 0, 0, 0);
1086    <span class="comment">% strictly speaking we would need to correct for DST, but as this is only</span>
1087    <span class="comment">% supported by ML R2014b or higher we avoid it to be backwards compatible</span>
1088 <span class="comment">%    tStampsAbs = tStampsAbs + isdst(datetime(datevec(tStampsAbs(1)), 'TimeZone', 'local'))/24;   % add one hour if DST</span>
1089 
1090    <span class="comment">% this is just a simple guess</span>
1091    amplitudeFactor = 2.048 / (2^20 * 360 * 1000);
1092    vv = amplitudeFactor * (iqPayload(1:2:<span class="keyword">end</span>,:) + 1i*iqPayload(2:2:<span class="keyword">end</span>,:));
1093    
1094    <span class="comment">%% elecImps depends on a factor which varies with the SBC version,</span>
1095    <span class="comment">%%   however the following value is close for most versions</span>
1096    impedanceFactor =  2.048 / (2^12 * 0.173 * 0.003) / 2^15; <span class="comment">% = 0.9633 / 2^15;</span>
1097    elecImps = impedanceFactor * (viPayload(1:2:<span class="keyword">end</span>,:) + 1i*viPayload(2:2:<span class="keyword">end</span>,:));
1098 
1099 <a name="_sub23" href="#_subfunctions" class="code">function [vv] = landquart4pre_readdata( fname )</a>
1100    [fid msg]= fopen(fname,<span class="string">'r'</span>,<span class="string">'ieee-le'</span>,<span class="string">'UTF-8'</span>);
1101    <span class="keyword">try</span>
1102       format_version = fread(fid,1,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
1103       <span class="keyword">if</span> format_version ~= 4
1104          error(<span class="string">'unsupported file format version'</span>);
1105       <span class="keyword">else</span>
1106          header_size = fread(fid,1,<span class="string">'int32'</span>, <span class="string">'ieee-le'</span>); 
1107          
1108          fseek(fid,header_size + 12,<span class="string">'bof'</span>);
1109          <span class="comment">%%% get frame size and length of payload at end of frame</span>
1110          frame_length = fread(fid, 1, <span class="string">'int32'</span>, <span class="string">'ieee-le'</span>) + 16;
1111          <span class="comment">%%% move back to start of 1. frame</span>
1112          fseek(fid,header_size,<span class="string">'bof'</span>);
1113          
1114          <span class="comment">%%% Read frames</span>
1115          i = 1;
1116          <span class="keyword">while</span> fseek(fid, 1,<span class="string">'cof'</span>) ~= -1
1117             fseek(fid, -1,<span class="string">'cof'</span>);
1118             <span class="comment">% drop frame header and some payload:</span>
1119             <span class="comment">% (16 + 60) + 12 + 256 = 344</span>
1120             fseek(fid,344, <span class="string">'cof'</span>);
1121             iqPayload(:,i) = fread(fid,2048,<span class="string">'int32'</span>,<span class="string">'ieee-le'</span>);
1122             fseek(fid,header_size + i*frame_length,<span class="string">'bof'</span>);
1123             i = i +1;
1124          <span class="keyword">end</span>
1125 
1126       <span class="keyword">end</span>
1127    <span class="keyword">catch</span> err
1128       fclose(fid);
1129       rethrow(err);
1130    <span class="keyword">end</span>
1131    fclose(fid);
1132 
1133    <span class="comment">% this is just a simple guess</span>
1134    amplitudeFactor = 2.048 / (2^20 * 360 * 1000);
1135    vv = amplitudeFactor * (iqPayload(1:2:<span class="keyword">end</span>,:) + 1i*iqPayload(2:2:<span class="keyword">end</span>,:));
1136    
1137 <span class="comment">%  Output: [encodepage] = eidors_readdata( path,'DIX_encode');</span>
1138 <span class="comment">%   where path= '/path/to/Criptografa_New.dll' (provided with system)</span>
1139 <a name="_sub24" href="#_subfunctions" class="code">function [vv] = dixtal_read_codepage( fname );</a>
1140    <span class="comment">%Fname must be the Criptografa_New dll</span>
1141    fid = fopen(fname,<span class="string">'rb'</span>);
1142    b1234= fread(fid, [1,4], <span class="string">'uint8'</span>);
1143    <span class="keyword">if</span> b1234~= [77, 90, 144, 0];
1144       error(<span class="string">'This does not appear to be the correct Dll'</span>);
1145    <span class="keyword">end</span>
1146    fseek(fid, hex2dec(<span class="string">'e00'</span>), <span class="string">'bof'</span>);
1147    encodepage1 = fread(fid, hex2dec(<span class="string">'1000'</span>), <span class="string">'uint8'</span>);
1148    fclose(fid);
1149    encodepage1 = flipud(reshape(encodepage1,4,[]));
1150    vv = encodepage1(:);
1151 
1152 <span class="comment">%        format = 'DIXTAL'</span>
1153 <span class="comment">%           - output: [vv] = eidors_readdata( fname, 'DIXTAL', encodepage );</span>
1154 <a name="_sub25" href="#_subfunctions" class="code">function [vv] = dixtal_read_data( file_name, frame_range, encodepage1 );</a>
1155 
1156    <span class="comment">% Get encodepage from the file</span>
1157    fid=fopen(file_name,<span class="string">'rb'</span>);
1158    n1 = fgetl(fid);
1159    n2 = fgetl(fid);
1160    n3 = fgetl(fid); 
1161    nframes = str2num( n3 );
1162    
1163    fseek(fid, hex2dec(<span class="string">'800'</span>), <span class="string">'bof'</span>);
1164    encodepage2 = fread(fid, hex2dec(<span class="string">'1000'</span>), <span class="string">'uint8'</span>);
1165    fclose(fid);
1166 
1167    encodepage = bitxor(encodepage1, encodepage2);
1168 
1169    <span class="comment">% Read the file</span>
1170    dplen = hex2dec(<span class="string">'1090'</span>);
1171    start = hex2dec(<span class="string">'2800'</span>);
1172    fid=fopen(file_name,<span class="string">'rb'</span>);
1173    <span class="keyword">if</span> isempty(frame_range)
1174       frame_range = 0:nframes;
1175    <span class="keyword">else</span>
1176       frame_range = frame_range - 1;
1177       frame_range(frame_range&gt;nframes) = [];
1178    <span class="keyword">end</span>      
1179    vv= zeros(dplen/4, length(frame_range));
1180    k= 1;
1181    <span class="keyword">for</span> i = frame_range
1182       status= fseek(fid, start + i*dplen, <span class="string">'bof'</span>);
1183       <span class="keyword">if</span> status~=0; <span class="keyword">break</span>; <span class="keyword">end</span>
1184       datapage = fread(fid, dplen, <span class="string">'uint8'</span>);
1185       <span class="keyword">if</span> length(datapage)== 0; 
1186          vv= vv(:,1:k-1); <span class="keyword">break</span>; <span class="comment">% frame number inside file is wrong</span>
1187       <span class="keyword">end</span>
1188       vv(:,k) = <a href="#_sub26" class="code" title="subfunction  data = proc_dixtal_data( b, encodepage );">proc_dixtal_data</a>( datapage, encodepage );
1189       k=k+1;
1190    <span class="keyword">end</span>
1191    fclose(fid);
1192 
1193 
1194 <a name="_sub26" href="#_subfunctions" class="code">function  data = proc_dixtal_data( b, encodepage );</a>
1195 
1196    cryptolen = 1024*4;
1197    b(1:cryptolen) = bitxor(b(1:cryptolen), encodepage);
1198 
1199    b1 = b(1:4:<span class="keyword">end</span>,:); <span class="comment">%b1 = bitand(b1,127);</span>
1200    b2 = b(2:4:<span class="keyword">end</span>,:);
1201    b3 = b(3:4:<span class="keyword">end</span>,:);
1202    b4 = b(4:4:<span class="keyword">end</span>,:);
1203    bb  = [b1,b2,b3,b4]*(256.^[3;2;1;0]);
1204 
1205    sgnbit = bitand( bb,  2^31);
1206    sgnbit = +1*(sgnbit == 0) - 1*(sgnbit == 2^31);
1207 
1208    expbit = bitand( bb, 255*2^23 ) /2^23; 
1209    expbit = 2.^(expbit - 127);
1210 
1211    fracbt = bitand( bb, 2^23-1)/2^23 + 1;
1212    data = sgnbit .* expbit .* fracbt;
1213 
1214 <a name="_sub27" href="#_subfunctions" class="code">function [fr] = read_draeger_header( filename );</a>
1215 <span class="comment">%READ_DRAEGER_HEADER   Opens and reads the header portion of the Draeger .eit</span>
1216 <span class="comment">%file. Current parameter returned is frame rate.</span>
1217 <span class="comment">%</span>
1218 <span class="comment">% function [fr,s] = ReadDraegerHeader(filename)</span>
1219 <span class="comment">% fr        double      scalar      frame rate in hertz</span>
1220 
1221 <span class="comment">% Determine file version</span>
1222 K0 = 2048;   <span class="comment">% bytes to read in char class</span>
1223 K1=<span class="string">'Framerate [Hz]:'</span>; <span class="comment">% Draeger frame rate line in header</span>
1224 K2=15;                <span class="comment">% Length of K1 string</span>
1225 K3=13;                <span class="comment">% Following F1 Field for delimiter (look for ^M)</span>
1226 
1227 <span class="comment">% Open file for reading in little-endian form</span>
1228 fid = fopen(filename,<span class="string">'r'</span>,<span class="string">'l'</span>);
1229 <span class="keyword">if</span> fid == -1
1230     error(<span class="string">'Error read_draeger_header: can''t open file'</span>);
1231 <span class="keyword">end</span>
1232 header = fread(fid,K0,<span class="string">'*char'</span>)';
1233 index = strfind(header,K1);
1234 <span class="keyword">if</span> ~isempty(index)
1235     [tok,rem]= strtok(header(index+K2:end),K3);
1236     fr = str2num(tok); 
1237 <span class="keyword">else</span>
1238     error(<span class="string">'Error read_draeger_header: frame rate unspecified'</span>);
1239 <span class="keyword">end</span>
1240 
1241 <span class="keyword">if</span> isempty(fr)
1242     error(<span class="string">'Error read_draeger_header: Frame rate could not be read'</span>);
1243 <span class="keyword">end</span>
1244 
1245 fclose(fid);
1246 
1247 
1248 <a name="_sub28" href="#_subfunctions" class="code">function [vd, tstamp, event, signals, counter] = read_draeger_file(filename)</a>
1249 <span class="comment">%READDRAEGERFILE   Opens and reads a Draeger .eit file. Returns an array</span>
1250 <span class="comment">%containing the voltage data arranged per frame.</span>
1251 <span class="comment">%</span>
1252 <span class="comment">% Input:</span>
1253 <span class="comment">% filename  char        1xN</span>
1254 <span class="comment">%</span>
1255 <span class="comment">% Output:</span>
1256 <span class="comment">% vd        double      MxN         M = volt measurements per frame (mV)</span>
1257 <span class="comment">%                                   N = number of frames</span>
1258 
1259 
1260    ff = dir(filename);
1261    filelen = ff.bytes;
1262 
1263    <span class="comment">% Open file for reading in little-endian form</span>
1264    fid = fopen(filename,<span class="string">'r'</span>,<span class="string">'l'</span>);
1265    <span class="keyword">if</span> fid == -1
1266        error(<span class="string">'Error read_draeger_file: file could not be opened'</span>);
1267    <span class="keyword">end</span>
1268 
1269    <span class="comment">% Determine file version</span>
1270    K0 = 128;   <span class="comment">% bytes to read in char class</span>
1271 
1272    header = fread(fid,K0,<span class="string">'*char'</span>)';
1273 <span class="keyword">if</span> 0 <span class="comment">% THis analysis doesn't seem useful</span>
1274    <span class="keyword">if</span> ~isempty(strfind(header,<span class="string">'V3.2'</span>))
1275        version = <span class="string">'3.2'</span>;
1276    <span class="keyword">elseif</span> ~isempty(strfind(header,<span class="string">'V4.01'</span>))
1277        version = <span class="string">'4.01'</span>; 
1278    <span class="keyword">elseif</span> ~isempty(strfind(header,<span class="string">'V1.10'</span>)) <span class="comment">% 2014!!</span>
1279        version = <span class="string">'1.10'</span>; 
1280    <span class="keyword">else</span>
1281        error(<span class="string">'Error read_draeger_file: unknown file version'</span>);
1282    <span class="keyword">end</span>
1283 <span class="keyword">end</span>
1284 
1285    <span class="comment">% Read Format version</span>
1286    fseek(fid,0,-1); <span class="comment">% beginning of file</span>
1287    hdr = fread(fid, 8, <span class="string">'uint8'</span>);
1288    offset1 =  (256.^(0:3))*hdr(5:8); <span class="comment">% &quot;good&quot; data starts at offset #2</span>
1289    <span class="keyword">switch</span> sprintf(<span class="string">'%02X-'</span>,header(1:4));
1290       <span class="keyword">case</span> <span class="string">'1F-00-00-00-'</span>;
1291          type=<span class="string">'Draeger v31'</span>;  SPC = 4112;
1292       <span class="keyword">case</span> <span class="string">'20-00-00-00-'</span>;
1293          type=<span class="string">'Draeger v32'</span>;  SPC = 5200;
1294       <span class="keyword">case</span> <span class="string">'33-00-00-00-'</span>;
1295          type=<span class="string">'Draeger v51'</span>;  SPC = 5495;
1296       <span class="keyword">otherwise</span>;
1297          error(<span class="string">'File &quot;%s&quot; is format version %d, which we don''t know how to read'</span>, <span class="keyword">...</span>
1298                hdr(1))
1299    <span class="keyword">end</span>
1300 
1301    len = floor( (filelen-offset1)/SPC );
1302    vd= zeros(600,len);
1303    tstamp = zeros(1, len, <span class="string">'double'</span>); 
1304    counter = zeros(1, len, <span class="string">'uint16'</span>);     
1305    event = repmat(char(0), 30, len);
1306    rawsigs = zeros(67, len, <span class="string">'single'</span>);
1307    ss= offset1 + (0:len)*SPC;
1308 
1309    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Reading EIT frame'</span>, 0, length(ss)-1);
1310    <span class="keyword">for</span> k= 1:length(ss)-1;
1311        <span class="keyword">if</span> mod(k, 100) == 0
1312            <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(k, length(ss)-1);
1313        <span class="keyword">end</span>
1314        <span class="comment">% for newest Dräger files: one frame has 5495 bytes</span>
1315        <span class="comment">% - [0001-0008] 8 bytes of whatever in first frame then zero</span>
1316        <span class="comment">% - [0009-5168] 5160 bytes of signals: as 645 float64 (double)</span>
1317        <span class="comment">% - [5169-5436] 268 bytes of &quot;medibus&quot; signals: as 67 float32 (single)</span>
1318        <span class="comment">% - [5437-5467] 30 bytes of &quot;event&quot; string: as 30 chars</span>
1319        <span class="comment">% - [5468-5491] ??? some bytes (mostly int16 and zeros) of we do not know what</span>
1320        <span class="comment">% - [5492-5493] 2 bytes of some counter signal which gets reset from time to time: as uint16</span>
1321        <span class="comment">% - [5494-5495] 2 bytes of zeros</span>
1322        
1323       <span class="keyword">if</span> fseek(fid,ss(k)+8,-1)&lt;0; <span class="keyword">break</span>; <span class="keyword">end</span>
1324       <span class="comment">% timestamp in number of days</span>
1325       tstamp(k) = fread(fid,1,<span class="string">'float64'</span>, 0, <span class="string">'ieee-le'</span>); 
1326       
1327       <span class="keyword">if</span> fseek(fid,ss(k)+16,-1)&lt;0; <span class="keyword">break</span>; <span class="keyword">end</span>
1328       vd(:,k)=fread(fid,600,<span class="string">'double'</span>, 0, <span class="string">'ieee-le'</span>);
1329       
1330       start = 16+600*8;
1331       <span class="keyword">if</span> fseek(fid,ss(k)+start,-1)&lt;0; <span class="keyword">break</span>; <span class="keyword">end</span>
1332       gugus(:,k) = fread(fid, floor((5169-start)/8), <span class="string">'double'</span>, <span class="string">'ieee-le'</span>);
1333       
1334       <span class="keyword">if</span> fseek(fid,ss(k)+5169,-1)&lt;0; <span class="keyword">break</span>; <span class="keyword">end</span>
1335 <span class="comment">%       rawsigs(:,k) = fread(fid, 52, 'single', 'ieee-le');</span>
1336       rawsigs(:,k) = fread(fid, 67, <span class="string">'single'</span>, <span class="string">'ieee-le'</span>);
1337       
1338       <span class="keyword">if</span> fseek(fid,ss(k)+5437,-1)&lt;0; <span class="keyword">break</span>; <span class="keyword">end</span>
1339       event(:, k) = fread(fid, 30, <span class="string">'char'</span>, <span class="string">'ieee-le'</span>);
1340             
1341 <span class="comment">%       fseek(fid,ss(k)+5437+30,-1);</span>
1342 <span class="comment">%       dada(:,k) = fread(fid, floor(SPC-(5437+30)/8), 'double', 'ieee-le');</span>
1343 
1344       <span class="keyword">if</span> fseek(fid,ss(k)+5491,-1)&lt;0; <span class="keyword">break</span>; <span class="keyword">end</span>
1345       counter(k) = fread(fid, 1, <span class="string">'uint16'</span>, <span class="string">'ieee-le'</span>);      
1346    <span class="keyword">end</span>
1347    
1348    <span class="comment">% convert raw signals into a structure</span>
1349    <span class="comment">% WARNING: this list is far from correct or complete</span>
1350    <span class="comment">% TODO: verify and fix this!</span>
1351    SignalNames = {<span class="string">'RTD_Paw_mbar_01'</span>, <span class="string">'RTD_Paw_mbar_02'</span>, <span class="string">'RTD_Flow_L_min_03'</span>, <span class="string">'RTD_Flow_L_min_04'</span>, <span class="string">'RTD_Vol__mL_05'</span>, <span class="string">'RTD_Vol__mL_06'</span>, <span class="string">'unknown_07'</span>, <span class="string">'unknown_08'</span>, <span class="string">'unknown_09'</span>, <span class="string">'unknown_10'</span>, <span class="string">'unknown_11'</span>, <span class="string">'Tispon_sec_12'</span>, <span class="string">'Pmin_mbar_13'</span>, <span class="string">'P0_1_mbar_14'</span>, <span class="string">'Pmean_mbar_15'</span>, <span class="string">'unknown_16'</span>, <span class="string">'PEEP_mbar_17'</span>, <span class="string">'unknown_18'</span>, <span class="string">'unknown_19'</span>, <span class="string">'unknown_20'</span>, <span class="string">'unknown_21'</span>, <span class="string">'PIP_mbar_22'</span>, <span class="string">'unknown_23'</span>, <span class="string">'unknown_24'</span>, <span class="string">'unknown_25'</span>, <span class="string">'unknown_26'</span>, <span class="string">'VT_mL_27'</span>, <span class="string">'unknown_28'</span>, <span class="string">'unknown_29'</span>, <span class="string">'unknown_30'</span>, <span class="string">'unknown_31'</span>, <span class="string">'VT_mL_32'</span>, <span class="string">'VTispon_mL_33'</span>, <span class="string">'NIF_mbar_34'</span>, <span class="string">'MVleak_L_min_35'</span>, <span class="string">'unknown_36'</span>, <span class="string">'RRspon_1_min_37'</span>, <span class="string">'unknown_38'</span>, <span class="string">'MVspon_L_min_39'</span>, <span class="string">'unknown_40'</span>, <span class="string">'MVspon_L_min_41'</span>, <span class="string">'unknown_42'</span>, <span class="string">'RSB_1_LXMin_43'</span>, <span class="string">'RRspon_1_min_44'</span>, <span class="string">'unknown_45'</span>, <span class="string">'unknown_46'</span>, <span class="string">'unknown_47'</span>, <span class="string">'unknown_48'</span>, <span class="string">'unknown_49'</span>, <span class="string">'etCO2___50'</span>, <span class="string">'etCO2___51'</span>, <span class="string">'unknown_52'</span>, <span class="string">'unknown_53'</span>, <span class="string">'unknown_54'</span>, <span class="string">'unknown_55'</span>, <span class="string">'unknown_56'</span>, <span class="string">'unknown_57'</span>, <span class="string">'unknown_58'</span>, <span class="string">'unknown_59'</span>, <span class="string">'unknown_60'</span>, <span class="string">'unknown_61'</span>, <span class="string">'unknown_62'</span>, <span class="string">'unknown_63'</span>, <span class="string">'unknown_64'</span>, <span class="string">'unknown_65'</span>, <span class="string">'unknown_66'</span>, <span class="string">'unknown_67'</span>};
1352 <span class="comment">%    SignalNames = {'RTD_Paw_mbar_01', 'RTD_Paw_mbar_02', 'unknown_03', 'RTD_Flow_L_min_04', 'RTD_Vol__mL_05', 'RTD_Vol__mL_06', 'Cdyn_mL_mbar_07', 'unknown_08', 'unknown_09', 'R_mbar_L_s_10', 'unknown_11', 'unknown_12', 'unknown_13', 'unknown_14', 'unknown_15', 'unknown_16', 'unknown_17', 'unknown_18', 'unknown_19', 'unknown_20', 'unknown_21', 'unknown_22', 'unknown_23', 'unknown_24', 'unknown_25', 'unknown_26', 'unknown_27', 'unknown_28', 'unknown_29', 'unknown_30', 'unknown_31', 'VT_mL_32', 'unknown_33', 'unknown_34', 'MVleak_L_min_35', 'unknown_36', 'unknown_37', 'unknown_38', 'unknown_39', 'unknown_40', 'MV_L_min_41', 'unknown_42', 'unknown_43', 'RR_1_min_44', 'unknown_45', 'unknown_46', 'unknown_47', 'unknown_48', 'unknown_49', 'etCO2___50', 'etCO2_kPa_51', 'etCO2_mmHg_52', 'unknown_53', 'unknown_54', 'unknown_55', 'unknown_56', 'unknown_57', 'unknown_58', 'unknown_59', 'unknown_60', 'unknown_61', 'unknown_62', 'unknown_63', 'unknown_64', 'unknown_65', 'unknown_66', 'unknown_67'};</span>
1353     <span class="keyword">for</span> iS = 1 : size(rawsigs,1) 
1354 <span class="comment">%         signals.(['sig_',num2str(iS)]) = rawsigs(iS,:);</span>
1355         SigTmp = rawsigs(iS,:);
1356         <span class="comment">% set invalid values to NAN (on time signals &lt; -1E38, others -1000)</span>
1357         SigTmp((SigTmp == -1000) | (SigTmp &lt; -1E38)) = nan;
1358         signals.(SignalNames{iS}) = SigTmp;
1359     <span class="keyword">end</span>
1360    
1361    <span class="comment">% End of function</span>
1362    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(inf);
1363    fclose(fid);
1364 
1365 <a name="_sub29" href="#_subfunctions" class="code">function do_unit_test</a>
1366    <span class="comment">% LQ2 test</span>
1367    pth = <a href="get_contrib_data.html" class="code" title="function p = get_contrib_data( contrib , file )">get_contrib_data</a>(<span class="string">'human-ventilation-2014'</span>,<span class="string">'human-ventilation-2014.eit'</span>); 
1368    [dd,auxdata,stim]= <a href="eidors_readdata.html" class="code" title="function [vv, auxdata, stim]= eidors_readdata( fname, format, frame_range, extra )">eidors_readdata</a>(pth);
1369    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'LQ2'</span>,dd(100,100), -8.820502983940973e-04 - 8.022670735677084e-04i,1e-16);
1370    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'LQ2:elecZ'</span>, auxdata.elec_impedance(3), -6.883231000000000e+06 - 1.805360000000000e+05i,1e-10);
1371    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'LQ2:t_rel'</span>, auxdata.t_rel(2), 38442185);</pre></div>
<hr><address>Generated on Fri 30-Dec-2022 20:46:51 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>